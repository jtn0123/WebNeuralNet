from pathlib import Path

html_v3 = r"""<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>CartPole V3 (Mobile Optimized)</title>
  <style>
    :root { --bg:#121212; --panel:#1e1e1e; --acc:#00bcd4; --text:#eee; --err:#ff5252; --muted:#888; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg); color:var(--text);
      margin:0; padding:8px; padding-bottom:calc(8px + env(safe-area-inset-bottom));
      display:flex; flex-direction:column; height:100vh; box-sizing:border-box;
      overflow:hidden; touch-action:manipulation;
    }
    h1{ margin:0 0 6px 0; font-size:1.15rem; color:var(--acc); text-align:center; }
    .layout{ display:flex; flex-direction:column; gap:8px; flex:1; min-height:0; }
    .box{
      background:var(--panel); border-radius:6px; padding:8px; display:flex; flex-direction:column;
      box-shadow:0 2px 4px rgba(0,0,0,0.4); min-height:0;
    }
    .stats{
      display:grid; grid-template-columns:repeat(4,1fr); gap:4px; font-size:0.75rem; text-align:center; margin-bottom:4px;
    }
    .stat-val{ font-size:1.1rem; font-weight:700; color:var(--acc); }
    .stat-label{ color:var(--muted); }

    .vis-container{ flex:2; min-height:240px; gap:6px; }
    #cvs{ flex:1; width:100%; height:100%; background:#000; border-radius:4px; display:block; }
    #net{ width:100%; height:90px; background:#161616; border-radius:4px; }

    .controls-header{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;
      font-size:0.85rem; color:var(--muted);
    }
    .controls-toggle{
      border:none; border-radius:4px; padding:4px 8px; background:#333; color:#fff; font-weight:700; cursor:pointer;
    }
    .controls-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:0.8rem;
    }
    .ctrl{ display:flex; flex-direction:column; gap:4px; }
    .ctrl label{ display:flex; justify-content:space-between; color:#bbb; }
    .ctrl input[type="range"]{ width:100%; }
    .ctrl select{ width:100%; padding:6px; border-radius:4px; background:#0f0f0f; color:#fff; border:1px solid #333; }

    #logs{
      background:#000; color:#0f0; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:10px; padding:6px; height:90px; border-radius:4px; border:1px solid #333;
      overflow-y:auto; white-space:pre-wrap; resize:none;
    }
    .btn-group{
      display:flex; gap:8px; margin-top:6px; position:sticky; bottom:0; background:var(--panel); padding-top:4px;
    }
    button{
      flex:1; padding:12px; border:none; border-radius:4px; font-weight:700; font-size:1rem; cursor:pointer;
      background:var(--acc); color:#000;
    }
    button.secondary{ background:#444; color:#fff; }
    button:active{ opacity:0.8; }
    .small-note{ font-size:0.7rem; color:var(--muted); margin-top:4px; text-align:center; }
  </style>
</head>
<body>
  <h1>CartPole V3 (Mobile Optimized)</h1>

  <div class="layout">
    <div class="box vis-container">
      <div class="stats">
        <div><div class="stat-label">Ep</div><div id="s-ep" class="stat-val">0</div></div>
        <div><div class="stat-label">Step</div><div id="s-step" class="stat-val">0</div></div>
        <div><div class="stat-label">Last</div><div id="s-last" class="stat-val">-</div></div>
        <div><div class="stat-label">Best</div><div id="s-best" class="stat-val">-</div></div>
      </div>
      <canvas id="cvs"></canvas>
    </div>

    <div class="box">
      <div class="controls-header">
        <span>Controls</span>
        <button id="btn-controls" class="controls-toggle">Hide</button>
      </div>
      <div id="controls-grid" class="controls-grid">
        <div class="ctrl">
          <label>Learning Rate <span id="lrVal">0.010</span></label>
          <input id="lr" type="range" min="0.001" max="0.05" step="0.001" value="0.01">
        </div>
        <div class="ctrl">
          <label>Gamma <span id="gammaVal">0.990</span></label>
          <input id="gamma" type="range" min="0.90" max="0.999" step="0.001" value="0.99">
        </div>
        <div class="ctrl">
          <label>Entropy Bonus <span id="entVal">0.005</span></label>
          <input id="entropy" type="range" min="0.000" max="0.02" step="0.001" value="0.005">
        </div>
        <div class="ctrl">
          <label>Steps/Frame <span id="spfVal">15</span></label>
          <input id="spf" type="range" min="1" max="60" step="1" value="15">
        </div>
        <div class="ctrl">
          <label>Max Episode Steps <span id="maxVal">1000</span></label>
          <input id="maxSteps" type="range" min="200" max="5000" step="100" value="1000">
        </div>
        <div class="ctrl">
          <label>Hidden Size</label>
          <select id="hidden">
            <option value="8">8</option>
            <option value="16">16</option>
            <option value="24" selected>24</option>
            <option value="32">32</option>
            <option value="48">48</option>
            <option value="64">64</option>
          </select>
        </div>
      </div>
      <div class="small-note">Hidden size change resets training.</div>
    </div>

    <div class="box">
      <div style="font-size:0.8rem;color:var(--muted);margin-bottom:4px;">Network (Live Weights)</div>
      <svg id="net" preserveAspectRatio="none"></svg>
    </div>

    <div class="box">
      <textarea id="logs" readonly></textarea>
      <div class="btn-group">
        <button id="btn-run">Start Training</button>
        <button id="btn-reset" class="secondary">Reset</button>
        <button id="btn-copy" class="secondary">Copy Log</button>
      </div>
    </div>
  </div>

<script>
// --- CONFIG (UI-tunable) ---
const CFG = {
  lr: 0.01,
  gamma: 0.99,
  hidden: 24,
  stepsPerFrame: 15,
  clip: 5.0,
  entropy: 0.005,
  maxSteps: 1000
};

// --- MATH (preallocated, no GC in forward) ---
const M = {
  new: (r,c)=>({r,c,d:new Float32Array(r*c)}),
  rand:(t)=>{
    const limit=Math.sqrt(6/(t.r+t.c));
    for(let i=0;i<t.d.length;i++) t.d[i]=(Math.random()*2*limit)-limit;
  },
  vecMat:(v,m,out)=>{
    for(let j=0;j<m.c;j++){
      let sum=0;
      for(let i=0;i<m.r;i++) sum += v.d[i]*m.d[i*m.c+j];
      out.d[j]=sum;
    }
  },
  add:(a,b,out)=>{ for(let i=0;i<a.d.length;i++) out.d[i]=a.d[i]+b.d[i]; },
  relu:(a,out)=>{ for(let i=0;i<a.d.length;i++) out.d[i]=a.d[i]>0?a.d[i]:0; },
  softmax:(a,out)=>{
    let max=-Infinity;
    for(let i=0;i<a.d.length;i++) if(a.d[i]>max) max=a.d[i];
    let sum=0;
    for(let i=0;i<a.d.length;i++){ out.d[i]=Math.exp(a.d[i]-max); sum+=out.d[i]; }
    for(let i=0;i<a.d.length;i++) out.d[i]/=sum;
  },
  clip:(t,max)=>{ for(let i=0;i<t.d.length;i++) t.d[i]=Math.max(-max,Math.min(max,t.d[i])); }
};

// --- AGENT ---
class Agent {
  constructor(){
    this.in=4; this.h=CFG.hidden; this.out=2;

    this.W1=M.new(this.in,this.h);
    this.b1=M.new(1,this.h);
    this.W2=M.new(this.h,this.out);
    this.b2=M.new(1,this.out);

    this.bufX=M.new(1,this.in);
    this.bufZ1=M.new(1,this.h);
    this.bufA1=M.new(1,this.h);
    this.bufZ2=M.new(1,this.out);
    this.bufP=M.new(1,this.out);

    this.dW1=M.new(this.in,this.h); this.db1=M.new(1,this.h);
    this.dW2=M.new(this.h,this.out); this.db2=M.new(1,this.out);
    this.baseline=0;
    this.reset();
  }
  reset(){
    M.rand(this.W1); this.b1.d.fill(0);
    M.rand(this.W2); this.b2.d.fill(0);
    this.baseline=0;
  }
  forward(state){
    this.bufX.d.set(state);
    M.vecMat(this.bufX,this.W1,this.bufZ1);
    M.add(this.bufZ1,this.b1,this.bufZ1);
    M.relu(this.bufZ1,this.bufA1);
    M.vecMat(this.bufA1,this.W2,this.bufZ2);
    M.add(this.bufZ2,this.b2,this.bufZ2);
    M.softmax(this.bufZ2,this.bufP);
    return this.bufP.d;
  }
  sample(p){ return Math.random()<p[0]?0:1; }

  train(history){
    let G=0;
    const advs=new Float32Array(history.length);
    for(let i=history.length-1;i>=0;i--){
      G=history[i].r + CFG.gamma*G;
      const p0=history[i].p[0], p1=history[i].p[1];
      const entropy=-(p0*Math.log(p0+1e-8)+p1*Math.log(p1+1e-8));
      const Gaug=G + CFG.entropy*entropy;
      this.baseline=0.95*this.baseline + 0.05*Gaug;
      advs[i]=Gaug - this.baseline;
    }

    this.dW1.d.fill(0); this.db1.d.fill(0);
    this.dW2.d.fill(0); this.db2.d.fill(0);
    const dZ2=new Float32Array(2);
    const dZ1=new Float32Array(this.h);

    for(let i=0;i<history.length;i++){
      const h=history[i], adv=advs[i];
      dZ2[0]=(h.p[0]-(h.act===0?1:0))*-adv;
      dZ2[1]=(h.p[1]-(h.act===1?1:0))*-adv;

      for(let r=0;r<this.h;r++)
        for(let c=0;c<2;c++)
          this.dW2.d[r*2+c]+=h.a1[r]*dZ2[c];
      this.db2.d[0]+=dZ2[0]; this.db2.d[1]+=dZ2[1];

      for(let r=0;r<this.h;r++){
        let sum=0;
        for(let c=0;c<2;c++) sum+=dZ2[c]*this.W2.d[r*2+c];
        dZ1[r]=sum*(h.z1[r]>0?1:0);
      }

      for(let r=0;r<4;r++)
        for(let c=0;c<this.h;c++)
          this.dW1.d[r*this.h+c]+=h.s[r]*dZ1[c];
      for(let c=0;c<this.h;c++) this.db1.d[c]+=dZ1[c];
    }

    M.clip(this.dW1,CFG.clip); M.clip(this.db1,CFG.clip);
    M.clip(this.dW2,CFG.clip); M.clip(this.db2,CFG.clip);
    const apply=(w,dw)=>{ for(let i=0;i<w.d.length;i++) w.d[i]+=CFG.lr*dw.d[i]; };
    apply(this.W1,this.dW1); apply(this.b1,this.db1);
    apply(this.W2,this.dW2); apply(this.b2,this.db2);
  }
}

// --- ENVIRONMENT ---
class CartPole {
  constructor(){ this.reset(); }
  reset(){
    this.s=new Float32Array([
      Math.random()*.1-.05, Math.random()*.1-.05,
      Math.random()*.1-.05, Math.random()*.1-.05
    ]);
    this.steps=0; return this.s;
  }
  step(act){
    let [x,xd,th,thd]=this.s;
    const force=act===1?10:-10;
    const cost=Math.cos(th), sint=Math.sin(th);
    const temp=(force + 0.05*thd*thd*sint)/1.1;
    const thacc=(9.8*sint - cost*temp)/(0.5*(4/3 - 0.1*cost*cost/1.1));
    const xacc=temp - 0.05*thacc*cost/1.1;
    x+=0.02*xd; xd+=0.02*xacc; th+=0.02*thd; thd+=0.02*thacc;
    this.s[0]=x; this.s[1]=xd; this.s[2]=th; this.s[3]=thd;
    this.steps++;
    const fail=x<-2.4||x>2.4||th<-.21||th>.21;
    const done=fail||this.steps>=CFG.maxSteps;
    return {done, rew: fail?0:1, fail};
  }
}

// --- VISUALIZATION (cached SVG) ---
const Vis={
  svg:document.getElementById('net'),
  els:{links:[],nodes:[]},
  init(agent){
    Vis.svg.innerHTML='';
    Vis.els={links:[],nodes:[]};
    const w=Vis.svg.clientWidth||360, h=Vis.svg.clientHeight||90;
    const layers=[4,agent.h,2];
    const ly=(l,i,tot)=>(h/(tot+1))*(i+1);
    const lx=(l)=>30 + l*((w-60)/2);

    for(let l=0;l<2;l++){
      const W=l===0?agent.W1:agent.W2;
      for(let i=0;i<W.r;i++) for(let j=0;j<W.c;j++){
        const el=document.createElementNS('http://www.w3.org/2000/svg','line');
        el.setAttribute('x1',lx(l));   el.setAttribute('y1',ly(l,i,layers[l]));
        el.setAttribute('x2',lx(l+1)); el.setAttribute('y2',ly(l+1,j,layers[l+1]));
        el.setAttribute('stroke-width','1');
        Vis.svg.appendChild(el);
        Vis.els.links.push({el,l,i,j});
      }
    }
    for(let l=0;l<3;l++){
      for(let i=0;i<layers[l];i++){
        const el=document.createElementNS('http://www.w3.org/2000/svg','circle');
        el.setAttribute('cx',lx(l)); el.setAttribute('cy',ly(l,i,layers[l]));
        el.setAttribute('r',3);
        Vis.svg.appendChild(el);
        Vis.els.nodes.push({el,l,i});
      }
    }
  },
  render(agent,lastAct){
    const getW=(l,r,c)=> l===0 ? agent.W1.d[r*agent.W1.c+c] : agent.W2.d[r*agent.W2.c+c];
    Vis.els.links.forEach(link=>{
      const v=getW(link.l,link.i,link.j);
      const a=Math.min(1,Math.abs(v));
      link.el.setAttribute('stroke', v>0?`rgba(0,255,255,${a})`:`rgba(255,0,100,${a})`);
    });
    Vis.els.nodes.forEach(node=>{
      let v=0;
      if(node.l===0) v=agent.bufX.d[node.i];
      else if(node.l===1) v=agent.bufA1.d[node.i];
      else v=agent.bufP.d[node.i];
      const color=(node.l===2&&node.i===lastAct)?'#fff':'#888';
      node.el.setAttribute('fill',color);
      node.el.setAttribute('fill-opacity',0.2+Math.min(0.8,Math.abs(v)));
    });
  }
};

// --- APP LOGIC ---
const cvs=document.getElementById('cvs');
const ctx=cvs.getContext('2d');
const logBox=document.getElementById('logs');

let cachedDims={w:0,h:0,dpr:0};
const resize=(force=false)=>{
  const r=cvs.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  if(!force && r.width===cachedDims.w && r.height===cachedDims.h && dpr===cachedDims.dpr) return cachedDims;
  cachedDims={w:r.width,h:r.height,dpr};
  cvs.width=r.width*dpr; cvs.height=r.height*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return cachedDims;
};

let agent=new Agent();
let env=new CartPole();
let history=[];
let isRunning=false, animId=null;
let metrics={ep:0,best:0};
let frame=0;

Vis.init(agent);

function log(msg){
  const txt=`[Ep ${metrics.ep}] ${msg}`;
  const lines=(logBox.value+txt+'\n').split('\n');
  logBox.value=lines.slice(-120).join('\n');
  logBox.scrollTop=logBox.scrollHeight;
}

function drawEnv(dims){
  const [x,xd,th,thd]=env.s;
  const scale=dims.w/6;
  const cx=dims.w/2 + x*scale;
  const cy=dims.h*0.8;

  ctx.clearRect(0,0,dims.w,dims.h);

  // Ground rail
  ctx.strokeStyle='#555'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(dims.w,cy); ctx.stroke();

  // End-stop "slider bars" at +/-2.4
  const leftStop=dims.w/2 - 2.4*scale;
  const rightStop=dims.w/2 + 2.4*scale;
  ctx.strokeStyle='#777'; ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(leftStop,cy-50); ctx.lineTo(leftStop,cy+12);
  ctx.moveTo(rightStop,cy-50); ctx.lineTo(rightStop,cy+12);
  ctx.stroke();

  // Cart
  ctx.fillStyle=isRunning? '#00bcd4':'#555';
  ctx.fillRect(cx-20,cy-10,40,20);

  // Pole
  const len=Math.min(80, dims.h*0.35);
  ctx.strokeStyle='#eee'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(cx,cy);
  ctx.lineTo(cx+Math.sin(th)*len, cy-Math.cos(th)*len);
  ctx.stroke();
}

function initTraining(resetMetrics=true){
  history=[];
  env.reset();
  if(resetMetrics) metrics={ep:0,best:0};
  document.getElementById('s-ep').innerText=metrics.ep;
  document.getElementById('s-best').innerText=metrics.best||'-';
  document.getElementById('s-last').innerText='-';
  document.getElementById('s-step').innerText=env.steps;
  drawEnv(resize(true));
}

function rebuildAgent(newHidden){
  const running=isRunning;
  if(running){ isRunning=false; cancelAnimationFrame(animId); }
  CFG.hidden=newHidden;
  agent=new Agent();
  Vis.init(agent);
  initTraining(true);
  log(`Rebuilt agent with hidden=${newHidden}.`);
  if(running){ isRunning=true; loop(); }
}

function loop(){
  if(!isRunning) return;
  frame++;
  const dims=(frame%10===0)?resize():cachedDims;
  let lastAct=0;

  for(let k=0;k<CFG.stepsPerFrame;k++){
    const stateSnap=Float32Array.from(env.s);
    const probs=agent.forward(env.s);
    const act=agent.sample(probs);
    const res=env.step(act);

    history.push({
      s:stateSnap, act, r:res.rew,
      z1:Float32Array.from(agent.bufZ1.d),
      a1:Float32Array.from(agent.bufA1.d),
      p:Float32Array.from(agent.bufP.d)
    });
    lastAct=act;

    if(res.done){
      agent.train(history);
      metrics.ep++;
      if(env.steps>metrics.best) metrics.best=env.steps;

      document.getElementById('s-ep').innerText=metrics.ep;
      document.getElementById('s-last').innerText=env.steps;
      document.getElementById('s-best').innerText=metrics.best;

      if(metrics.ep%10===0) log(`Last: ${env.steps} | Best: ${metrics.best}`);
      history=[]; env.reset();
      break;
    }
  }

  document.getElementById('s-step').innerText=env.steps;
  drawEnv(dims);
  Vis.render(agent,lastAct);

  animId=requestAnimationFrame(loop);
}

// --- UI HOOKUP ---
const lrEl=document.getElementById('lr');
const gammaEl=document.getElementById('gamma');
const entEl=document.getElementById('entropy');
const spfEl=document.getElementById('spf');
const maxEl=document.getElementById('maxSteps');
const hidEl=document.getElementById('hidden');

function setVal(id,val){ document.getElementById(id).innerText=val; }

lrEl.oninput=()=>{ CFG.lr=Number(lrEl.value); setVal('lrVal',CFG.lr.toFixed(3)); };
gammaEl.oninput=()=>{ CFG.gamma=Number(gammaEl.value); setVal('gammaVal',CFG.gamma.toFixed(3)); };
entEl.oninput=()=>{ CFG.entropy=Number(entEl.value); setVal('entVal',CFG.entropy.toFixed(3)); };
spfEl.oninput=()=>{ CFG.stepsPerFrame=Number(spfEl.value); setVal('spfVal',CFG.stepsPerFrame); };
maxEl.oninput=()=>{
  CFG.maxSteps=Number(maxEl.value);
  setVal('maxVal',CFG.maxSteps);
};
hidEl.onchange=()=>{ rebuildAgent(Number(hidEl.value)); };

// init displayed values
setVal('lrVal',CFG.lr.toFixed(3));
setVal('gammaVal',CFG.gamma.toFixed(3));
setVal('entVal',CFG.entropy.toFixed(3));
setVal('spfVal',CFG.stepsPerFrame);
setVal('maxVal',CFG.maxSteps);

// controls hide/show
const controlsBtn=document.getElementById('btn-controls');
const controlsGrid=document.getElementById('controls-grid');
controlsBtn.onclick=()=>{
  const hidden=controlsGrid.style.display==='none';
  controlsGrid.style.display=hidden?'grid':'none';
  controlsBtn.innerText=hidden?'Hide':'Show';
};

// buttons
document.getElementById('btn-run').onclick=(e)=>{
  isRunning=!isRunning;
  e.target.innerText=isRunning?'Stop':'Resume';
  e.target.style.background=isRunning?CFG.err || '#ff5252':'#00bcd4';
  if(isRunning) loop(); else cancelAnimationFrame(animId);
};

document.getElementById('btn-reset').onclick=()=>{
  if(!confirm("Reset Training?")) return;
  isRunning=false; cancelAnimationFrame(animId);
  const runBtn=document.getElementById('btn-run');
  runBtn.innerText="Start Training";
  runBtn.style.background="#00bcd4";
  agent.reset();
  Vis.init(agent);
  initTraining(true);
  log("Reset complete.");
};

document.getElementById('btn-copy').onclick=async(e)=>{
  try{
    await navigator.clipboard.writeText(logBox.value);
    e.target.innerText="Copied!";
  }catch{
    logBox.select(); document.execCommand('copy');
    e.target.innerText="Copied!";
  }
  setTimeout(()=>e.target.innerText="Copy Log",1000);
};

window.addEventListener('resize',()=>{ const d=resize(true); drawEnv(d); });

// init
initTraining(true);
log("Ready. V3 loaded.");
</script>
</body>
</html>
"""
path = Path("/mnt/data/cartpole-v3-mobile-optimized.html")
path.write_text(html_v3, encoding="utf-8")
str(path)