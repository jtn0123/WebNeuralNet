!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const t=50,e=50,i=30,s=8,a=10,n=30,o=20,r=8,l=.7,h=.7,d=.7,c=.7,u=.4,m=.7,g=.2,p=.998,y=.05,f=5,w=.95,v=5,x=3,b=100,E=10,I=2.4,M=4,k=.21,B=4,A=10;function T(t){return t[0]&&"number"==typeof t[0].length?t.map(t=>new Float32Array(t.length)):new Float32Array(t.length)}function L(e){const i=document.getElementById("log"),s=document.createElement("div");for(s.className="log-entry",s.textContent=`[${(new Date).toLocaleTimeString()}] ${e}`,i.appendChild(s),i.scrollTop=i.scrollHeight;i.children.length>t;)i.removeChild(i.firstChild)}class S{static show(t,e="info",i=3e3){const s=document.createElement("div");s.className=`toast toast-${e}`,s.textContent=t,s.style.cssText=`\n            position: fixed;\n            bottom: 20px;\n            right: 20px;\n            background: ${"success"===e?"#4caf50":"error"===e?"#f44336":"#667eea"};\n            color: white;\n            padding: 12px 20px;\n            border-radius: 6px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n            z-index: 10000;\n            font-size: 14px;\n            animation: slideIn 0.3s ease;\n        `,document.body.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.3s ease",setTimeout(()=>s.remove(),300)},i)}static success(t){this.show(t,"success")}static error(t){this.show(t,"error")}static info(t){this.show(t,"info")}}if(!document.querySelector("style[data-toast-animations]")){const t=document.createElement("style");t.setAttribute("data-toast-animations","true"),t.textContent="\n        @keyframes slideIn {\n            from { transform: translateX(400px); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n        @keyframes slideOut {\n            from { transform: translateX(0); opacity: 1; }\n            to { transform: translateX(400px); opacity: 0; }\n        }\n    ",document.head.appendChild(t)}class C{constructor(){this.gravity=9.8,this.massCart=1,this.massPole=.1,this.totalMass=this.massCart+this.massPole,this.length=.5,this.poleMassLength=this.massPole*this.length,this.forceMag=10,this.tau=.02,this.thetaThreshold=12*Math.PI/180,this.xThreshold=2.4,this.reset()}reset(){return this.x=.1*(Math.random()-.5),this.xDot=.1*(Math.random()-.5),this.theta=.1*(Math.random()-.5),this.thetaDot=.1*(Math.random()-.5),this.steps=0,this.getState()}getState(){return[this.x,this.xDot,this.theta,this.thetaDot]}step(t){const e=1===t?this.forceMag:-this.forceMag,i=Math.cos(this.theta),s=Math.sin(this.theta),a=(e+this.poleMassLength*this.thetaDot*this.thetaDot*s)/this.totalMass,n=(this.gravity*s-i*a)/(this.length*(4/3-this.massPole*i*i/this.totalMass)),o=a-this.poleMassLength*n*i/this.totalMass;this.x+=this.tau*this.xDot,this.xDot+=this.tau*o,this.theta+=this.tau*this.thetaDot,this.thetaDot+=this.tau*n,this.steps++;const r=this.x<-this.xThreshold||this.x>this.xThreshold||this.theta<-this.thetaThreshold||this.theta>this.thetaThreshold||this.steps>=500,l=r?0:1;return{state:this.getState(),reward:l,done:r}}}class z{constructor(t,e=.001,i=.9,s=.999,a=1e-8){this.learningRate=e,this.beta1=i,this.beta2=s,this.epsilon=a,this.t=0,this.m=T(t),this.v=T(t)}update(t,e){if(this.t++,t[0]&&"number"==typeof t[0].length)for(let i=0;i<t.length;i++)for(let s=0;s<t[i].length;s++){this.m[i][s]=this.beta1*this.m[i][s]+(1-this.beta1)*e[i][s],this.v[i][s]=this.beta2*this.v[i][s]+(1-this.beta2)*e[i][s]*e[i][s];const a=this.m[i][s]/(1-Math.pow(this.beta1,this.t)),n=this.v[i][s]/(1-Math.pow(this.beta2,this.t));t[i][s]-=this.learningRate*a/(Math.sqrt(n)+this.epsilon)}else for(let i=0;i<t.length;i++){this.m[i]=this.beta1*this.m[i]+(1-this.beta1)*e[i],this.v[i]=this.beta2*this.v[i]+(1-this.beta2)*e[i]*e[i];const s=this.m[i]/(1-Math.pow(this.beta1,this.t)),a=this.v[i]/(1-Math.pow(this.beta2,this.t));t[i]-=this.learningRate*s/(Math.sqrt(a)+this.epsilon)}}}class P{constructor(t,e,i,s="relu"){this.inputSize=t,this.hiddenSizes=Array.isArray(e)?e:[e],this.outputSize=i,this.activation=s,this.layers=[];let a=t;for(const n of this.hiddenSizes)this.layers.push({w:this.heInitialize(a,n),b:new Float32Array(n),type:"hidden"}),a=n;this.actorHead={w:this.heInitialize(a,i),b:new Float32Array(i)},this.criticHead={w:this.heInitialize(a,1),b:new Float32Array(1)},this.optimizers={layers:[],actor:{w:new z(this.actorHead.w),b:new z(this.actorHead.b)},critic:{w:new z(this.criticHead.w),b:new z(this.criticHead.b)}};for(const n of this.layers)this.optimizers.layers.push({w:new z(n.w),b:new z(n.b)});this.lastInput=null,this.lastHidden=[],this.lastOutput=null,this.lastValue=0}heInitialize(t,e){const i=Math.sqrt(6/t),s=[];for(let a=0;a<t;a++){s[a]=new Float32Array(e);for(let t=0;t<e;t++)s[a][t]=2*(Math.random()-.5)*i}return s}activate(t,e=!1){switch(this.activation){case"relu":default:return e?t>0?1:0:Math.max(0,t);case"tanh":if(e){const e=Math.tanh(t);return 1-e*e}return Math.tanh(t);case"elu":const i=1;return e?t>0?1:i*Math.exp(t):t>0?t:i*(Math.exp(t)-1);case"swish":const s=1/(1+Math.exp(-t));return e?s+t*s*(1-s):t*s}}softmax(t){const e=Math.max(...t),i=new Float32Array(t.length);let s=0;for(let n=0;n<t.length;n++)i[n]=Math.exp(t[n]-e),s+=i[n];const a=new Float32Array(t.length);for(let n=0;n<t.length;n++)a[n]=i[n]/s;return a}forward(t){this.lastInput=new Float32Array(t),this.lastHidden=[],this.lastPreActivation=[];let e=t;for(let a=0;a<this.layers.length;a++){const t=this.layers[a],i=new Float32Array(t.b.length),s=new Float32Array(t.b.length);for(let a=0;a<t.b.length;a++){let n=t.b[a];for(let i=0;i<e.length;i++)n+=e[i]*t.w[i][a];s[a]=n,i[a]=this.activate(n)}this.lastPreActivation.push(new Float32Array(s)),this.lastHidden.push(new Float32Array(i)),e=i}const i=new Float32Array(this.outputSize);for(let a=0;a<this.outputSize;a++){let t=this.actorHead.b[a];for(let i=0;i<e.length;i++)t+=e[i]*this.actorHead.w[i][a];i[a]=t}this.lastOutput=this.softmax(i);let s=this.criticHead.b[0];for(let a=0;a<e.length;a++)s+=e[a]*this.criticHead.w[a][0];return this.lastValue=s,{policy:this.lastOutput,value:this.lastValue}}selectAction(t,e=0){const{policy:i}=this.forward(t);if(e>0&&Math.random()<.5*e)return Math.random()<.5?0:1;const s=Math.random();let a=0;for(let n=0;n<i.length;n++)if(a+=i[n],s<a)return n;return i.length-1}getEntropy(){if(!this.lastOutput)return 0;let t=0;for(let e=0;e<this.lastOutput.length;e++){const i=this.lastOutput[e];i>0&&(t-=i*Math.log(i))}return t}getAvgWeight(t){let e=0,i=0;for(let s=0;s<t.length;s++)for(let a=0;a<t[s].length;a++)e+=Math.abs(t[s][a]),i++;return i>0?e/i:0}update(t,e,i=.01,s=.1,a=1,n=.95,o=4){Array.isArray(t[0])||(t=[t]);const r=[],l=[],h=[];let d=0,c=0;for(const y of t){const t=[];for(let e=0;e<y.length;e++){const{value:i}=this.forward(y[e].state);t.push(i),h.push(y[e])}let i=0;const s=new Array(y.length),a=new Array(y.length);for(let o=y.length-1;o>=0;o--){const r=y[o].reward,l=t[o];i=r+e*(o<y.length-1?t[o+1]:0)-l+e*n*i,s[o]=i,a[o]=i+l}r.push(...s),l.push(...a)}const u=r.reduce((t,e)=>t+e,0)/r.length,m=Math.sqrt(r.reduce((t,e)=>t+(e-u)**2,0)/r.length),g=r.map(t=>(t-u)/Math.max(m,1e-8)),p=h.length;for(let y=0;y<o;y++){const t=this.layers.map(t=>({w:t.w.map(t=>new Float32Array(t.length)),b:new Float32Array(t.b.length)})),e={w:this.actorHead.w.map(t=>new Float32Array(t.length)),b:new Float32Array(this.actorHead.b.length)},n={w:this.criticHead.w.map(t=>new Float32Array(t.length)),b:new Float32Array(this.criticHead.b.length)};let r=0,u=0;for(let a=0;a<h.length;a++){const{state:o,action:d,prob:c}=h[a],m=g[a],p=l[a],{policy:y,value:f}=this.forward(o),w=y[d]/Math.max(c||1/this.outputSize,1e-10),v=w*m,x=Math.max(.8,Math.min(1.2,w))*m;let b=0;for(const t of y)t>0&&(b-=t*Math.log(t));r+=-Math.min(v,x)-i*b;let E=0;E=v<=x?w:0;const I=new Float32Array(y);I[d]-=1;for(let t=0;t<this.outputSize;t++){I[t]*=m*E;const e=y[t];e>1e-10&&(I[t]-=i*(Math.log(e+1e-10)+b)*e)}const M=f-p,k=Math.abs(M),B=1;let A;k<=B?(u+=.5*M*M,A=M):(u+=B*(k-.5*B),A=B*Math.sign(M));const T=new Float32Array(1);T[0]=s*A,this.backprop(o,I,T,t,e,n)}const m=[...t,e,n];for(const i of m){for(let t=0;t<i.w.length;t++)for(let e=0;e<i.w[t].length;e++)i.w[t][e]/=p;for(let t=0;t<i.b.length;t++)i.b[t]/=p}const f=this.getGradientNorm(m),w=Math.min(1,a/(f+1e-10));w<1&&this.scaleGradients(m,w);for(let i=0;i<this.layers.length;i++)this.optimizers.layers[i].w.update(this.layers[i].w,t[i].w),this.optimizers.layers[i].b.update(this.layers[i].b,t[i].b);this.optimizers.actor.w.update(this.actorHead.w,e.w),this.optimizers.actor.b.update(this.actorHead.b,e.b),this.optimizers.critic.w.update(this.criticHead.w,n.w),this.optimizers.critic.b.update(this.criticHead.b,n.b),y===o-1&&(d=r/p,c=u/p)}return{avgAdvantage:u,avgReturn:l.reduce((t,e)=>t+e,0)/l.length,gradNorm:0,actorLoss:d,criticLoss:c}}getGradientNorm(t){let e=0;for(const i of t){for(let t=0;t<i.w.length;t++)for(let s=0;s<i.w[t].length;s++)e+=i.w[t][s]*i.w[t][s];for(let t=0;t<i.b.length;t++)e+=i.b[t]*i.b[t]}return Math.sqrt(e)}scaleGradients(t,e){for(const i of t){for(let t=0;t<i.w.length;t++)for(let s=0;s<i.w[t].length;s++)i.w[t][s]*=e;for(let t=0;t<i.b.length;t++)i.b[t]*=e}}backprop(t,e,i,s,a,n){const o=this.lastHidden[this.lastHidden.length-1];for(let l=0;l<o.length;l++)for(let t=0;t<this.outputSize;t++)a.w[l][t]+=o[l]*e[t];for(let l=0;l<this.outputSize;l++)a.b[l]+=e[l];for(let l=0;l<o.length;l++)n.w[l][0]+=o[l]*i[0];n.b[0]+=i[0];let r=new Float32Array(o.length);for(let l=0;l<o.length;l++){for(let t=0;t<this.outputSize;t++)r[l]+=e[t]*this.actorHead.w[l][t];r[l]+=i[0]*this.criticHead.w[l][0]}for(let l=this.layers.length-1;l>=0;l--){const t=this.layers[l],e=this.lastHidden[l],i=this.lastPreActivation[l],a=l>0?this.lastHidden[l-1]:this.lastInput;for(let s=0;s<r.length;s++)r[s]*=this.activate(i[s],!0);for(let n=0;n<a.length;n++)for(let t=0;t<e.length;t++)s[l].w[n][t]+=a[n]*r[t];for(let n=0;n<e.length;n++)s[l].b[n]+=r[n];if(l>0){const i=new Float32Array(a.length);for(let s=0;s<a.length;s++)for(let a=0;a<e.length;a++)i[s]+=r[a]*t.w[s][a];r=i}}}get w1(){var t;return(null==(t=this.layers[0])?void 0:t.w)||[]}get w2(){return this.layers.length>1?this.layers[1].w:this.actorHead.w}get hiddenSize(){return this.hiddenSizes[0]}setLearningRate(t){for(const e of this.optimizers.layers)e.w.learningRate=t,e.b.learningRate=t;this.optimizers.actor.w.learningRate=t,this.optimizers.actor.b.learningRate=t,this.optimizers.critic.w.learningRate=t,this.optimizers.critic.b.learningRate=t}getInputImportance(t){const{policy:e,value:i}=this.forward(t),s=new Float32Array(t.length);if(this.layers[0]){const e=this.layers[0].w;for(let i=0;i<t.length;i++){let a=0;for(let t=0;t<e[i].length;t++)a+=Math.abs(e[i][t]);s[i]=Math.abs(t[i])*a}}return s}}class F{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.offscreenCanvas.width=t.width,this.offscreenCanvas.height=t.height}render(t){const g=this.offscreenCtx,p=this.offscreenCanvas.width,y=this.offscreenCanvas.height;g.fillStyle="rgba(227, 242, 253, 0.5)",g.fillRect(0,0,p,y),g.fillStyle="#8d6e63",g.fillRect(0,y*l,p,y*(1-l)),g.strokeStyle="#555",g.lineWidth=2,g.beginPath(),g.moveTo(0,y*h),g.lineTo(p,y*h),g.stroke();const f=p/6,w=p/2-t.xThreshold*f,v=p/2+t.xThreshold*f;g.strokeStyle="#f44336",g.lineWidth=3,g.setLineDash([5,5]),g.beginPath(),g.moveTo(w,.5*y),g.lineTo(w,y*d),g.stroke(),g.beginPath(),g.moveTo(v,.5*y),g.lineTo(v,y*d),g.stroke(),g.setLineDash([]);const x=p/2+t.x*f,b=y*d,E=e,I=i;g.fillStyle="#1976d2",g.fillRect(x-E/2,b-I,E,I),g.fillStyle="#333",g.beginPath(),g.arc(x-E/3,b,s,0,2*Math.PI),g.fill(),g.beginPath(),g.arc(x+E/3,b,s,0,2*Math.PI),g.fill();const M=2*t.length*f,k=x+M*Math.sin(t.theta),B=b-I-M*Math.cos(t.theta),A=Math.abs(t.theta)/t.thetaThreshold;let T="#4caf50";if(A>c?T="#f44336":A>u&&(T="#ff9800"),g.strokeStyle=T,g.lineWidth=6,g.lineCap="round",g.beginPath(),g.moveTo(x,b-I),g.lineTo(k,B),g.stroke(),g.fillStyle=T,g.beginPath(),g.arc(k,B,a,0,2*Math.PI),g.fill(),g.strokeStyle=T,g.lineWidth=2,g.globalAlpha=.5,g.beginPath(),g.arc(x,b-I,n,-Math.PI/2,-Math.PI/2+t.theta,t.theta>0),g.stroke(),g.globalAlpha=1,Math.abs(t.xDot)>.1){g.strokeStyle="#2196f3",g.lineWidth=4,g.beginPath(),g.moveTo(x,b-I/2);const e=o;g.lineTo(x+t.xDot*e,b-I/2),g.stroke();const i=t.xDot>0?0:Math.PI;g.beginPath(),g.moveTo(x+t.xDot*e,b-I/2),g.lineTo(x+t.xDot*e-Math.cos(i-Math.PI/6)*r,b-I/2-Math.sin(i-Math.PI/6)*r),g.lineTo(x+t.xDot*e-Math.cos(i+Math.PI/6)*r,b-I/2-Math.sin(i+Math.PI/6)*r),g.closePath(),g.fillStyle="#2196f3",g.fill()}g.fillStyle="#333",g.font="bold 14px monospace",g.fillText(`Î¸: ${(180*t.theta/Math.PI).toFixed(1)}Â°`,10,20),g.fillText(`x: ${t.x.toFixed(2)}`,10,40),(Math.abs(t.x)>t.xThreshold*m||Math.abs(t.theta)>t.thetaThreshold*m)&&(g.fillStyle="#f44336",g.font="bold 16px sans-serif",g.fillText("âš ï¸ CRITICAL",p-120,30)),this.ctx.drawImage(this.offscreenCanvas,0,0)}}class H{constructor(t){this.svg=document.getElementById(t),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.svg.getBoundingClientRect();this.width=t.width,this.height=t.height}visualize(t){this.svg.innerHTML="";const e=[{size:t.inputSize,label:"Input",type:"input"}];for(let n=0;n<t.hiddenSizes.length;n++)e.push({size:t.hiddenSizes[n],label:`Hidden ${n+1}`,type:"hidden",layerIdx:n});e.push({size:t.outputSize,label:"Actor",type:"actor"}),e.push({size:1,label:"Critic",type:"critic"});const i=this.width/(e.length+1),s=e.map((t,s)=>{const a=i*(s+1),n=Math.max(...e.map(t=>t.size)),o=Math.min(25,this.height/(n+1)),r=(this.height-(t.size-1)*o)/2;return Array.from({length:t.size},(t,e)=>({x:a,y:r+e*o}))}),a=document.createElementNS("http://www.w3.org/2000/svg","g");for(let n=0;n<e.length;n++){const i=e[n],o=[];if("input"===i.type){const i=e.find(t=>"hidden"===t.type&&0===t.layerIdx);i&&o.push({layer:i,weights:t.layers[0].w,idx:e.indexOf(i)})}else if("hidden"===i.type){const s=e.find(t=>"hidden"===t.type&&t.layerIdx===i.layerIdx+1);if(s)o.push({layer:s,weights:t.layers[s.layerIdx].w,idx:e.indexOf(s)});else{const i=e.find(t=>"actor"===t.type),s=e.find(t=>"critic"===t.type);i&&o.push({layer:i,weights:t.actorHead.w,idx:e.indexOf(i)}),s&&o.push({layer:s,weights:t.criticHead.w,idx:e.indexOf(s)})}}for(const t of o){const e=t.layer,o=t.idx,r=t.weights;for(let t=0;t<i.size;t++)for(let i=0;i<e.size;i++){const l=r[t][i],h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",s[n][t].x),h.setAttribute("y1",s[n][t].y),h.setAttribute("x2",s[o][i].x),h.setAttribute("y2",s[o][i].y);const d=Math.min(1,2*Math.abs(l));let c=l>0?"#4caf50":"#f44336";"critic"===e.type&&(c=l>0?"#2196f3":"#ff9800"),h.setAttribute("stroke",c),h.setAttribute("stroke-opacity",.3*d),h.setAttribute("stroke-width","1"),a.appendChild(h)}}}this.svg.appendChild(a),e.forEach((e,a)=>{s[a].forEach((i,s)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",i.x),a.setAttribute("cy",i.y),a.setAttribute("r",7);let n=0;"input"===e.type&&t.lastInput?n=t.lastInput[s]:"hidden"===e.type&&t.lastHidden[e.layerIdx]?n=t.lastHidden[e.layerIdx][s]:"actor"===e.type&&t.lastOutput?n=t.lastOutput[s]:"critic"===e.type&&(n=t.lastValue/100);const o=Math.min(1,Math.abs(n));let r="#667eea";"critic"===e.type?r="#2196f3":"actor"===e.type&&(r="#4caf50"),a.setAttribute("fill",r),a.setAttribute("fill-opacity",.3+.7*o),a.setAttribute("stroke","#333"),a.setAttribute("stroke-width","2"),this.svg.appendChild(a)});const n=document.createElementNS("http://www.w3.org/2000/svg","text");n.setAttribute("x",i*(a+1)),n.setAttribute("y",this.height-10),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","11"),n.setAttribute("font-weight","bold"),"actor"===e.type?n.setAttribute("fill","#4caf50"):"critic"===e.type?n.setAttribute("fill","#2196f3"):n.setAttribute("fill","#666"),n.textContent=e.label,this.svg.appendChild(n)})}}class N{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.data=[],this.maxDataPoints=100,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}addDataPoint(t,e){this.data.push({episode:t,reward:e}),this.data.length>this.maxDataPoints&&this.data.shift(),this.render()}clear(){this.data=[],this.render()}render(){const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=40;if(t.fillStyle="white",t.fillRect(0,0,e,i),0===this.data.length)return t.fillStyle="#999",t.font="14px sans-serif",t.textAlign="center",void t.fillText("Training data will appear here...",e/2,i/2);const a=this.data.map(t=>t.reward),n=Math.min(...a),o=Math.max(...a),r=o-n||1;t.strokeStyle="#e0e0e0",t.lineWidth=1;for(let l=0;l<=5;l++){const a=s+(i-80)*l/5;t.beginPath(),t.moveTo(s,a),t.lineTo(e-s,a),t.stroke();const n=o-r*l/5;t.fillStyle="#666",t.font="11px sans-serif",t.textAlign="right",t.fillText(n.toFixed(0),35,a+4)}if(t.strokeStyle="#667eea",t.lineWidth=2,t.beginPath(),this.data.forEach((a,o)=>{const l=s+(e-80)*o/(this.data.length-1||1),h=s+(i-80)*(1-(a.reward-n)/r);0===o?t.moveTo(l,h):t.lineTo(l,h)}),t.stroke(),t.fillStyle="#667eea",this.data.forEach((a,o)=>{const l=s+(e-80)*o/(this.data.length-1||1),h=s+(i-80)*(1-(a.reward-n)/r);t.beginPath(),t.arc(l,h,3,0,2*Math.PI),t.fill()}),this.data.length>=10){t.strokeStyle="#ff9800",t.lineWidth=2,t.setLineDash([5,5]),t.beginPath();for(let a=9;a<this.data.length;a++){const o=this.data.slice(a-9,a+1).reduce((t,e)=>t+e.reward,0)/10,l=s+(e-80)*a/(this.data.length-1),h=s+(i-80)*(1-(o-n)/r);9===a?t.moveTo(l,h):t.lineTo(l,h)}t.stroke(),t.setLineDash([])}t.fillStyle="#333",t.font="12px sans-serif",t.textAlign="center",t.fillText("Episode",e/2,i-5),t.save(),t.translate(15,i/2),t.rotate(-Math.PI/2),t.fillText("Survival Time",0,0),t.restore(),t.textAlign="left",t.fillStyle="#667eea",t.fillRect(e-150,10,15,3),t.fillStyle="#666",t.fillText("Episode Reward",e-130,15),t.fillStyle="#ff9800",t.fillRect(e-150,25,15,3),t.fillStyle="#666",t.fillText("10-Ep Average",e-130,30)}}class D{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.actorLosses=[],this.criticLosses=[],this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}addDataPoint(t,e){this.actorLosses.push(t),this.criticLosses.push(e),this.actorLosses.length>200&&(this.actorLosses.shift(),this.criticLosses.shift()),this.draw()}draw(){const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=40;if(t.fillStyle="white",t.fillRect(0,0,e,i),0===this.actorLosses.length)return;const a=Math.max(...this.actorLosses,.1),n=Math.max(...this.criticLosses,.1),o=Math.max(a,n);t.strokeStyle="#999",t.lineWidth=1,t.beginPath(),t.moveTo(s,i-s),t.lineTo(e-s,i-s),t.stroke(),t.beginPath(),t.moveTo(s,s),t.lineTo(s,i-s),t.stroke(),t.strokeStyle="#667eea",t.lineWidth=2,t.beginPath();for(let r=0;r<this.actorLosses.length;r++){const a=s+r/(this.actorLosses.length-1||1)*(e-80),n=i-s-this.actorLosses[r]/o*(i-80);0===r?t.moveTo(a,n):t.lineTo(a,n)}t.stroke(),t.strokeStyle="#ff9800",t.lineWidth=2,t.beginPath();for(let r=0;r<this.criticLosses.length;r++){const a=s+r/(this.criticLosses.length-1||1)*(e-80),n=i-s-this.criticLosses[r]/o*(i-80);0===r?t.moveTo(a,n):t.lineTo(a,n)}t.stroke(),t.fillStyle="#333",t.font="12px sans-serif",t.fillText("0",20,i-s+5),t.fillText(o.toFixed(2),5,45),t.fillStyle="#667eea",t.fillRect(e-180,10,12,12),t.fillStyle="#333",t.fillText("Actor Loss",e-160,20),t.fillStyle="#ff9800",t.fillRect(e-180,30,12,12),t.fillStyle="#333",t.fillText("Critic Loss",e-160,40)}clear(){this.actorLosses=[],this.criticLosses=[],this.draw()}}class R{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.heatmapData=null,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}computeHeatmap(t,e){this.heatmapData=[];const i=-e.xThreshold,s=e.xThreshold,a=-e.thetaThreshold,n=e.thetaThreshold;for(let o=0;o<30;o++){this.heatmapData[o]=[];for(let e=0;e<30;e++){const r=[i+o/30*(s-i),0,a+e/30*(n-a),0],l=[r[0]/I,r[1]/M,r[2]/k,r[3]/B],{value:h}=t.forward(l);this.heatmapData[o][e]=Math.max(0,Math.min(1,(h+50)/100))}}this.draw()}draw(){if(!this.heatmapData){const t=this.ctx;return t.fillStyle="#ccc",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.fillStyle="#999",t.font="14px sans-serif",t.textAlign="center",void t.fillText("Train network to see state space values",this.canvas.width/2,this.canvas.height/2)}const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=this.heatmapData.length,a=30,n=(e-a)/s,o=(i-a)/s;for(let r=0;r<s;r++)for(let e=0;e<s;e++){const i=this.heatmapData[r][e];let s;if(i<.5){s=`rgb(0, ${Math.floor(2*i*255)}, 255)`}else{s=`rgb(${255}, ${255}, ${Math.floor(2*(1-i)*255)})`}t.fillStyle=s,t.fillRect(a+r*n,a+e*o,n,o)}t.fillStyle="#333",t.font="11px sans-serif",t.textAlign="center",t.fillText("Position",a+(e-a)/2,i-8),t.save(),t.textAlign="center",t.translate(12,i/2),t.rotate(-Math.PI/2),t.fillText("Angle",0,0),t.restore()}clear(){this.heatmapData=null,this.draw()}}class ${constructor(){this.metrics={gradNorm:0,avgAdvantage:0,avgReturn:0,avgQValue:0,entropy:0,leftAction:0,rightAction:0}}update(t){Object.assign(this.metrics,t)}render(){document.getElementById("metric-grad-norm")&&(document.getElementById("metric-grad-norm").textContent=this.metrics.gradNorm.toFixed(3)),document.getElementById("metric-advantage")&&(document.getElementById("metric-advantage").textContent=this.metrics.avgAdvantage.toFixed(3)),document.getElementById("metric-return")&&(document.getElementById("metric-return").textContent=this.metrics.avgReturn.toFixed(1)),document.getElementById("metric-qvalue")&&(document.getElementById("metric-qvalue").textContent=this.metrics.avgQValue.toFixed(2)),document.getElementById("metric-entropy")&&(document.getElementById("metric-entropy").textContent=this.metrics.entropy.toFixed(3)),document.getElementById("metric-left-action")&&(document.getElementById("metric-left-action").textContent=(100*this.metrics.leftAction).toFixed(0)+"%"),document.getElementById("metric-right-action")&&(document.getElementById("metric-right-action").textContent=(100*this.metrics.rightAction).toFixed(0)+"%")}}const O=new class{constructor(){this.env=new C,this.network=null,this.renderer=new F("cartpole-canvas"),this.visualizer=new H("network-svg"),this.chart=new N("training-chart"),this.lossChart=new D("training-loss-chart"),this.metricsDashboard=new $,this.heatmap=new R("state-space-heatmap"),this.isTraining=!1,this.isTesting=!1,this.isManual=!1,this.isPaused=!1,this.episode=0,this.survivalHistory=[],this.explorationHistory=[],this.currentTrajectory=[],this.manualAction=null,this.trainingSpeed=f,this.exploration=g,this.explorationDecay=p,this.minExploration=y,this.gaeLambda=w,this.frameCounter=0,this.initialLearningRate=parseFloat(document.getElementById("learning-rate").value),this.lastGradNorm=0,this.lastAvgAdvantage=0,this.lastAvgReturn=0,this.lastActorLoss=0,this.lastCriticLoss=0,this.batchBuffer=[],this.initNetwork(),this.setupControls(),this.setupKeyboard(),this.setupGlobalKeyboardShortcuts(),this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay(),this.updateNetworkStats(),this.animate(),L("CartPole RL Sandbox initialized"),L("Using Actor-Critic with GAE (Î»=0.95) and Adam optimizer"),L("Network sees 4 inputs: position, velocity, angle, angular velocity"),L("Pole angle & angular velocity are MOST IMPORTANT for balancing!"),L("Watch Input Importance bars to see what the network focuses on"),L("Better exploration: Îµ starts at 0.20, decays slowly to 0.05"),L("Gradient norm and advantage metrics show training health")}normalizeState(t){return[t[0]/I,t[1]/M,t[2]/k,t[3]/B]}initNetwork(){this.batchBuffer=[];const t=parseInt(document.getElementById("hidden-size").value),e=parseInt(document.getElementById("network-depth").value),i=document.getElementById("activation").value,s=Array(e).fill(t);this.network=new P(4,s,2,i),this.visualizer.visualize(this.network),L(`Network created: 4 â†’ ${s.join(" â†’ ")} â†’ 2 (Actor) + 1 (Critic)`),L(`Activation: ${i.toUpperCase()}, Optimizer: Adam`)}setupControls(){document.getElementById("train-btn").addEventListener("click",()=>this.toggleTraining()),document.getElementById("pause-btn").addEventListener("click",()=>this.togglePause()),document.getElementById("test-btn").addEventListener("click",()=>this.testPolicy()),document.getElementById("reset-btn").addEventListener("click",()=>this.resetPolicy()),document.getElementById("manual-btn").addEventListener("click",()=>this.toggleManual()),document.getElementById("copy-logs-btn").addEventListener("click",()=>async function(){const t=document.getElementById("log"),e=Array.from(t.querySelectorAll(".log-entry")).map(t=>t.textContent).join("\n");try{await navigator.clipboard.writeText(e);const t=document.getElementById("copy-logs-btn"),i=t.textContent;return t.textContent="Copied!",t.style.background="#ffff00",t.style.color="#000000",setTimeout(()=>{t.textContent=i,t.style.background="",t.style.color=""},1500),!0}catch(i){return console.error("Failed to copy logs:",i),!1}}()),document.getElementById("save-network-btn").addEventListener("click",()=>this.saveNetwork()),document.getElementById("load-network-btn").addEventListener("click",()=>this.loadNetwork()),document.getElementById("export-data-btn").addEventListener("click",()=>this.exportTrainingData()),document.getElementById("preset-quick").addEventListener("click",()=>this.applyPreset("quick")),document.getElementById("preset-deep").addEventListener("click",()=>this.applyPreset("deep")),document.getElementById("preset-exploration").addEventListener("click",()=>this.applyPreset("exploration")),document.getElementById("preset-production").addEventListener("click",()=>this.applyPreset("production")),document.getElementById("hidden-size").addEventListener("change",t=>{const e=parseInt(t.target.value);if(e<16||e>256||e%8!=0)return S.error("Hidden layer size must be between 16 and 256 (multiples of 8)"),void(t.target.value="32");this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("network-depth").addEventListener("change",()=>{this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("activation").addEventListener("change",()=>{this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("learning-rate").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<1e-4||e>.01)return S.error("Learning rate must be between 0.0001 and 0.01"),void(t.target.value="0.003");this.network.setLearningRate(e),L(`Learning rate updated to ${e}`)}),document.getElementById("discount").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<.9||e>1)return S.error("Discount factor must be between 0.9 and 1.0"),void(t.target.value="0.99")}),document.getElementById("entropy-coef").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<0||e>.1)return S.error("Entropy coefficient must be between 0 and 0.1"),void(t.target.value="0.02")}),document.getElementById("gae-lambda").addEventListener("input",t=>{this.gaeLambda=parseFloat(t.target.value),document.getElementById("gae-lambda-value").textContent=this.gaeLambda.toFixed(2)});document.getElementById("training-speed").addEventListener("input",t=>{this.trainingSpeed=parseInt(t.target.value),document.getElementById("speed-value").textContent=`${this.trainingSpeed}x`})}setupKeyboard(){document.addEventListener("keydown",t=>{this.isManual&&("ArrowLeft"===t.key||"a"===t.key||"A"===t.key?(this.manualAction=0,t.preventDefault()):"ArrowRight"!==t.key&&"d"!==t.key&&"D"!==t.key||(this.manualAction=1,t.preventDefault()))});const t=document.getElementById("touch-left"),e=document.getElementById("touch-right");t&&(t.addEventListener("touchstart",()=>{this.isManual&&(this.manualAction=0)}),t.addEventListener("touchend",()=>{this.isManual&&(this.manualAction=null)}),t.addEventListener("mousedown",()=>{this.isManual&&(this.manualAction=0)}),t.addEventListener("mouseup",()=>{this.isManual&&(this.manualAction=null)})),e&&(e.addEventListener("touchstart",()=>{this.isManual&&(this.manualAction=1)}),e.addEventListener("touchend",()=>{this.isManual&&(this.manualAction=null)}),e.addEventListener("mousedown",()=>{this.isManual&&(this.manualAction=1)}),e.addEventListener("mouseup",()=>{this.isManual&&(this.manualAction=null)}))}setMode(t){const e=document.getElementById("mode-indicator");e.textContent=t,e.className="mode-indicator "+({IDLE:"",TRAINING:"mode-training",TESTING:"mode-testing",MANUAL:"mode-manual"}[t]||"")}toggleManual(){if(this.isTraining||this.isTesting)return;this.isManual=!this.isManual;const t=document.getElementById("manual-btn"),e=document.getElementById("keyboard-hint"),i=document.getElementById("touch-controls");this.isManual?(t.textContent="Stop Manual",t.className="secondary",e.style.display="block",i.style.display="flex",this.setMode("MANUAL"),this.env.reset(),L("Manual control enabled - use arrow keys, A/D, or touch buttons"),this.manualLoop()):(t.textContent="Manual Control",t.className="secondary",e.style.display="none",i.style.display="none",this.setMode("IDLE"),L("Manual control disabled"))}async manualLoop(){for(;this.isManual;){if(null!==this.manualAction){const t=this.env.step(this.manualAction),e=this.env.getState();this.network.forward(this.normalizeState(e)),t.done&&(L(`Episode ended: survived ${this.env.steps} steps`),await new Promise(t=>setTimeout(t,1e3)),this.env.reset()),this.manualAction=null}this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay(),this.visualizer.visualize(this.network),await new Promise(t=>setTimeout(t,20))}}toggleTraining(){this.isManual&&this.toggleManual(),this.isTraining=!this.isTraining;const t=document.getElementById("train-btn"),e=document.getElementById("pause-btn");this.isTraining?(t.textContent="Stop Training",t.className="danger",e.style.display="block",e.textContent="Pause",this.isPaused=!1,this.setMode("TRAINING"),L("Training started"),this.trainingLoop()):(t.textContent="Start Training",t.className="primary",e.style.display="none",this.isPaused=!1,this.setMode("IDLE"),L("Training stopped"))}togglePause(){this.isPaused=!this.isPaused;const t=document.getElementById("pause-btn");this.isPaused?(t.textContent="Resume",L("Training paused - inspect metrics without losing progress")):(t.textContent="Pause",L("Training resumed"))}async trainingLoop(){for(;this.isTraining;){if(this.isPaused){await new Promise(t=>setTimeout(t,100));continue}await this.runEpisode(!0);const t=Math.max(1,50-5*this.trainingSpeed);await new Promise(e=>setTimeout(e,t))}}async runEpisode(t=!1){const e=this.env.reset();this.currentTrajectory=[];let i=!1;const s=t?Math.max(0,3-.3*this.trainingSpeed):20;for(;!i&&(this.isTraining||this.isTesting);){const a=this.normalizeState(e),n=t?this.network.selectAction(a,this.exploration):this.network.selectAction(a,0),o=this.env.step(n),r=a[0],l=a[2];let h=.1;o.done?h=-1:(h+=.5*(1-l*l),h+=.4*(1-r*r));const d=(this.network.lastOutput||[.5,.5])[n];this.currentTrajectory.push({state:[...a],action:n,reward:h,prob:d}),Object.assign(e,o.state),i=o.done,this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay(),this.frameCounter++%x===0&&this.visualizer.visualize(this.network),await new Promise(t=>setTimeout(t,s))}if(t&&this.currentTrajectory.length>0){if(this.batchBuffer.push(this.currentTrajectory),this.batchBuffer.length>=v){const t=parseFloat(document.getElementById("discount").value),e=parseFloat(document.getElementById("entropy-coef").value),i=this.initialLearningRate*Math.pow(.9995,this.episode);this.network.setLearningRate(i);const s=this.network.update(this.batchBuffer,t,e,1,2,this.gaeLambda);this.lastGradNorm=s.gradNorm,this.lastAvgAdvantage=s.avgAdvantage,this.lastAvgReturn=s.avgReturn,this.lastActorLoss=s.actorLoss,this.lastCriticLoss=s.criticLoss,this.lossChart.addDataPoint(s.actorLoss,s.criticLoss),this.metricsDashboard.update({gradNorm:s.gradNorm,avgAdvantage:s.avgAdvantage,avgReturn:s.avgReturn}),this.metricsDashboard.render(),this.batchBuffer=[]}if(this.episode%25==0)try{this.heatmap.computeHeatmap(this.network,this.env)}catch(a){}this.exploration=Math.max(this.minExploration,this.exploration*this.explorationDecay)}if(this.episode++,this.survivalHistory.push(this.env.steps),this.explorationHistory.push(this.exploration),this.survivalHistory.length>b&&(this.survivalHistory.shift(),this.explorationHistory.shift()),this.chart.addDataPoint(this.episode,this.env.steps),this.episode%E===0){const t=this.survivalHistory.slice(-10).reduce((t,e)=>t+e,0)/Math.min(A,this.survivalHistory.length),e=this.lastGradNorm?` |âˆ‡|=${this.lastGradNorm.toFixed(2)}`:"";L(`Ep ${this.episode}: Avg=${t.toFixed(1)} steps, Îµ=${this.exploration.toFixed(3)}${e}`)}this.updateNetworkStats()}async testPolicy(){this.isTraining&&this.toggleTraining(),this.isManual&&this.toggleManual(),this.isTesting=!0,this.setMode("TESTING");const t=document.getElementById("test-btn");t.disabled=!0,L("Testing current policy..."),await this.runEpisode(!1),L(`Test complete: survived ${this.env.steps} steps`),this.isTesting=!1,this.setMode("IDLE"),t.disabled=!1,this.updateStateDisplay()}resetPolicy(){this.isTraining=!1,this.isTesting=!1,this.isManual&&this.toggleManual(),document.getElementById("train-btn").textContent="Start Training",document.getElementById("train-btn").className="primary",this.setMode("IDLE"),this.episode=0,this.survivalHistory=[],this.explorationHistory=[],this.batchBuffer=[],this.exploration=g,this.chart.clear(),this.lossChart.clear(),this.heatmap.clear(),this.initNetwork(),this.env.reset(),this.updateMetrics(),this.updateStateDisplay(),this.updateNetworkStats(),L("Policy reset - exploration reset to 0.2 with GAE enabled")}updateActionBars(){if(this.network.lastOutput){const t=this.network.lastOutput,e=(100*t[0]).toFixed(1);document.getElementById("action-left").style.transform=`scaleY(${t[0]})`,document.getElementById("action-left-val").textContent=e+"%";const i=(100*t[1]).toFixed(1);document.getElementById("action-right").style.transform=`scaleY(${t[1]})`,document.getElementById("action-right-val").textContent=i+"%"}}updateStateDisplay(){const t=this.env.getState(),[e,i,s,a]=t,n=I,o=M,r=k,l=B,h=Math.min(1,Math.abs(e)/n);document.getElementById("perception-x-val").textContent=e.toFixed(2),document.getElementById("perception-x-bar").style.width=100*h+"%",document.getElementById("perception-x").classList.toggle("active",h>.6);const d=Math.min(1,Math.abs(i)/o);document.getElementById("perception-xdot-val").textContent=i.toFixed(2),document.getElementById("perception-xdot-bar").style.width=100*d+"%",document.getElementById("perception-xdot").classList.toggle("active",d>.4);const m=180*s/Math.PI,g=Math.min(1,Math.abs(s)/r);document.getElementById("perception-theta-val").textContent=m.toFixed(1)+"Â°",document.getElementById("perception-theta-bar").style.width=100*g+"%",document.getElementById("perception-theta").classList.add("active");const p=Math.min(1,Math.abs(a)/l);document.getElementById("perception-thetadot-val").textContent=a.toFixed(2),document.getElementById("perception-thetadot-bar").style.width=100*p+"%",document.getElementById("perception-thetadot").classList.add("active");const y=50+s/r*50;document.getElementById("theta-bar").style.width=Math.max(0,Math.min(100,y))+"%",document.getElementById("theta-value").textContent=m.toFixed(1)+"Â°";const f=50+a/l*50;document.getElementById("thetadot-bar").style.width=Math.max(0,Math.min(100,f))+"%",document.getElementById("thetadot-value").textContent=a.toFixed(2),document.getElementById("value-x").textContent=e.toFixed(2);const w=50+e/n*50;document.getElementById("indicator-x").style.width=Math.max(0,Math.min(100,w))+"%",document.getElementById("indicator-x").className="state-indicator"+(h>.6?" danger":""),document.getElementById("value-xdot").textContent=i.toFixed(2);const v=50+i/o*50;document.getElementById("indicator-xdot").style.width=Math.max(0,Math.min(100,v))+"%",document.getElementById("indicator-xdot").className="state-indicator"+(d>.4?" warning":""),document.getElementById("value-theta").textContent=m.toFixed(1);const x=50+s/r*50;document.getElementById("indicator-theta").style.width=Math.max(0,Math.min(100,x))+"%",document.getElementById("indicator-theta").className="state-indicator"+(g>c?" danger":g>u?" warning":""),document.getElementById("value-thetadot").textContent=a.toFixed(2);const b=50+a/l*50;document.getElementById("indicator-thetadot").style.width=Math.max(0,Math.min(100,b))+"%",document.getElementById("indicator-thetadot").className="state-indicator"+(p>.5?" warning":"");const E=this.network.getInputImportance(this.normalizeState(t)),A=Math.max(...E,.001),T=E[0]/A*100,L=E[1]/A*100,S=E[2]/A*100,C=E[3]/A*100;document.getElementById("importance-x-bar").style.width=T+"%",document.getElementById("importance-x-val").textContent=T.toFixed(0)+"%",document.getElementById("importance-xdot-bar").style.width=L+"%",document.getElementById("importance-xdot-val").textContent=L.toFixed(0)+"%",document.getElementById("importance-theta-bar").style.width=S+"%",document.getElementById("importance-theta-val").textContent=S.toFixed(0)+"%",document.getElementById("importance-thetadot-bar").style.width=C+"%",document.getElementById("importance-thetadot-val").textContent=C.toFixed(0)+"%"}updateNetworkStats(){let t=0,e=0;for(const n of this.network.layers)for(let i=0;i<n.w.length;i++)for(let s=0;s<n.w[i].length;s++)t+=Math.abs(n.w[i][s]),e++;const i=e>0?t/e:0,s=this.network.getAvgWeight(this.network.actorHead.w),a=this.network.getEntropy();document.getElementById("avg-w1").textContent=i.toFixed(3),document.getElementById("avg-w2").textContent=s.toFixed(3),document.getElementById("entropy").textContent=a.toFixed(3),document.getElementById("exploration-rate").textContent=this.exploration.toFixed(3),document.getElementById("grad-norm").textContent=this.lastGradNorm?this.lastGradNorm.toFixed(2):"0.00",document.getElementById("avg-advantage").textContent=this.lastAvgAdvantage?this.lastAvgAdvantage.toFixed(2):"0.00"}updateMetrics(){if(document.getElementById("episode-count").textContent=this.episode,document.getElementById("steps-count").textContent=this.env.steps,document.getElementById("reward-count").textContent=this.env.steps,void 0!==this.network.lastValue&&(document.getElementById("value-estimate").textContent=this.network.lastValue.toFixed(1)),this.survivalHistory.length>0){const t=this.survivalHistory[this.survivalHistory.length-1],e=Math.max(...this.survivalHistory),i=this.survivalHistory.slice(-10).reduce((t,e)=>t+e,0)/Math.min(10,this.survivalHistory.length);document.getElementById("last-survival").textContent=t,document.getElementById("best-survival").textContent=e,document.getElementById("avg-survival").textContent=i.toFixed(1)}else document.getElementById("last-survival").textContent="0",document.getElementById("best-survival").textContent="0",document.getElementById("avg-survival").textContent="0"}saveNetwork(){const t={timestamp:(new Date).toISOString(),episode:this.episode,survivalHistory:this.survivalHistory,network:{layers:this.network.layers.map(t=>({w:t.w,b:t.b})),actorHead:{w:this.network.actorHead.w,b:this.network.actorHead.b},criticHead:{w:this.network.criticHead.w,b:this.network.criticHead.b},hiddenSizes:this.network.hiddenSizes,activation:this.network.activation},hyperparameters:{learningRate:parseFloat(document.getElementById("learning-rate").value),discount:parseFloat(document.getElementById("discount").value),entropy:parseFloat(document.getElementById("entropy-coef").value),hiddenSize:parseInt(document.getElementById("hidden-size").value),networkDepth:parseInt(document.getElementById("network-depth").value),gaeLambda:this.gaeLambda}},e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),a=document.createElement("a");a.href=s,a.download=`cartpole-network-${t.timestamp.substring(0,10)}.json`,a.click(),URL.revokeObjectURL(s),S.success(`Network saved! Trained for ${this.episode} episodes`),L(`Saved network with ${this.episode} episodes of training`)}loadNetwork(){const t=document.createElement("input");t.type="file",t.accept="application/json",t.onchange=t=>{const e=t.target.files[0];if(!e)return;const i=new FileReader;i.onload=t=>{try{const e=JSON.parse(t.target.result);if(e.hyperparameters&&(document.getElementById("learning-rate").value=e.hyperparameters.learningRate,document.getElementById("discount").value=e.hyperparameters.discount,document.getElementById("entropy-coef").value=e.hyperparameters.entropy,document.getElementById("hidden-size").value=e.hyperparameters.hiddenSize,document.getElementById("network-depth").value=e.hyperparameters.networkDepth,void 0!==e.hyperparameters.gaeLambda&&(this.gaeLambda=e.hyperparameters.gaeLambda,document.getElementById("gae-lambda").value=e.hyperparameters.gaeLambda,document.getElementById("gae-lambda-value").textContent=e.hyperparameters.gaeLambda.toFixed(2))),this.initNetwork(),e.network&&e.network.activation&&(this.network.activation=e.network.activation,document.getElementById("activation").value=e.network.activation),e.network&&e.network.layers){for(let t=0;t<e.network.layers.length;t++)this.network.layers[t].w=e.network.layers[t].w,this.network.layers[t].b=e.network.layers[t].b;this.network.actorHead.w=e.network.actorHead.w,this.network.actorHead.b=e.network.actorHead.b,this.network.criticHead.w=e.network.criticHead.w,this.network.criticHead.b=e.network.criticHead.b}this.visualizer.visualize(this.network),S.success(`Network loaded! ${e.episode} episodes of training restored`),L(`Loaded network trained for ${e.episode} episodes`)}catch(e){S.error("Failed to load network: "+e.message),L("Error loading network: "+e.message)}},i.readAsText(e)},t.click()}exportTrainingData(){let t="Episode,Survival_Steps,Actor_Loss,Critic_Loss,Exploration_Rate\n";for(let a=0;a<this.survivalHistory.length;a++)t+=`${a+1},${this.survivalHistory[a]},${this.lossChart.actorLosses[a]||0},${this.lossChart.criticLosses[a]||0},${this.explorationHistory[a]||0}\n`;const e=new Blob([t],{type:"text/csv"}),i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download=`cartpole-training-${(new Date).toISOString().substring(0,10)}.csv`,s.click(),URL.revokeObjectURL(i),S.success(`Training data exported (${this.episode} episodes)`),L(`Exported training data: ${this.episode} episodes`)}applyPreset(t){const e={quick:{lr:.005,discount:.99,entropy:.02,hidden:32,depth:1,speed:8},deep:{lr:.003,discount:.99,entropy:.015,hidden:64,depth:2,speed:1},exploration:{lr:.002,discount:.95,entropy:.05,hidden:32,depth:1,speed:3},production:{lr:.001,discount:.99,entropy:.01,hidden:128,depth:2,speed:1}}[t];if(!e)return void S.error("Unknown preset: "+t);document.getElementById("learning-rate").value=e.lr,document.getElementById("discount").value=e.discount,document.getElementById("entropy-coef").value=e.entropy,document.getElementById("hidden-size").value=e.hidden,document.getElementById("network-depth").value=e.depth,this.trainingSpeed=e.speed,document.getElementById("training-speed").value=e.speed,this.initNetwork(),this.heatmap.clear(),this.lossChart.clear();S.success(`Preset loaded: ${{quick:"âš¡ Quick Train",deep:"ðŸ§  Deep Learn",exploration:"ðŸ” Exploration",production:"ðŸ­ Production"}[t]}`),L(`Applied ${t} preset`)}setupGlobalKeyboardShortcuts(){document.addEventListener("keydown",t=>{if("INPUT"!==document.activeElement.tagName)switch(t.key){case" ":t.preventDefault(),this.toggleTraining();break;case"t":case"T":this.isTraining||this.isManual||this.testPolicy();break;case"r":case"R":this.resetPolicy();break;case"s":case"S":this.isTraining||this.isTesting||this.isManual||this.saveNetwork();break;case"l":case"L":this.isTraining||this.isTesting||this.isManual||this.loadNetwork();break;case"m":case"M":this.isTraining||this.isTesting||this.toggleManual();break;case"p":case"P":this.isTraining&&this.togglePause()}},{passive:!1})}animate(){this.renderer.render(this.env),this.updateStateDisplay(),requestAnimationFrame(()=>this.animate())}};window.sandbox=O,L("CartPole RL Sandbox initialized successfully");
