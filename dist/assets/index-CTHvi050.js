!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const t=50,e=50,i=30,s=8,a=10,n=30,o=20,r=8,l=.7,h=.7,d=.7,c=.7,u=.4,m=.7,p=.2,g=.998,y=.05,f=5,x=.95,v=3,w=5,b=100,M=10,E=2.4,S=4,I=.21,A=4,T=10;function k(t){return t[0]&&"number"==typeof t[0].length?t.map(t=>new Float32Array(t.length)):new Float32Array(t.length)}function L(e){const i=document.getElementById("log"),s=document.createElement("div");for(s.className="log-entry",s.textContent=`[${(new Date).toLocaleTimeString()}] ${e}`,i.appendChild(s),i.scrollTop=i.scrollHeight;i.children.length>t;)i.removeChild(i.firstChild)}function B(t,e){let i;return function(...s){clearTimeout(i),i=setTimeout(()=>t.apply(this,s),e)}}function C(t,e){t=t.replace("#","");return`rgba(${parseInt(t.substring(0,2),16)}, ${parseInt(t.substring(2,4),16)}, ${parseInt(t.substring(4,6),16)}, ${e})`}function P(){const t="light"!==document.documentElement.getAttribute("data-theme");return{background:t?"#0a0e27":"#ffffff",textPrimary:t?"#e8eaed":"#1a1a1a",textSecondary:t?"#9aa0b8":"#666666",border:t?"#2d3550":"#e0e0e0",primary:"#00d4ff",secondary:"#ff9800",success:"#6bcf7f",grid:t?"#2d3550":"#e0e0e0",placeholder:"#999999"}}class z{static show(t,e="info",i=3e3){const s=document.createElement("div");s.className=`toast toast-${e}`,s.textContent=t,s.style.cssText=`\n            position: fixed;\n            bottom: 20px;\n            right: 20px;\n            background: ${"success"===e?"#4caf50":"error"===e?"#f44336":"#667eea"};\n            color: white;\n            padding: 12px 20px;\n            border-radius: 6px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n            z-index: 10000;\n            font-size: 14px;\n            animation: slideIn 0.3s ease;\n        `,document.body.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.3s ease",setTimeout(()=>s.remove(),300)},i)}static success(t){this.show(t,"success")}static error(t){this.show(t,"error")}static info(t){this.show(t,"info")}}if(!document.querySelector("style[data-toast-animations]")){const t=document.createElement("style");t.setAttribute("data-toast-animations","true"),t.textContent="\n        @keyframes slideIn {\n            from { transform: translateX(400px); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n        @keyframes slideOut {\n            from { transform: translateX(0); opacity: 1; }\n            to { transform: translateX(400px); opacity: 0; }\n        }\n    ",document.head.appendChild(t)}class F{constructor(){this.gravity=9.8,this.massCart=1,this.massPole=.1,this.totalMass=this.massCart+this.massPole,this.length=.5,this.poleMassLength=this.massPole*this.length,this.forceMag=10,this.tau=.02,this.thetaThreshold=12*Math.PI/180,this.xThreshold=2.4,this.reset()}reset(){return this.x=.1*(Math.random()-.5),this.xDot=.1*(Math.random()-.5),this.theta=.1*(Math.random()-.5),this.thetaDot=.1*(Math.random()-.5),this.steps=0,this.getState()}getState(){return[this.x,this.xDot,this.theta,this.thetaDot]}step(t){const e=1===t?this.forceMag:-this.forceMag,i=Math.cos(this.theta),s=Math.sin(this.theta),a=(e+this.poleMassLength*this.thetaDot*this.thetaDot*s)/this.totalMass,n=(this.gravity*s-i*a)/(this.length*(4/3-this.massPole*i*i/this.totalMass)),o=a-this.poleMassLength*n*i/this.totalMass;this.x+=this.tau*this.xDot,this.xDot+=this.tau*o,this.theta+=this.tau*this.thetaDot,this.thetaDot+=this.tau*n,this.steps++;const r=this.x<-this.xThreshold||this.x>this.xThreshold||this.theta<-this.thetaThreshold||this.theta>this.thetaThreshold||this.steps>=500,l=r?0:1;return{state:this.getState(),reward:l,done:r}}}class D{constructor(t,e=.001,i=.9,s=.999,a=1e-8){this.learningRate=e,this.beta1=i,this.beta2=s,this.epsilon=a,this.t=0,this.m=k(t),this.v=k(t)}update(t,e){if(this.t++,t[0]&&"number"==typeof t[0].length)for(let i=0;i<t.length;i++)for(let s=0;s<t[i].length;s++){this.m[i][s]=this.beta1*this.m[i][s]+(1-this.beta1)*e[i][s],this.v[i][s]=this.beta2*this.v[i][s]+(1-this.beta2)*e[i][s]*e[i][s];const a=this.m[i][s]/(1-Math.pow(this.beta1,this.t)),n=this.v[i][s]/(1-Math.pow(this.beta2,this.t));t[i][s]-=this.learningRate*a/(Math.sqrt(n)+this.epsilon)}else for(let i=0;i<t.length;i++){this.m[i]=this.beta1*this.m[i]+(1-this.beta1)*e[i],this.v[i]=this.beta2*this.v[i]+(1-this.beta2)*e[i]*e[i];const s=this.m[i]/(1-Math.pow(this.beta1,this.t)),a=this.v[i]/(1-Math.pow(this.beta2,this.t));t[i]-=this.learningRate*s/(Math.sqrt(a)+this.epsilon)}}}class H{constructor(t,e,i,s="relu"){this.inputSize=t,this.hiddenSizes=Array.isArray(e)?e:[e],this.outputSize=i,this.activation=s,this.layers=[];let a=t;for(const n of this.hiddenSizes)this.layers.push({w:this.orthogonalInitialize(a,n),b:new Float32Array(n),type:"hidden"}),a=n;this.actorHead={w:this.orthogonalInitialize(a,i),b:new Float32Array(i)},this.criticHead={w:this.orthogonalInitialize(a,1),b:new Float32Array(1)},this.optimizers={layers:[],actor:{w:new D(this.actorHead.w),b:new D(this.actorHead.b)},critic:{w:new D(this.criticHead.w),b:new D(this.criticHead.b)}};for(const n of this.layers)this.optimizers.layers.push({w:new D(n.w),b:new D(n.b)});this.lastInput=null,this.lastHidden=[],this.lastOutput=null,this.lastValue=0,this.lastGradientMagnitudes={layers:this.layers.map(()=>({w:0,b:0})),actor:{w:0,b:0},critic:{w:0,b:0}},this.bufferPool={softmax:{exps:new Float32Array(this.outputSize),result:new Float32Array(this.outputSize)},forward:{input:new Float32Array(this.inputSize),hidden:this.hiddenSizes.map(t=>new Float32Array(t)),preActivations:this.hiddenSizes.map(t=>new Float32Array(t)),actorOutput:new Float32Array(this.outputSize),criticOutput:new Float32Array(1)},gradients:{layers:this.layers.map(t=>({w:t.w.map(t=>new Float32Array(t.length)),b:new Float32Array(t.b.length)})),actor:{w:this.actorHead.w.map(t=>new Float32Array(t.length)),b:new Float32Array(this.actorHead.b.length)},critic:{w:this.criticHead.w.map(t=>new Float32Array(t.length)),b:new Float32Array(this.criticHead.b.length)}},actorOutputGrad:new Float32Array(this.outputSize)}}heInitialize(t,e){const i=Math.sqrt(6/t),s=[];for(let a=0;a<t;a++){s[a]=new Float32Array(e);for(let t=0;t<e;t++)s[a][t]=2*(Math.random()-.5)*i}return s}orthogonalInitialize(t,e){const i=[];for(let a=0;a<Math.max(t,e);a++){i[a]=new Float32Array(Math.max(t,e));for(let s=0;s<Math.max(t,e);s++)i[a][s]=2*Math.random()-1}for(let a=0;a<Math.max(t,e);a++){let s=0;for(let n=0;n<a;n++){let s=0;for(let o=0;o<Math.max(t,e);o++)s+=i[a][o]*i[n][o];for(let o=0;o<Math.max(t,e);o++)i[a][o]-=s*i[n][o]}for(let n=0;n<Math.max(t,e);n++)s+=i[a][n]*i[a][n];if(s=Math.sqrt(s),s>1e-10)for(let n=0;n<Math.max(t,e);n++)i[a][n]/=s}const s=[];for(let a=0;a<t;a++){s[a]=new Float32Array(e);for(let t=0;t<e;t++)s[a][t]=i[a][t]}return s}activate(t,e=!1){switch(this.activation){case"relu":default:return e?t>0?1:0:Math.max(0,t);case"tanh":if(e){const e=Math.tanh(t);return 1-e*e}return Math.tanh(t);case"elu":const i=1;return e?t>0?1:i*Math.exp(t):t>0?t:i*(Math.exp(t)-1);case"swish":const s=1/(1+Math.exp(-t));return e?s+t*s*(1-s):t*s}}softmax(t){const e=Math.max(...t),i=this.bufferPool.softmax.exps;let s=0;for(let n=0;n<t.length;n++)i[n]=Math.exp(t[n]-e),s+=i[n];const a=this.bufferPool.softmax.result;for(let n=0;n<t.length;n++)a[n]=i[n]/s;return new Float32Array(a)}forward(t){this.lastInput=new Float32Array(t),this.lastHidden=[],this.lastPreActivation=[];let e=t;for(let a=0;a<this.layers.length;a++){const t=this.layers[a],i=this.bufferPool.forward.preActivations[a],s=this.bufferPool.forward.hidden[a];for(let a=0;a<t.b.length;a++){let n=t.b[a];for(let i=0;i<e.length;i++)n+=e[i]*t.w[i][a];i[a]=n,s[a]=this.activate(n)}this.lastPreActivation.push(new Float32Array(i)),this.lastHidden.push(new Float32Array(s)),e=s}const i=this.bufferPool.forward.actorOutput;for(let a=0;a<this.outputSize;a++){let t=this.actorHead.b[a];for(let i=0;i<e.length;i++)t+=e[i]*this.actorHead.w[i][a];i[a]=t}this.lastOutput=this.softmax(i);let s=this.criticHead.b[0];for(let a=0;a<e.length;a++)s+=e[a]*this.criticHead.w[a][0];return this.lastValue=Math.max(-1e3,Math.min(1e3,s)),{policy:this.lastOutput,value:this.lastValue}}selectAction(t,e=0){const{policy:i}=this.forward(t);if(e>0&&Math.random()<.5*e)return Math.random()<.5?0:1;const s=Math.random();let a=0;for(let n=0;n<i.length;n++)if(a+=i[n],s<a)return n;return i.length-1}getEntropy(){if(!this.lastOutput)return 0;let t=0;for(let e=0;e<this.lastOutput.length;e++){const i=this.lastOutput[e];i>0&&(t-=i*Math.log(i))}return t}getAvgWeight(t){let e=0,i=0;for(let s=0;s<t.length;s++)for(let a=0;a<t[s].length;a++)e+=Math.abs(t[s][a]),i++;return i>0?e/i:0}update(t,e,i=.01,s=.1,a=1,n=.95,o=4){Array.isArray(t[0])||(t=[t]);const r=[],l=[],h=[],d=[];let c=0,u=0;for(const f of t){const t=[];for(let e=0;e<f.length;e++){const{value:i}=this.forward(f[e].state);t.push(i),d.push(f[e]),h.push(i)}let i=0;const s=new Array(f.length),a=new Array(f.length);for(let o=f.length-1;o>=0;o--){const r=f[o].reward,l=t[o];i=r+e*(o<f.length-1?t[o+1]:0)-l+e*n*i,s[o]=i,a[o]=i+l}r.push(...s),l.push(...a)}const m=r.reduce((t,e)=>t+e,0)/r.length,p=Math.sqrt(r.reduce((t,e)=>t+(e-m)**2,0)/r.length),g=r.map(t=>(t-m)/Math.max(p,1e-8)),y=d.length;for(let f=0;f<o;f++){const t=this.bufferPool.gradients.layers,e=this.bufferPool.gradients.actor,n=this.bufferPool.gradients.critic;for(let i=0;i<t.length;i++){for(let e=0;e<t[i].w.length;e++)t[i].w[e].fill(0);t[i].b.fill(0)}for(let i=0;i<e.w.length;i++)e.w[i].fill(0);e.b.fill(0);for(let i=0;i<n.w.length;i++)n.w[i].fill(0);n.b.fill(0);let r=0,m=0;const p=new Array(d.length);for(let a=0;a<d.length;a++){const{state:o,action:c,prob:u}=d[a],y=g[a],f=l[a],x=h[a],{policy:v,value:w}=this.forward(o);p[a]=w;const b=v[c]/Math.max(u||1/this.outputSize,1e-10),M=b*y,E=Math.max(.8,Math.min(1.2,b))*y;let S=0;for(const t of v)t>0&&(S-=t*Math.log(t));r+=-Math.min(M,E)-i*S;let I=0;I=M<=E?b:0;const A=this.bufferPool.actorOutputGrad;A.set(v),A[c]-=1;for(let t=0;t<this.outputSize;t++){A[t]*=y*I;const e=v[t];e>1e-10&&(A[t]-=i*(Math.log(e+1e-10)+S)*e)}const T=.2,k=w-f,L=x+Math.max(-T,Math.min(T,w-x))-f,B=1;let C,P;C=Math.abs(k)<=B?.5*k*k:B*(Math.abs(k)-.5*B),P=Math.abs(L)<=B?.5*L*L:B*(Math.abs(L)-.5*B);let z;if(m+=Math.max(C,P),C>=P){z=Math.abs(k)<=B?k:B*Math.sign(k)}else{const t=w-x;if(Math.abs(t)<=T){z=Math.abs(L)<=B?L:B*Math.sign(L)}else z=0}const F=new Float32Array(1);F[0]=s*z,this.backprop(o,A,F,t,e,n)}const x=[...t,e,n];for(const i of x){for(let t=0;t<i.w.length;t++)for(let e=0;e<i.w[t].length;e++)i.w[t][e]/=y;for(let t=0;t<i.b.length;t++)i.b[t]/=y}const v=this.getGradientNorm(x),w=Math.min(1,a/(v+1e-10));w<1&&this.scaleGradients(x,w);for(let i=0;i<this.layers.length;i++)this.optimizers.layers[i].w.update(this.layers[i].w,t[i].w),this.optimizers.layers[i].b.update(this.layers[i].b,t[i].b);this.optimizers.actor.w.update(this.actorHead.w,e.w),this.optimizers.actor.b.update(this.actorHead.b,e.b),this.optimizers.critic.w.update(this.criticHead.w,n.w),this.optimizers.critic.b.update(this.criticHead.b,n.b);for(let i=0;i<p.length;i++)h[i]=p[i];if(f===o-1){c=r/y,u=m/y;for(let e=0;e<t.length;e++){let i=0,s=0;for(let a=0;a<t[e].w.length;a++)for(let s=0;s<t[e].w[a].length;s++)i+=t[e].w[a][s]*t[e].w[a][s];for(let a=0;a<t[e].b.length;a++)s+=t[e].b[a]*t[e].b[a];this.lastGradientMagnitudes.layers[e].w=Math.sqrt(i)/(t[e].w.length+1e-10),this.lastGradientMagnitudes.layers[e].b=Math.sqrt(s)/(t[e].b.length+1e-10)}let i=0,s=0;for(let t=0;t<e.w.length;t++)for(let s=0;s<e.w[t].length;s++)i+=e.w[t][s]*e.w[t][s];for(let t=0;t<e.b.length;t++)s+=e.b[t]*e.b[t];this.lastGradientMagnitudes.actor.w=Math.sqrt(i)/(e.w.length+1e-10),this.lastGradientMagnitudes.actor.b=Math.sqrt(s)/(e.b.length+1e-10);let a=0,o=0;for(let t=0;t<n.w.length;t++)for(let e=0;e<n.w[t].length;e++)a+=n.w[t][e]*n.w[t][e];for(let t=0;t<n.b.length;t++)o+=n.b[t]*n.b[t];this.lastGradientMagnitudes.critic.w=Math.sqrt(a)/(n.w.length+1e-10),this.lastGradientMagnitudes.critic.b=Math.sqrt(o)/(n.b.length+1e-10)}}return{avgAdvantage:m,avgReturn:l.reduce((t,e)=>t+e,0)/l.length,gradNorm:0,actorLoss:c,criticLoss:u}}getGradientNorm(t){let e=0;for(const i of t){for(let t=0;t<i.w.length;t++)for(let s=0;s<i.w[t].length;s++)e+=i.w[t][s]*i.w[t][s];for(let t=0;t<i.b.length;t++)e+=i.b[t]*i.b[t]}return Math.sqrt(e)}scaleGradients(t,e){for(const i of t){for(let t=0;t<i.w.length;t++)for(let s=0;s<i.w[t].length;s++)i.w[t][s]*=e;for(let t=0;t<i.b.length;t++)i.b[t]*=e}}backprop(t,e,i,s,a,n){const o=this.lastHidden[this.lastHidden.length-1];for(let l=0;l<o.length;l++)for(let t=0;t<this.outputSize;t++)a.w[l][t]+=o[l]*e[t];for(let l=0;l<this.outputSize;l++)a.b[l]+=e[l];for(let l=0;l<o.length;l++)n.w[l][0]+=o[l]*i[0];n.b[0]+=i[0];let r=new Float32Array(o.length);for(let l=0;l<o.length;l++){for(let t=0;t<this.outputSize;t++)r[l]+=e[t]*this.actorHead.w[l][t];r[l]+=i[0]*this.criticHead.w[l][0]}for(let l=this.layers.length-1;l>=0;l--){const t=this.layers[l],e=this.lastHidden[l],i=this.lastPreActivation[l],a=l>0?this.lastHidden[l-1]:this.lastInput;for(let s=0;s<r.length;s++)r[s]*=this.activate(i[s],!0);for(let n=0;n<a.length;n++)for(let t=0;t<e.length;t++)s[l].w[n][t]+=a[n]*r[t];for(let n=0;n<e.length;n++)s[l].b[n]+=r[n];if(l>0){const i=new Float32Array(a.length);for(let s=0;s<a.length;s++)for(let a=0;a<e.length;a++)i[s]+=r[a]*t.w[s][a];r=i}}}get w1(){var t;return(null==(t=this.layers[0])?void 0:t.w)||[]}get w2(){return this.layers.length>1?this.layers[1].w:this.actorHead.w}get hiddenSize(){return this.hiddenSizes[0]}setLearningRate(t){for(const e of this.optimizers.layers)e.w.learningRate=t,e.b.learningRate=t;this.optimizers.actor.w.learningRate=t,this.optimizers.actor.b.learningRate=t,this.optimizers.critic.w.learningRate=t,this.optimizers.critic.b.learningRate=t}getInputImportance(t){const{policy:e,value:i}=this.forward(t),s=new Float32Array(t.length);if(this.layers[0]){const e=this.layers[0].w;for(let i=0;i<t.length;i++){let a=0;for(let t=0;t<e[i].length;t++)a+=Math.abs(e[i][t]);s[i]=Math.abs(t[i])*a}}return s}}class R{constructor(){this.particles=[],this.maxParticles=200}createVictoryBurst(t,e,i=30){const s=["#6bcf7f","#00d4ff","#ffd93d","#ff6b6b"];for(let a=0;a<i;a++){const n=2*Math.PI*a/i,o=2+4*Math.random();this.particles.push({x:t,y:e,vx:Math.cos(n)*o,vy:Math.sin(n)*o,life:1,maxLife:1,radius:2+3*Math.random(),color:s[Math.floor(Math.random()*s.length)]})}this.limitParticles()}createStressParticles(t,e,i=5){for(let s=0;s<i;s++){const i=Math.random()*Math.PI*2,s=.5+1.5*Math.random();this.particles.push({x:t+20*(Math.random()-.5),y:e+20*(Math.random()-.5),vx:Math.cos(i)*s,vy:Math.sin(i)*s,life:1,maxLife:.8,radius:1+2*Math.random(),color:"#f44336"})}this.limitParticles()}createDustParticles(t,e,i=3){for(let s=0;s<i;s++)this.particles.push({x:t+30*(Math.random()-.5),y:e+10*Math.random(),vx:2*(Math.random()-.5),vy:.5*Math.random(),life:1,maxLife:.6,radius:1+2*Math.random(),color:"rgba(141, 110, 99, 0.6)"});this.limitParticles()}update(t=.016){this.particles=this.particles.filter(t=>t.life>0);for(let e of this.particles)e.x+=e.vx,e.y+=e.vy,e.vy+=.15,e.life-=t/e.maxLife}draw(t){for(let e of this.particles){const i=Math.max(0,e.life);t.globalAlpha=i,t.fillStyle=e.color,t.beginPath(),t.arc(e.x,e.y,e.radius,0,2*Math.PI),t.fill()}t.globalAlpha=1}limitParticles(){this.particles.length>this.maxParticles&&(this.particles=this.particles.slice(-this.maxParticles))}clear(){this.particles=[]}}class N{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.particleSystem=new R,this.prevCartX=0,this.resize(),window.addEventListener("resize",B(()=>this.resize(),150))}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.offscreenCanvas.width=t.width,this.offscreenCanvas.height=t.height}celebrateVictory(){const t=this.offscreenCanvas.width,e=this.offscreenCanvas.height;this.particleSystem.createVictoryBurst(t/2,e/2,40)}render(t){const p=this.offscreenCtx,g=this.offscreenCanvas.width,y=this.offscreenCanvas.height;this.particleSystem.update(),p.fillStyle="rgba(227, 242, 253, 0.5)",p.fillRect(0,0,g,y),p.fillStyle="#8d6e63",p.fillRect(0,y*l,g,y*(1-l)),p.strokeStyle="#555",p.lineWidth=2,p.beginPath(),p.moveTo(0,y*h),p.lineTo(g,y*h),p.stroke();const f=g/6,x=g/2-t.xThreshold*f,v=g/2+t.xThreshold*f;p.strokeStyle="#f44336",p.lineWidth=3,p.setLineDash([5,5]),p.beginPath(),p.moveTo(x,.5*y),p.lineTo(x,y*d),p.stroke(),p.beginPath(),p.moveTo(v,.5*y),p.lineTo(v,y*d),p.stroke(),p.setLineDash([]);const w=g/2+t.x*f,b=y*d,M=e,E=i;p.fillStyle="rgba(0, 0, 0, 0.15)",p.shadowColor="rgba(0, 0, 0, 0.3)",p.shadowBlur=8,p.shadowOffsetX=2,p.shadowOffsetY=3,p.fillRect(w-M/2,b-E,M,E),p.shadowColor="transparent",p.shadowBlur=0,p.shadowOffsetX=0,p.shadowOffsetY=0;const S=Math.abs(w-this.prevCartX);if(S>.5){p.fillStyle="rgba(25, 118, 210, 0.1)";const t=Math.min(15,S);p.fillRect(w+t-M/2,b-E,M,E)}p.fillStyle="#1976d2",p.fillRect(w-M/2,b-E,M,E),Math.abs(t.xDot)>.5&&this.particleSystem.createDustParticles(w,b,2),p.fillStyle="#333",p.beginPath(),p.arc(w-M/3,b,s,0,2*Math.PI),p.fill(),p.beginPath(),p.arc(w+M/3,b,s,0,2*Math.PI),p.fill();const I=2*t.length*f,A=w+I*Math.sin(t.theta),T=b-E-I*Math.cos(t.theta),k=Math.abs(t.theta)/t.thetaThreshold;let L="#4caf50";if(k>c?L="#f44336":k>u&&(L="#ff9800"),k>c&&this.particleSystem.createStressParticles(A,T,3),p.strokeStyle=L,p.lineWidth=6,p.lineCap="round",p.shadowColor="rgba(0, 0, 0, 0.2)",p.shadowBlur=6,p.shadowOffsetX=1,p.shadowOffsetY=2,p.beginPath(),p.moveTo(w,b-E),p.lineTo(A,T),p.stroke(),p.shadowColor="transparent",p.shadowBlur=0,p.shadowOffsetX=0,p.shadowOffsetY=0,p.fillStyle=L,p.beginPath(),p.arc(A,T,a,0,2*Math.PI),p.fill(),p.strokeStyle=L,p.lineWidth=2,p.globalAlpha=.5,p.beginPath(),p.arc(w,b-E,n,-Math.PI/2,-Math.PI/2+t.theta,t.theta>0),p.stroke(),p.globalAlpha=1,Math.abs(t.xDot)>.1){p.strokeStyle="#2196f3",p.lineWidth=4,p.beginPath(),p.moveTo(w,b-E/2);const e=o;p.lineTo(w+t.xDot*e,b-E/2),p.stroke();const i=t.xDot>0?0:Math.PI;p.beginPath(),p.moveTo(w+t.xDot*e,b-E/2),p.lineTo(w+t.xDot*e-Math.cos(i-Math.PI/6)*r,b-E/2-Math.sin(i-Math.PI/6)*r),p.lineTo(w+t.xDot*e-Math.cos(i+Math.PI/6)*r,b-E/2-Math.sin(i+Math.PI/6)*r),p.closePath(),p.fillStyle="#2196f3",p.fill()}this.particleSystem.draw(p),p.fillStyle="#333",p.font="bold 14px monospace",p.fillText(`Î¸: ${(180*t.theta/Math.PI).toFixed(1)}Â°`,10,20),p.fillText(`x: ${t.x.toFixed(2)}`,10,40),(Math.abs(t.x)>t.xThreshold*m||Math.abs(t.theta)>t.thetaThreshold*m)&&(p.fillStyle="#f44336",p.font="bold 16px sans-serif",p.fillText("âš ï¸ CRITICAL",g-120,30)),this.prevCartX=w,this.ctx.drawImage(this.offscreenCanvas,0,0)}}class ${constructor(t){this.svg=document.getElementById(t),this.resize(),window.addEventListener("resize",B(()=>this.resize(),150)),this.initializeSVG(),this.tooltip=null,this.layerSizes=[]}initializeSVG(){if(!this.svg.querySelector("defs")){const t=document.createElementNS("http://www.w3.org/2000/svg","defs"),e=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");e.setAttribute("id","input-gradient"),e.setAttribute("x1","0%"),e.setAttribute("y1","0%"),e.setAttribute("x2","100%"),e.setAttribute("y2","0%"),e.innerHTML='<stop offset="0%" style="stop-color:#e3f2fd;stop-opacity:0.3" /><stop offset="100%" style="stop-color:#e3f2fd;stop-opacity:0" />',t.appendChild(e);const i=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");i.setAttribute("id","hidden-gradient"),i.setAttribute("x1","0%"),i.setAttribute("y1","0%"),i.setAttribute("x2","100%"),i.setAttribute("y2","0%"),i.innerHTML='<stop offset="0%" style="stop-color:#f3e5f5;stop-opacity:0" /><stop offset="50%" style="stop-color:#f3e5f5;stop-opacity:0.2" /><stop offset="100%" style="stop-color:#f3e5f5;stop-opacity:0" />',t.appendChild(i);const s=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");s.setAttribute("id","output-gradient"),s.setAttribute("x1","0%"),s.setAttribute("y1","0%"),s.setAttribute("x2","100%"),s.setAttribute("y2","0%"),s.innerHTML='<stop offset="0%" style="stop-color:#f0f4c3;stop-opacity:0" /><stop offset="100%" style="stop-color:#f0f4c3;stop-opacity:0.3" />',t.appendChild(s),this.svg.appendChild(t)}if(!this.svg.querySelector("#layer-zones")){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("id","layer-zones"),this.svg.appendChild(t)}if(!this.svg.querySelector("#connections")){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("id","connections"),this.svg.appendChild(t)}if(!this.svg.querySelector("#nodes")){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("id","nodes"),this.svg.appendChild(t)}if(!this.svg.querySelector("#labels")){const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("id","labels"),this.svg.appendChild(t)}}resize(){const t=this.svg.getBoundingClientRect();this.width=t.width,this.height=t.height}getBezierPath(t,e,i,s){return`M ${t} ${e} Q ${(t+i)/2} ${(e+s)/2} ${i} ${s}`}visualize(t){const e=[{size:t.inputSize,label:"Input",type:"input"}];for(let d=0;d<t.hiddenSizes.length;d++)e.push({size:t.hiddenSizes[d],label:`Hidden ${d+1}`,type:"hidden",layerIdx:d});e.push({size:t.outputSize,label:"Actor",type:"actor"}),e.push({size:1,label:"Critic",type:"critic"}),this.layerSizes=e.map(t=>t.size),Math.max(...e.map(t=>t.size));const i=this.height-40,s=this.width/(e.length+1),a=e.map((t,e)=>{const a=s*(e+1),n=i/(t.size+1),o=20+n;return Array.from({length:t.size},(t,e)=>({x:a,y:o+e*n}))}),n=Math.max(...e.map(t=>t.size)),o=this.svg.querySelector("#connections"),r=this.svg.querySelector("#nodes"),l=this.svg.querySelector("#labels"),h=this.svg.querySelector("#layer-zones");o.innerHTML="",r.innerHTML="",l.innerHTML="",h.innerHTML="",e.forEach((t,e)=>{const i=s*(e+1),a=.8*s;let n="input-gradient";"hidden"===t.type?n="hidden-gradient":"actor"!==t.type&&"critic"!==t.type||(n="output-gradient");const o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",i-a/2),o.setAttribute("y",0),o.setAttribute("width",a),o.setAttribute("height",this.height),o.setAttribute("fill",`url(#${n})`),h.appendChild(o)});for(let d=0;d<e.length;d++){const i=e[d],s=[];if("input"===i.type){const i=e.find(t=>"hidden"===t.type&&0===t.layerIdx);i&&s.push({layer:i,weights:t.layers[0].w,idx:e.indexOf(i)})}else if("hidden"===i.type){const a=e.find(t=>"hidden"===t.type&&t.layerIdx===i.layerIdx+1);if(a)s.push({layer:a,weights:t.layers[a.layerIdx].w,idx:e.indexOf(a)});else{const i=e.find(t=>"actor"===t.type),a=e.find(t=>"critic"===t.type);i&&s.push({layer:i,weights:t.actorHead.w,idx:e.indexOf(i)}),a&&s.push({layer:a,weights:t.criticHead.w,idx:e.indexOf(a)})}}for(const t of s){const e=t.layer,s=t.idx,n=t.weights;for(let t=0;t<i.size;t++)for(let i=0;i<e.size;i++){const r=n[t][i],l=document.createElementNS("http://www.w3.org/2000/svg","path"),h=a[d][t].x,c=a[d][t].y,u=a[s][i].x,m=a[s][i].y;l.setAttribute("d",this.getBezierPath(h,c,u,m)),l.setAttribute("class","network-connection"),l.setAttribute("data-weight",r.toFixed(3));const p=Math.min(1,2*Math.abs(r));let g=r>0?"#4caf50":"#f44336";"critic"===e.type&&(g=r>0?"#2196f3":"#ff9800"),l.setAttribute("stroke",g),l.setAttribute("stroke-opacity",.3*p),l.setAttribute("stroke-width","1"),l.setAttribute("fill","none"),l.addEventListener("mouseenter",t=>this.showConnectionTooltip(t,r)),l.addEventListener("mouseleave",()=>this.hideTooltip()),o.appendChild(l)}}}e.forEach((e,i)=>{const o=4+6*(1-e.size/n);a[i].forEach((i,s)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",i.x),a.setAttribute("cy",i.y),a.setAttribute("r",o),a.setAttribute("class",`network-node network-node-${e.type}`);let n=0;"input"===e.type&&t.lastInput?n=t.lastInput[s]:"hidden"===e.type&&t.lastHidden[e.layerIdx]?n=t.lastHidden[e.layerIdx][s]:"actor"===e.type&&t.lastOutput?n=t.lastOutput[s]:"critic"===e.type&&(n=t.lastValue/100);const l=Math.min(1,Math.abs(n));let h="#667eea";"critic"===e.type?h="#2196f3":"actor"===e.type&&(h="#4caf50"),a.setAttribute("fill",h),a.setAttribute("fill-opacity",.3+.7*l),a.setAttribute("stroke","#333"),a.setAttribute("stroke-width","2"),a.setAttribute("data-activation",n.toFixed(3)),a.addEventListener("mouseenter",t=>this.showNodeTooltip(t,n,e.type)),a.addEventListener("mouseleave",()=>this.hideTooltip()),r.appendChild(a)});const h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",s*(i+1)),h.setAttribute("y",this.height-15),h.setAttribute("text-anchor","middle"),h.setAttribute("font-size","11"),h.setAttribute("font-weight","bold"),h.setAttribute("class","network-label"),"actor"===e.type?h.setAttribute("fill","#4caf50"):"critic"===e.type?h.setAttribute("fill","#2196f3"):h.setAttribute("fill","#666"),h.textContent=e.label,h.style.cursor="pointer",h.addEventListener("click",()=>this.showLayerStats(t,e,i)),l.appendChild(h)})}showNodeTooltip(t,e,i){const s=t.target,a=parseFloat(s.getAttribute("cx")),n=parseFloat(s.getAttribute("cy"));this.showTooltip(a,n,`Activation: ${e.toFixed(3)}`)}showConnectionTooltip(t,e){const i=t.target.getAttribute("d").match(/Q\s+([\d.]+)\s+([\d.]+)/);if(i){const t=parseFloat(i[1]),s=parseFloat(i[2]);this.showTooltip(t,s,`Weight: ${e.toFixed(3)}`)}}showTooltip(t,e,i){this.tooltip||(this.tooltip=document.createElementNS("http://www.w3.org/2000/svg","g"),this.tooltip.setAttribute("class","network-tooltip"),this.svg.appendChild(this.tooltip)),this.tooltip.innerHTML="";const s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",t-40),s.setAttribute("y",e-25),s.setAttribute("width","80"),s.setAttribute("height","20"),s.setAttribute("fill","#333"),s.setAttribute("rx","4"),s.setAttribute("ry","4");const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",t),a.setAttribute("y",e-10),a.setAttribute("text-anchor","middle"),a.setAttribute("font-size","10"),a.setAttribute("fill","white"),a.setAttribute("pointer-events","none"),a.textContent=i,this.tooltip.appendChild(s),this.tooltip.appendChild(a)}hideTooltip(){this.tooltip&&(this.tooltip.innerHTML="")}showLayerStats(t,e,i){let s=[];if("input"===e.type?s=t.layers[0].w.flat():"hidden"===e.type?s=e.layerIdx===t.hiddenSizes.length-1?t.actorHead.w.flat().concat(t.criticHead.w.flat()):t.layers[e.layerIdx+1].w.flat():"actor"===e.type?s=t.actorHead.w.flat():"critic"===e.type&&(s=t.criticHead.w.flat()),s.length>0){const t=s.reduce((t,e)=>t+e,0)/s.length,i=s.reduce((e,i)=>e+Math.pow(i-t,2),0)/s.length,a=Math.sqrt(i),n=Math.min(...s),o=Math.max(...s);console.log(`${e.label} Statistics:`,{mean:t.toFixed(4),std:a.toFixed(4),min:n.toFixed(4),max:o.toFixed(4)})}}animateLayerActivation(t){const e=this.svg.querySelector("#nodes");if(!e)return;let i=0;for(let o=0;o<t;o++)i+=this.layerSizes[o]||0;const s=i+(this.layerSizes[t]||0),a=e.querySelectorAll("circle");let n=0;a.forEach(t=>{t.classList.remove("active"),t.offsetWidth,n>=i&&n<s&&t.classList.add("active"),n++})}animateForwardPass(){const t=this.svg.querySelector("#nodes"),e=this.svg.querySelector("#connections");if(!t||!e)return;const i=Array.from(t.querySelectorAll("circle")),s=Array.from(e.querySelectorAll("path"));let a=0;i.forEach((t,e)=>{setTimeout(()=>{t.classList.remove("active"),t.offsetWidth,t.classList.add("active")},a),a+=100}),s.forEach(t=>{t.classList.remove("active")}),a=150,s.forEach(t=>{setTimeout(()=>{t.classList.add("active")},a),a+=50})}updateActivationIntensity(t,e){const i=this.svg.querySelector("#nodes");if(!i)return;const s=Array.from(i.querySelectorAll("circle"));let a=0;e.forEach((e,i)=>{const n=e.size;for(let o=0;o<n;o++){const i=s[a];if(!i)break;let n=0;"input"===e.type&&t.lastInput?n=t.lastInput[o]:"hidden"===e.type&&t.lastHidden[e.layerIdx]?n=t.lastHidden[e.layerIdx][o]:"actor"===e.type&&t.lastOutput?n=t.lastOutput[o]:"critic"===e.type&&(n=t.lastValue/100),i.classList.remove("high-activation","medium-activation","low-activation");const r=Math.abs(n);r>.7?i.classList.add("high-activation"):r>.3?i.classList.add("medium-activation"):i.classList.add("low-activation"),a++}})}}class q{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.data=[],this.maxDataPoints=100,this.mousePos=null,this.hoverPoint=null,this.resize(),window.addEventListener("resize",B(()=>this.resize(),150)),this.canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),this.canvas.addEventListener("mouseleave",()=>{this.mousePos=null,this.hoverPoint=null})}onMouseMove(t){const e=this.canvas.getBoundingClientRect();if(this.mousePos={x:t.clientX-e.left,y:t.clientY-e.top},this.data.length>0){const t=40,e=this.canvas.width,i=this.canvas.height,s=this.data.map(t=>t.reward),a=Math.min(...s),n=Math.max(...s)-a||1;let o=null,r=1/0;this.data.forEach((s,l)=>{const h=t+(e-2*t)*l/(this.data.length-1||1),d=t+(i-2*t)*(1-(s.reward-a)/n),c=Math.sqrt((this.mousePos.x-h)**2+(this.mousePos.y-d)**2);c<r&&c<15&&(r=c,o={...s,index:l,x:h,y:d})}),this.hoverPoint=o}}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}addDataPoint(t,e){this.data.push({episode:t,reward:e}),this.data.length>this.maxDataPoints&&this.data.shift(),this.render()}clear(){this.data=[],this.render()}render(){const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=40,a=P();if(t.fillStyle=a.background,t.fillRect(0,0,e,i),0===this.data.length)return t.fillStyle=a.textSecondary,t.font="14px sans-serif",t.textAlign="center",void t.fillText("Training data will appear here...",e/2,i/2);const n=this.data.map(t=>t.reward),o=Math.min(...n),r=Math.max(...n),l=r-o||1,h=this.data.map((t,a)=>({x:s+(e-80)*a/(this.data.length-1||1),y:s+(i-80)*(1-(t.reward-o)/l)}));t.strokeStyle=a.grid,t.lineWidth=1;for(let c=0;c<=5;c++){const n=s+(i-80)*c/5;t.beginPath(),t.moveTo(s,n),t.lineTo(e-s,n),t.stroke();const o=r-l*c/5;t.fillStyle=a.textSecondary,t.font="11px sans-serif",t.textAlign="right",t.fillText(o.toFixed(0),35,n+4)}const d=t.createLinearGradient(0,s,0,i-s);d.addColorStop(0,C(a.primary,.25)),d.addColorStop(1,C(a.primary,.02)),t.fillStyle=d,t.beginPath(),t.moveTo(h[0].x,h[0].y);for(let c=1;c<h.length;c++){const e={x:(h[c-1].x+h[c].x)/2,y:(h[c-1].y+h[c].y)/2};t.quadraticCurveTo(e.x,e.y,h[c].x,h[c].y)}t.lineTo(h[h.length-1].x,i-s),t.lineTo(h[0].x,i-s),t.closePath(),t.fill(),t.strokeStyle=a.primary,t.lineWidth=2,t.beginPath(),t.moveTo(h[0].x,h[0].y);for(let c=1;c<h.length;c++){const e={x:(h[c-1].x+h[c].x)/2,y:(h[c-1].y+h[c].y)/2};t.quadraticCurveTo(e.x,e.y,h[c].x,h[c].y)}if(t.stroke(),t.fillStyle=a.primary,this.data.forEach((a,n)=>{const r=s+(e-80)*n/(this.data.length-1||1),h=s+(i-80)*(1-(a.reward-o)/l);t.beginPath(),t.arc(r,h,3,0,2*Math.PI),t.fill()}),this.data.length>=10){const n=[];for(let t=9;t<this.data.length;t++){const a=this.data.slice(t-9,t+1).reduce((t,e)=>t+e.reward,0)/10;n.push({x:s+(e-80)*t/(this.data.length-1),y:s+(i-80)*(1-(a-o)/l)})}const r=t.createLinearGradient(0,s,0,i-s);r.addColorStop(0,C(a.secondary,.19)),r.addColorStop(1,C(a.secondary,.01)),t.fillStyle=r,t.beginPath(),t.moveTo(n[0].x,n[0].y);for(let e=1;e<n.length;e++){const i={x:(n[e-1].x+n[e].x)/2,y:(n[e-1].y+n[e].y)/2};t.quadraticCurveTo(i.x,i.y,n[e].x,n[e].y)}t.lineTo(n[n.length-1].x,i-s),t.lineTo(n[0].x,i-s),t.closePath(),t.fill(),t.strokeStyle=a.secondary,t.lineWidth=2,t.setLineDash([5,5]),t.beginPath(),t.moveTo(n[0].x,n[0].y);for(let e=1;e<n.length;e++){const i={x:(n[e-1].x+n[e].x)/2,y:(n[e-1].y+n[e].y)/2};t.quadraticCurveTo(i.x,i.y,n[e].x,n[e].y)}t.stroke(),t.setLineDash([])}if(t.fillStyle=a.textPrimary,t.font="12px sans-serif",t.textAlign="center",t.fillText("Episode",e/2,i-5),t.save(),t.translate(15,i/2),t.rotate(-Math.PI/2),t.fillText("Survival Time",0,0),t.restore(),t.textAlign="left",t.fillStyle=a.primary,t.fillRect(e-150,10,15,3),t.fillStyle=a.textSecondary,t.fillText("Episode Reward",e-130,15),t.fillStyle=a.secondary,t.fillRect(e-150,25,15,3),t.fillStyle=a.textSecondary,t.fillText("10-Ep Average",e-130,30),this.hoverPoint){const i=`Episode ${this.hoverPoint.episode}: ${this.hoverPoint.reward.toFixed(0)} steps`,s={width:t.measureText(i).width+12,height:24};let n=this.hoverPoint.x+10,o=this.hoverPoint.y-30;n+s.width>e&&(n=this.hoverPoint.x-s.width-10),o<10&&(o=this.hoverPoint.y+20),t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(n-2,o-s.height+4,s.width,s.height),t.strokeStyle=a.primary,t.lineWidth=1,t.strokeRect(n-2,o-s.height+4,s.width,s.height),t.fillStyle=a.textPrimary,t.font="11px sans-serif",t.textAlign="left",t.fillText(i,n+4,o-8),t.fillStyle=a.primary,t.beginPath(),t.arc(this.hoverPoint.x,this.hoverPoint.y,5,0,2*Math.PI),t.fill()}}}class O{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.actorLosses=[],this.criticLosses=[],this.resize(),window.addEventListener("resize",B(()=>this.resize(),150))}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}addDataPoint(t,e){this.actorLosses.push(t),this.criticLosses.push(e),this.actorLosses.length>200&&(this.actorLosses.shift(),this.criticLosses.shift()),this.draw()}draw(){const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=40,a=P();if(t.fillStyle=a.background,t.fillRect(0,0,e,i),0===this.actorLosses.length)return;const n=Math.max(...this.actorLosses,.1),o=Math.max(...this.criticLosses,.1),r=Math.max(n,o);t.strokeStyle=a.textSecondary,t.lineWidth=1,t.beginPath(),t.moveTo(s,i-s),t.lineTo(e-s,i-s),t.stroke(),t.beginPath(),t.moveTo(s,s),t.lineTo(s,i-s),t.stroke();const l=this.actorLosses.map((t,a)=>({x:s+a/(this.actorLosses.length-1||1)*(e-80),y:i-s-t/r*(i-80)})),h=this.criticLosses.map((t,a)=>({x:s+a/(this.criticLosses.length-1||1)*(e-80),y:i-s-t/r*(i-80)})),d=t.createLinearGradient(0,s,0,i-s);d.addColorStop(0,C(a.primary,.19)),d.addColorStop(1,C(a.primary,.02)),t.fillStyle=d,t.beginPath(),t.moveTo(l[0].x,l[0].y);for(let u=1;u<l.length;u++){const e={x:(l[u-1].x+l[u].x)/2,y:(l[u-1].y+l[u].y)/2};t.quadraticCurveTo(e.x,e.y,l[u].x,l[u].y)}t.lineTo(l[l.length-1].x,i-s),t.lineTo(l[0].x,i-s),t.closePath(),t.fill(),t.strokeStyle=a.primary,t.lineWidth=2,t.beginPath(),t.moveTo(l[0].x,l[0].y);for(let u=1;u<l.length;u++){const e={x:(l[u-1].x+l[u].x)/2,y:(l[u-1].y+l[u].y)/2};t.quadraticCurveTo(e.x,e.y,l[u].x,l[u].y)}t.stroke();const c=t.createLinearGradient(0,s,0,i-s);c.addColorStop(0,C(a.secondary,.19)),c.addColorStop(1,C(a.secondary,.02)),t.fillStyle=c,t.beginPath(),t.moveTo(h[0].x,h[0].y);for(let u=1;u<h.length;u++){const e={x:(h[u-1].x+h[u].x)/2,y:(h[u-1].y+h[u].y)/2};t.quadraticCurveTo(e.x,e.y,h[u].x,h[u].y)}t.lineTo(h[h.length-1].x,i-s),t.lineTo(h[0].x,i-s),t.closePath(),t.fill(),t.strokeStyle=a.secondary,t.lineWidth=2,t.beginPath(),t.moveTo(h[0].x,h[0].y);for(let u=1;u<h.length;u++){const e={x:(h[u-1].x+h[u].x)/2,y:(h[u-1].y+h[u].y)/2};t.quadraticCurveTo(e.x,e.y,h[u].x,h[u].y)}t.stroke(),t.fillStyle=a.textPrimary,t.font="12px sans-serif",t.fillText("0",20,i-s+5),t.fillText(r.toFixed(2),5,45),t.fillStyle=a.primary,t.fillRect(e-180,10,12,12),t.fillStyle=a.textSecondary,t.fillText("Actor Loss",e-160,20),t.fillStyle=a.secondary,t.fillRect(e-180,30,12,12),t.fillStyle=a.textSecondary,t.fillText("Critic Loss",e-160,40)}clear(){this.actorLosses=[],this.criticLosses=[],this.draw()}}class G{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.heatmapData=null,this.valueStats=null,this.lastUpdateEpisode=0,this.gridSize=30,this.xDim=0,this.yDim=2,this.xFixed=0,this.yFixed=0,this.dims=[{name:"Position",abbr:"x",min:-2.4,max:2.4,min_norm:-2.4,max_norm:E},{name:"Velocity",abbr:"áº‹",min:-3,max:3,min_norm:-4,max_norm:S},{name:"Angle",abbr:"Î¸",min:-.21,max:.21,min_norm:-.21,max_norm:I},{name:"Ang Velocity",abbr:"Î¸Ì‡",min:-2.5,max:2.5,min_norm:-4,max_norm:A}],this.resize(),window.addEventListener("resize",B(()=>this.resize(),150))}setDimensions(t,e){t!==e&&(this.xDim=t,this.yDim=e)}setFixedValues(t,e){this.xFixed=t,this.yFixed=e}setGridSize(t){this.gridSize=t}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}computeHeatmap(t,e){try{this.heatmapData=[];const i=[],s=this.dims[this.xDim],a=this.dims[this.yDim],n=s.min,o=s.max,r=a.min,l=a.max;for(let e=0;e<this.gridSize;e++){this.heatmapData[e]=[];for(let s=0;s<this.gridSize;s++){const a=n+(o-n)*(e/(this.gridSize-1)),h=r+(l-r)*(s/(this.gridSize-1)),d=[0,0,0,0];d[this.xDim]=a,d[this.yDim]=h,0!==this.xDim&&0!==this.yDim&&(d[0]=this.xFixed),1!==this.xDim&&1!==this.yDim&&(d[1]=this.yFixed),2!==this.xDim&&2!==this.yDim&&(d[2]=this.xFixed),3!==this.xDim&&3!==this.yDim&&(d[3]=this.yFixed);const c=[d[0]/E,d[1]/S,d[2]/I,d[3]/A],{value:u}=t.forward(c);this.heatmapData[e][s]=u,i.push(u)}}this.calculateValueStats(i),this.lastUpdateEpisode=e.episode||0}catch(i){console.error("Failed to compute heatmap:",i),this.heatmapData=null}this.draw()}calculateValueStats(t){t.sort((t,e)=>t-e);const e=t.length,i=t[Math.floor(.05*e)]||t[0],s=t[Math.floor(.5*e)]||t[Math.floor(e/2)],a=t[Math.floor(.95*e)]||t[e-1];this.valueStats={min:t[0],max:t[e-1],p5:i,p50:s,p95:a,range:a-i||1}}valueToColor(t){let e,i,s,a;if(this.valueStats){const i=this.valueStats.p50;e=t<i?-Math.abs((i-t)/(this.valueStats.p5-i))||0:(t-i)/(this.valueStats.p95-i)||0,e=Math.max(-1,Math.min(1,e))}else e=(t+50)/100;if(e<0){const t=1+e;i=Math.floor(255*t),s=Math.floor(200*t),a=255}else{const t=e;i=255,s=Math.floor(200*(1-t)),a=Math.floor(200*(1-t))}return`rgb(${i}, ${s}, ${a})`}draw(){const t=P();if(!this.heatmapData){const e=this.ctx;return e.fillStyle=t.background,e.fillRect(0,0,this.canvas.width,this.canvas.height),e.fillStyle=t.textSecondary,e.font="14px sans-serif",e.textAlign="center",void e.fillText("Train network to see state space values",this.canvas.width/2,this.canvas.height/2)}const e=this.ctx,i=this.canvas.width,s=this.canvas.height,a=this.heatmapData.length,n=45,o=(i-n-20-10)/a,r=(s-n-20)/a;for(let l=0;l<a;l++)for(let i=0;i<a;i++){const s=this.heatmapData[l][i],a=this.valueToColor(s);e.fillStyle=a,e.fillRect(n+l*o,10+i*r,o,r),e.strokeStyle=t.border,e.lineWidth=.5,e.strokeRect(n+l*o,10+i*r,o,r)}if(this.drawLegend(e,n+a*o+5,10,20,a*r,t),this.drawAnnotations(e,n,10,a*o,a*r),this.drawAxes(e,n,10,a*o,a*r,t),this.valueStats){e.fillStyle=t.textSecondary,e.font="11px sans-serif",e.textAlign="left";const i=s-6,a=`Value range: ${this.valueStats.min.toFixed(1)} to ${this.valueStats.max.toFixed(1)}  |  Updated: Episode ${this.lastUpdateEpisode}`;e.fillText(a,n,i)}}drawAnnotations(t,e,i,s,a){const n=this.dims[this.xDim],o=this.dims[this.yDim],r={0:[-2.4,2.4],1:[-3,3],2:[-.21,.21],3:[-2.5,2.5]},l=r[this.xDim],h=r[this.yDim];if(t.strokeStyle="rgba(244, 67, 54, 0.4)",t.lineWidth=2,t.setLineDash([4,4]),Math.abs(l[0])<Math.abs(n.max-n.min)/2){const o=e+(-l[0]-n.min)/(n.max-n.min)*s;t.beginPath(),t.moveTo(o,i),t.lineTo(o,i+a),t.stroke()}if(Math.abs(l[1])<Math.abs(n.max-n.min)/2){const o=e+(l[1]-n.min)/(n.max-n.min)*s;t.beginPath(),t.moveTo(o,i),t.lineTo(o,i+a),t.stroke()}if(Math.abs(h[0])<Math.abs(o.max-o.min)/2){const n=i+(o.max- -h[0])/(o.max-o.min)*a;t.beginPath(),t.moveTo(e,n),t.lineTo(e+s,n),t.stroke()}if(Math.abs(h[1])<Math.abs(o.max-o.min)/2){const n=i+(o.max-h[1])/(o.max-o.min)*a;t.beginPath(),t.moveTo(e,n),t.lineTo(e+s,n),t.stroke()}t.setLineDash([])}drawLegend(t,e,i,s,a,n){if(!this.valueStats)return;const o=256;for(let r=0;r<o;r++){const n=r/o*2-1,l=this.valueToColor(this.valueStats.p50+n*(this.valueStats.p95-this.valueStats.p5));t.fillStyle=l,t.fillRect(e,i+a*r/o,s,a/o+1)}t.strokeStyle=n.textPrimary,t.lineWidth=1,t.strokeRect(e,i,s,a),t.fillStyle=n.textPrimary,t.font="9px sans-serif",t.textAlign="left",t.fillText(this.valueStats.p5.toFixed(1),e+s+3,i+8),t.fillText(this.valueStats.p50.toFixed(1),e+s+3,i+a/2+3),t.fillText(this.valueStats.p95.toFixed(1),e+s+3,i+a-3)}drawAxes(t,e,i,s,a,n){const o=this.dims[this.xDim],r=this.dims[this.yDim];t.fillStyle=n.textPrimary,t.font="12px sans-serif",t.textAlign="center",t.fillText(o.name,e+s/2,i+a+30),t.save(),t.translate(15,i+a/2),t.rotate(-Math.PI/2),t.textAlign="center",t.fillText(r.name,0,0),t.restore(),t.font="9px sans-serif",t.textAlign="right",t.fillText(o.min.toFixed(2),e-5,i+a+10),t.fillText(o.max.toFixed(2),e+s+5,i+a+10)}clear(){this.heatmapData=null,this.valueStats=null,this.draw()}}class V{constructor(){this.metrics={gradNorm:0,avgAdvantage:0,avgReturn:0,avgQValue:0,entropy:0,leftAction:0,rightAction:0}}update(t){Object.assign(this.metrics,t)}render(){document.getElementById("metric-grad-norm")&&(document.getElementById("metric-grad-norm").textContent=this.metrics.gradNorm.toFixed(3)),document.getElementById("metric-advantage")&&(document.getElementById("metric-advantage").textContent=this.metrics.avgAdvantage.toFixed(3)),document.getElementById("metric-return")&&(document.getElementById("metric-return").textContent=this.metrics.avgReturn.toFixed(1)),document.getElementById("metric-qvalue")&&(document.getElementById("metric-qvalue").textContent=this.metrics.avgQValue.toFixed(2)),document.getElementById("metric-entropy")&&(document.getElementById("metric-entropy").textContent=this.metrics.entropy.toFixed(3)),document.getElementById("metric-left-action")&&(document.getElementById("metric-left-action").textContent=(100*this.metrics.leftAction).toFixed(0)+"%"),document.getElementById("metric-right-action")&&(document.getElementById("metric-right-action").textContent=(100*this.metrics.rightAction).toFixed(0)+"%")}}class U{constructor(t){this.size=t,this.mean=new Float32Array(t),this.m2=new Float32Array(t),this.count=0,this.variance=new Float32Array(t)}update(t){if(t.length===this.size){this.count++;for(let e=0;e<this.size;e++){const i=t[e]-this.mean[e];this.mean[e]+=i/this.count;const s=t[e]-this.mean[e];this.m2[e]+=i*s}if(this.count>1)for(let t=0;t<this.size;t++)this.variance[t]=this.m2[t]/(this.count-1)}else console.warn("RunningStats: value size mismatch")}getStd(){const t=new Float32Array(this.size);for(let e=0;e<this.size;e++)t[e]=Math.sqrt(this.variance[e]+1e-8);return t}normalize(t){const e=new Float32Array(this.size),i=this.getStd();for(let s=0;s<this.size;s++)e[s]=(t[s]-this.mean[s])/i[s];return e}reset(){this.mean.fill(0),this.m2.fill(0),this.variance.fill(0),this.count=0}}const W=new class{constructor(){this.currentTheme=localStorage.getItem("theme")||"dark",this.applyTheme(this.currentTheme),this.setupToggle()}setupToggle(){const t=document.getElementById("theme-toggle");t&&(t.addEventListener("click",()=>this.toggleTheme()),this.updateToggleIcon())}toggleTheme(){this.currentTheme="dark"===this.currentTheme?"light":"dark",this.applyTheme(this.currentTheme),localStorage.setItem("theme",this.currentTheme)}applyTheme(t){document.documentElement.setAttribute("data-theme",t),this.updateToggleIcon()}updateToggleIcon(){const t=document.getElementById("theme-toggle");if(!t)return;const e="dark"===this.currentTheme?"â˜€ï¸":"ðŸŒ™";t.textContent=e,t.title="dark"===this.currentTheme?"Switch to light mode":"Switch to dark mode"}getCurrentTheme(){return this.currentTheme}};window.themeManager=W;const j=new class{constructor(){this.env=new F,this.network=null,this.renderer=new N("cartpole-canvas"),this.visualizer=new $("network-svg"),this.chart=new q("training-chart"),this.lossChart=new O("training-loss-chart"),this.metricsDashboard=new V,this.heatmap=new G("state-space-heatmap"),this.isTraining=!1,this.isTesting=!1,this.isManual=!1,this.isPaused=!1,this.episode=0,this.survivalHistory=[],this.explorationHistory=[],this.currentTrajectory=[],this.manualAction=null,this.trainingSpeed=f,this.exploration=p,this.explorationDecay=g,this.minExploration=y,this.gaeLambda=x,this.frameCounter=0,this.initialLearningRate=parseFloat(document.getElementById("learning-rate").value),this.lastGradNorm=0,this.lastAvgAdvantage=0,this.lastAvgReturn=0,this.lastActorLoss=0,this.lastCriticLoss=0,this.stateStats=new U(4),this.useRunningStats=!0,this.lrSchedule="linear",this.maxEpisodes=5e3,this.episodesRun=0,this.initNetwork(),this.setupControls(),this.setupKeyboard(),this.setupGlobalKeyboardShortcuts(),this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay(),this.updateNetworkStats(),this.animate(),L("CartPole RL Sandbox initialized"),L("Using Actor-Critic with GAE (Î»=0.95) and Adam optimizer"),L("Network sees 4 inputs: position, velocity, angle, angular velocity"),L("Pole angle & angular velocity are MOST IMPORTANT for balancing!"),L("Watch Input Importance bars to see what the network focuses on"),L("Better exploration: Îµ starts at 0.20, decays slowly to 0.05"),L("Gradient norm and advantage metrics show training health")}normalizeState(t){return this.useRunningStats&&this.stateStats.count>10?this.stateStats.normalize(t):[t[0]/E,t[1]/S,t[2]/I,t[3]/A]}updateLearningRate(){let t=this.initialLearningRate;if("linear"===this.lrSchedule){const e=1-this.episodesRun/this.maxEpisodes*.9;t=this.initialLearningRate*e}else if("exponential"===this.lrSchedule){const e=.75*this.maxEpisodes;t=this.initialLearningRate*Math.exp(-this.episodesRun/e)}t=Math.max(1e-5,Math.min(.01,t)),this.network&&this.network.setLearningRate(t)}initNetwork(){const t=parseInt(document.getElementById("hidden-size").value),e=parseInt(document.getElementById("network-depth").value),i=document.getElementById("activation").value,s=Array(e).fill(t);this.network=new H(4,s,2,i),this.visualizer.visualize(this.network),L(`Network created: 4 â†’ ${s.join(" â†’ ")} â†’ 2 (Actor) + 1 (Critic)`),L(`Activation: ${i.toUpperCase()}, Optimizer: Adam`)}setupControls(){document.getElementById("train-btn").addEventListener("click",()=>this.toggleTraining()),document.getElementById("pause-btn").addEventListener("click",()=>this.togglePause()),document.getElementById("test-btn").addEventListener("click",()=>this.testPolicy()),document.getElementById("reset-btn").addEventListener("click",()=>this.resetPolicy()),document.getElementById("manual-btn").addEventListener("click",()=>this.toggleManual()),document.getElementById("copy-logs-btn").addEventListener("click",()=>async function(){const t=document.getElementById("log"),e=Array.from(t.querySelectorAll(".log-entry")).map(t=>t.textContent).join("\n");try{await navigator.clipboard.writeText(e);const t=document.getElementById("copy-logs-btn"),i=t.textContent;return t.textContent="Copied!",t.style.background="#ffff00",t.style.color="#000000",setTimeout(()=>{t.textContent=i,t.style.background="",t.style.color=""},1500),!0}catch(i){return console.error("Failed to copy logs:",i),!1}}()),document.getElementById("save-network-btn").addEventListener("click",()=>this.saveNetwork()),document.getElementById("load-network-btn").addEventListener("click",()=>this.loadNetwork()),document.getElementById("export-data-btn").addEventListener("click",()=>this.exportTrainingData()),document.getElementById("preset-quick").addEventListener("click",()=>this.applyPreset("quick")),document.getElementById("preset-deep").addEventListener("click",()=>this.applyPreset("deep")),document.getElementById("preset-exploration").addEventListener("click",()=>this.applyPreset("exploration")),document.getElementById("preset-production").addEventListener("click",()=>this.applyPreset("production")),document.getElementById("network-depth").addEventListener("change",()=>{this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("activation").addEventListener("change",()=>{this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("learning-rate").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<1e-4||e>.01)return z.error("Learning rate must be between 0.0001 and 0.01"),void(t.target.value="0.003");this.network.setLearningRate(e),L(`Learning rate updated to ${e}`)}),document.getElementById("discount").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<.9||e>1)return z.error("Discount factor must be between 0.9 and 1.0"),void(t.target.value="0.99")}),document.getElementById("lr-schedule").addEventListener("change",t=>{const e=t.target.value;this.lrSchedule=e;L(`Learning rate schedule: ${{none:"Fixed",linear:"Linear Decay",exponential:"Exponential Decay"}[e]}`)}),document.getElementById("hidden-size").addEventListener("change",t=>{const e=parseInt(t.target.value);if(e<16||e>256||e%8!=0)return z.error("Hidden layer size must be between 16 and 256 (multiples of 8)"),void(t.target.value="32");this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("entropy-coef").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<0||e>.1)return z.error("Entropy coefficient must be between 0 and 0.1"),void(t.target.value="0.02")}),document.getElementById("gae-lambda").addEventListener("input",t=>{this.gaeLambda=parseFloat(t.target.value),document.getElementById("gae-lambda-value").textContent=this.gaeLambda.toFixed(2)});document.getElementById("training-speed").addEventListener("input",t=>{this.trainingSpeed=parseInt(t.target.value),document.getElementById("speed-value").textContent=`${this.trainingSpeed}x`}),this.heatmapUpdateInterval=25,document.getElementById("heatmap-x-dim").addEventListener("change",t=>{const e=parseInt(t.target.value),i=parseInt(document.getElementById("heatmap-y-dim").value);if(e===i)return z.error("X and Y dimensions cannot be the same"),void(t.target.value="0");this.heatmap.setDimensions(e,i),this.heatmap.heatmapData&&this.heatmap.computeHeatmap(this.network,this.env)}),document.getElementById("heatmap-y-dim").addEventListener("change",t=>{const e=parseInt(t.target.value),i=parseInt(document.getElementById("heatmap-x-dim").value);if(i===e)return z.error("X and Y dimensions cannot be the same"),void(t.target.value="2");this.heatmap.setDimensions(i,e),this.heatmap.heatmapData&&this.heatmap.computeHeatmap(this.network,this.env)}),document.getElementById("heatmap-resolution").addEventListener("change",t=>{const e=parseInt(t.target.value);this.heatmap.setGridSize(e),this.heatmap.heatmapData&&this.heatmap.computeHeatmap(this.network,this.env)}),document.getElementById("heatmap-refresh-btn").addEventListener("click",()=>{this.heatmap.computeHeatmap(this.network,this.env),z.success("Heatmap refreshed")}),document.getElementById("heatmap-update-interval").addEventListener("input",t=>{this.heatmapUpdateInterval=parseInt(t.target.value),document.getElementById("update-interval-value").textContent=this.heatmapUpdateInterval})}setupKeyboard(){document.addEventListener("keydown",t=>{this.isManual&&("ArrowLeft"===t.key||"a"===t.key||"A"===t.key?(this.manualAction=0,t.preventDefault()):"ArrowRight"!==t.key&&"d"!==t.key&&"D"!==t.key||(this.manualAction=1,t.preventDefault()))});const t=document.getElementById("touch-left"),e=document.getElementById("touch-right");t&&(t.addEventListener("touchstart",()=>{this.isManual&&(this.manualAction=0)}),t.addEventListener("touchend",()=>{this.isManual&&(this.manualAction=null)}),t.addEventListener("mousedown",()=>{this.isManual&&(this.manualAction=0)}),t.addEventListener("mouseup",()=>{this.isManual&&(this.manualAction=null)})),e&&(e.addEventListener("touchstart",()=>{this.isManual&&(this.manualAction=1)}),e.addEventListener("touchend",()=>{this.isManual&&(this.manualAction=null)}),e.addEventListener("mousedown",()=>{this.isManual&&(this.manualAction=1)}),e.addEventListener("mouseup",()=>{this.isManual&&(this.manualAction=null)}))}setMode(t){const e=document.getElementById("mode-indicator");e.textContent=t,e.className="mode-indicator "+({IDLE:"",TRAINING:"mode-training",TESTING:"mode-testing",MANUAL:"mode-manual"}[t]||"")}toggleManual(){if(this.isTraining||this.isTesting)return;this.isManual=!this.isManual;const t=document.getElementById("manual-btn"),e=document.getElementById("keyboard-hint"),i=document.getElementById("touch-controls");this.isManual?(t.textContent="Stop Manual",t.className="secondary",e.style.display="block",i.style.display="flex",this.setMode("MANUAL"),this.env.reset(),L("Manual control enabled - use arrow keys, A/D, or touch buttons"),this.manualLoop()):(t.textContent="Manual Control",t.className="secondary",e.style.display="none",i.style.display="none",this.setMode("IDLE"),L("Manual control disabled"))}async manualLoop(){for(;this.isManual;){if(null!==this.manualAction){const t=this.env.step(this.manualAction),e=this.env.getState();this.network.forward(this.normalizeState(e)),t.done&&(L(`Episode ended: survived ${this.env.steps} steps`),await new Promise(t=>setTimeout(t,1e3)),this.env.reset()),this.manualAction=null}this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay(),this.visualizer.visualize(this.network),await new Promise(t=>setTimeout(t,20))}}toggleTraining(){this.isManual&&this.toggleManual(),this.isTraining=!this.isTraining;const t=document.getElementById("train-btn"),e=document.getElementById("pause-btn");this.isTraining?(t.textContent="Stop Training",t.className="danger",e.style.display="block",e.textContent="Pause",this.isPaused=!1,this.setMode("TRAINING"),L("Training started"),this.trainingLoop()):(t.textContent="Start Training",t.className="primary",e.style.display="none",this.isPaused=!1,this.setMode("IDLE"),L("Training stopped"))}togglePause(){this.isPaused=!this.isPaused;const t=document.getElementById("pause-btn");this.isPaused?(t.textContent="Resume",L("Training paused - inspect metrics without losing progress")):(t.textContent="Pause",L("Training resumed"))}async trainingLoop(){for(;this.isTraining;){if(this.isPaused){await new Promise(t=>setTimeout(t,100));continue}await this.runEpisode(!0);const t=Math.max(1,50-5*this.trainingSpeed);await new Promise(e=>setTimeout(e,t))}}async runEpisode(t=!1){const e=this.env.reset();this.currentTrajectory=[];let i=!1;const s=t?Math.max(0,3-.3*this.trainingSpeed):20;for(;!i&&(this.isTraining||this.isTesting);){const a=this.normalizeState(e);t&&this.stateStats.update(e);const n=t?this.network.selectAction(a,this.exploration):this.network.selectAction(a,0),o=this.network.lastOutput?this.network.lastOutput[n]:1/this.network.outputSize,r=this.env.step(n),l=r.done?0:1;this.currentTrajectory.push({state:[...a],action:n,prob:o,reward:l}),Object.assign(e,r.state),i=r.done,this.frameCounter%v===0&&(this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay()),this.frameCounter%w===0&&this.visualizer.visualize(this.network),this.frameCounter++,await new Promise(t=>setTimeout(t,s))}if(t&&this.currentTrajectory.length>0){this.episodesRun++;const t=parseFloat(document.getElementById("discount").value),e=parseFloat(document.getElementById("entropy-coef").value);this.updateLearningRate();const i=this.network.update(this.currentTrajectory,t,e,1,2,this.gaeLambda);if(this.lastGradNorm=i.gradNorm,this.lastAvgAdvantage=i.avgAdvantage,this.lastAvgReturn=i.avgReturn,this.lastActorLoss=i.actorLoss,this.lastCriticLoss=i.criticLoss,this.lossChart.addDataPoint(i.actorLoss,i.criticLoss),this.metricsDashboard.update({gradNorm:i.gradNorm,avgAdvantage:i.avgAdvantage,avgReturn:i.avgReturn}),this.metricsDashboard.render(),this.episode%this.heatmapUpdateInterval===0)try{this.heatmap.computeHeatmap(this.network,this.env)}catch(a){}this.exploration=Math.max(this.minExploration,this.exploration*this.explorationDecay)}if(this.episode++,this.survivalHistory.push(this.env.steps),this.explorationHistory.push(this.exploration),this.survivalHistory.length>b&&(this.survivalHistory.shift(),this.explorationHistory.shift()),this.chart.addDataPoint(this.episode,this.env.steps),this.env.steps>=500&&this.triggerVictoryAnimation(),this.episode%M===0){const t=this.survivalHistory.slice(-10).reduce((t,e)=>t+e,0)/Math.min(T,this.survivalHistory.length),e=this.survivalHistory.length>0?Math.max(...this.survivalHistory):0;let i=this.initialLearningRate;if("linear"===this.lrSchedule){const t=1-this.episodesRun/this.maxEpisodes*.9;i=this.initialLearningRate*t}else if("exponential"===this.lrSchedule){const t=.75*this.maxEpisodes;i=this.initialLearningRate*Math.exp(-this.episodesRun/t)}const s=this.network.getEntropy(),a=void 0!==this.network.lastValue?this.network.lastValue:0,n=this.stateStats.count;L(`Ep ${this.episode}: Steps=${this.env.steps} (Avg=${t.toFixed(1)}, Best=${e}) | Îµ=${this.exploration.toFixed(3)}, LR=${i.toExponential(2)}, Stats=${n} | Loss: A=${this.lastActorLoss.toFixed(3)}, C=${this.lastCriticLoss.toFixed(3)} | H=${s.toFixed(3)}, V=${a.toFixed(1)} | |âˆ‡|=${this.lastGradNorm.toFixed(2)}`)}this.updateNetworkStats()}async testPolicy(){this.isTraining&&this.toggleTraining(),this.isManual&&this.toggleManual(),this.isTesting=!0,this.setMode("TESTING");const t=document.getElementById("test-btn");t.disabled=!0,L("Testing current policy..."),await this.runEpisode(!1),L(`Test complete: survived ${this.env.steps} steps`),this.isTesting=!1,this.setMode("IDLE"),t.disabled=!1,this.updateStateDisplay()}resetPolicy(){this.isTraining=!1,this.isTesting=!1,this.isManual&&this.toggleManual(),document.getElementById("train-btn").textContent="Start Training",document.getElementById("train-btn").className="primary",this.setMode("IDLE"),this.episode=0,this.episodesRun=0,this.survivalHistory=[],this.explorationHistory=[],this.exploration=p,this.stateStats.reset(),this.chart.clear(),this.lossChart.clear(),this.heatmap.clear(),this.initNetwork(),this.env.reset(),this.updateMetrics(),this.updateStateDisplay(),this.updateNetworkStats(),L("Policy reset - exploration reset to 0.2 with GAE enabled, running stats cleared")}updateActionBars(){if(this.network.lastOutput){const t=this.network.lastOutput,e=(100*t[0]).toFixed(1);document.getElementById("action-left").style.transform=`scaleY(${t[0]})`,document.getElementById("action-left-val").textContent=e+"%";const i=(100*t[1]).toFixed(1);document.getElementById("action-right").style.transform=`scaleY(${t[1]})`,document.getElementById("action-right-val").textContent=i+"%"}}updateStateDisplay(){const t=this.env.getState(),[e,i,s,a]=t,n=E,o=S,r=I,l=A,h=Math.min(1,Math.abs(e)/n);document.getElementById("perception-x-val").textContent=e.toFixed(2),document.getElementById("perception-x-bar").style.width=100*h+"%",document.getElementById("perception-x").classList.toggle("active",h>.6);const d=Math.min(1,Math.abs(i)/o);document.getElementById("perception-xdot-val").textContent=i.toFixed(2),document.getElementById("perception-xdot-bar").style.width=100*d+"%",document.getElementById("perception-xdot").classList.toggle("active",d>.4);const m=180*s/Math.PI,p=Math.min(1,Math.abs(s)/r);document.getElementById("perception-theta-val").textContent=m.toFixed(1)+"Â°",document.getElementById("perception-theta-bar").style.width=100*p+"%",document.getElementById("perception-theta").classList.add("active");const g=Math.min(1,Math.abs(a)/l);document.getElementById("perception-thetadot-val").textContent=a.toFixed(2),document.getElementById("perception-thetadot-bar").style.width=100*g+"%",document.getElementById("perception-thetadot").classList.add("active");const y=50+s/r*50;document.getElementById("theta-bar").style.width=Math.max(0,Math.min(100,y))+"%",document.getElementById("theta-value").textContent=m.toFixed(1)+"Â°";const f=50+a/l*50;document.getElementById("thetadot-bar").style.width=Math.max(0,Math.min(100,f))+"%",document.getElementById("thetadot-value").textContent=a.toFixed(2),document.getElementById("value-x").textContent=e.toFixed(2);const x=50+e/n*50;document.getElementById("indicator-x").style.width=Math.max(0,Math.min(100,x))+"%",document.getElementById("indicator-x").className="state-indicator"+(h>.6?" danger":""),document.getElementById("value-xdot").textContent=i.toFixed(2);const v=50+i/o*50;document.getElementById("indicator-xdot").style.width=Math.max(0,Math.min(100,v))+"%",document.getElementById("indicator-xdot").className="state-indicator"+(d>.4?" warning":""),document.getElementById("value-theta").textContent=m.toFixed(1);const w=50+s/r*50;document.getElementById("indicator-theta").style.width=Math.max(0,Math.min(100,w))+"%",document.getElementById("indicator-theta").className="state-indicator"+(p>c?" danger":p>u?" warning":""),document.getElementById("value-thetadot").textContent=a.toFixed(2);const b=50+a/l*50;document.getElementById("indicator-thetadot").style.width=Math.max(0,Math.min(100,b))+"%",document.getElementById("indicator-thetadot").className="state-indicator"+(g>.5?" warning":"");const M=this.network.getInputImportance(this.normalizeState(t)),T=Math.max(...M,.001),k=M[0]/T*100,L=M[1]/T*100,B=M[2]/T*100,C=M[3]/T*100;document.getElementById("importance-x-bar").style.width=k+"%",document.getElementById("importance-x-val").textContent=k.toFixed(0)+"%",document.getElementById("importance-xdot-bar").style.width=L+"%",document.getElementById("importance-xdot-val").textContent=L.toFixed(0)+"%",document.getElementById("importance-theta-bar").style.width=B+"%",document.getElementById("importance-theta-val").textContent=B.toFixed(0)+"%",document.getElementById("importance-thetadot-bar").style.width=C+"%",document.getElementById("importance-thetadot-val").textContent=C.toFixed(0)+"%"}updateNetworkStats(){let t=0,e=0;for(const n of this.network.layers)for(let i=0;i<n.w.length;i++)for(let s=0;s<n.w[i].length;s++)t+=Math.abs(n.w[i][s]),e++;const i=e>0?t/e:0,s=this.network.getAvgWeight(this.network.actorHead.w),a=this.network.getEntropy();document.getElementById("avg-w1").textContent=i.toFixed(3),document.getElementById("avg-w2").textContent=s.toFixed(3),document.getElementById("entropy").textContent=a.toFixed(3),document.getElementById("exploration-rate").textContent=this.exploration.toFixed(3),document.getElementById("grad-norm").textContent=this.lastGradNorm?this.lastGradNorm.toFixed(2):"0.00",document.getElementById("avg-advantage").textContent=this.lastAvgAdvantage?this.lastAvgAdvantage.toFixed(2):"0.00"}updateMetrics(){if(document.getElementById("episode-count").textContent=this.episode,document.getElementById("steps-count").textContent=this.env.steps,document.getElementById("reward-count").textContent=this.env.steps,void 0!==this.network.lastValue&&(document.getElementById("value-estimate").textContent=this.network.lastValue.toFixed(1)),this.survivalHistory.length>0){const t=this.survivalHistory[this.survivalHistory.length-1],e=Math.max(...this.survivalHistory),i=this.survivalHistory.slice(-10).reduce((t,e)=>t+e,0)/Math.min(10,this.survivalHistory.length);document.getElementById("last-survival").textContent=t,document.getElementById("best-survival").textContent=e,document.getElementById("avg-survival").textContent=i.toFixed(1)}else document.getElementById("last-survival").textContent="0",document.getElementById("best-survival").textContent="0",document.getElementById("avg-survival").textContent="0"}saveNetwork(){const t={timestamp:(new Date).toISOString(),episode:this.episode,survivalHistory:this.survivalHistory,network:{layers:this.network.layers.map(t=>({w:t.w,b:t.b})),actorHead:{w:this.network.actorHead.w,b:this.network.actorHead.b},criticHead:{w:this.network.criticHead.w,b:this.network.criticHead.b},hiddenSizes:this.network.hiddenSizes,activation:this.network.activation},hyperparameters:{learningRate:parseFloat(document.getElementById("learning-rate").value),discount:parseFloat(document.getElementById("discount").value),entropy:parseFloat(document.getElementById("entropy-coef").value),hiddenSize:parseInt(document.getElementById("hidden-size").value),networkDepth:parseInt(document.getElementById("network-depth").value)}},e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),a=document.createElement("a");a.href=s,a.download=`cartpole-network-${t.timestamp.substring(0,10)}.json`,a.click(),URL.revokeObjectURL(s),z.success(`Network saved! Trained for ${this.episode} episodes`),L(`Saved network with ${this.episode} episodes of training`)}loadNetwork(){const t=document.createElement("input");t.type="file",t.accept="application/json",t.onchange=t=>{const e=t.target.files[0];if(!e)return;const i=new FileReader;i.onload=t=>{try{const e=JSON.parse(t.target.result);if(e.hyperparameters&&(document.getElementById("learning-rate").value=e.hyperparameters.learningRate,document.getElementById("discount").value=e.hyperparameters.discount,document.getElementById("entropy-coef").value=e.hyperparameters.entropy,document.getElementById("hidden-size").value=e.hyperparameters.hiddenSize,document.getElementById("network-depth").value=e.hyperparameters.networkDepth),this.initNetwork(),e.network&&e.network.activation&&(this.network.activation=e.network.activation,document.getElementById("activation").value=e.network.activation),e.network&&e.network.layers){for(let t=0;t<e.network.layers.length;t++)this.network.layers[t].w=e.network.layers[t].w,this.network.layers[t].b=e.network.layers[t].b;this.network.actorHead.w=e.network.actorHead.w,this.network.actorHead.b=e.network.actorHead.b,this.network.criticHead.w=e.network.criticHead.w,this.network.criticHead.b=e.network.criticHead.b}this.visualizer.visualize(this.network),z.success(`Network loaded! ${e.episode} episodes of training restored`),L(`Loaded network trained for ${e.episode} episodes`)}catch(e){z.error("Failed to load network: "+e.message),L("Error loading network: "+e.message)}},i.readAsText(e)},t.click()}exportTrainingData(){let t="Episode,Survival_Steps,Actor_Loss,Critic_Loss,Exploration_Rate\n";for(let a=0;a<this.survivalHistory.length;a++)t+=`${a+1},${this.survivalHistory[a]},${this.lossChart.actorLosses[a]||0},${this.lossChart.criticLosses[a]||0},${this.explorationHistory[a]||0}\n`;const e=new Blob([t],{type:"text/csv"}),i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download=`cartpole-training-${(new Date).toISOString().substring(0,10)}.csv`,s.click(),URL.revokeObjectURL(i),z.success(`Training data exported (${this.episode} episodes)`),L(`Exported training data: ${this.episode} episodes`)}applyPreset(t){const e={quick:{lr:.005,discount:.99,entropy:.02,hidden:32,depth:1,speed:8},deep:{lr:.003,discount:.99,entropy:.015,hidden:64,depth:2,speed:1},exploration:{lr:.002,discount:.95,entropy:.05,hidden:32,depth:1,speed:3},production:{lr:.001,discount:.99,entropy:.01,hidden:128,depth:2,speed:1}}[t];if(!e)return void z.error("Unknown preset: "+t);document.getElementById("learning-rate").value=e.lr,document.getElementById("discount").value=e.discount,document.getElementById("entropy-coef").value=e.entropy,document.getElementById("hidden-size").value=e.hidden,document.getElementById("network-depth").value=e.depth,this.trainingSpeed=e.speed,document.getElementById("training-speed").value=e.speed,this.initNetwork(),this.heatmap.clear(),this.lossChart.clear();z.success(`Preset loaded: ${{quick:"âš¡ Quick Train",deep:"ðŸ§  Deep Learn",exploration:"ðŸ” Exploration",production:"ðŸ­ Production"}[t]}`),L(`Applied ${t} preset`)}setupGlobalKeyboardShortcuts(){document.addEventListener("keydown",t=>{if("INPUT"!==document.activeElement.tagName)switch(t.key){case" ":t.preventDefault(),this.toggleTraining();break;case"t":case"T":this.isTraining||this.isManual||this.testPolicy();break;case"r":case"R":this.resetPolicy();break;case"s":case"S":this.isTraining||this.isTesting||this.isManual||this.saveNetwork();break;case"l":case"L":this.isTraining||this.isTesting||this.isManual||this.loadNetwork();break;case"m":case"M":this.isTraining||this.isTesting||this.toggleManual();break;case"p":case"P":this.isTraining&&this.togglePause()}},{passive:!1})}triggerVictoryAnimation(){const t=this.renderer.canvas;t.classList.add("victory-animation"),this.renderer.celebrateVictory(),setTimeout(()=>{t.classList.remove("victory-animation")},1e3),z.success("ðŸŽ‰ Episode Success! Survived 500 steps!")}animate(){(this.isTraining||this.isTesting||this.isManual)&&this.renderer.render(this.env),requestAnimationFrame(()=>this.animate())}};window.sandbox=j,L("CartPole RL Sandbox initialized successfully");
