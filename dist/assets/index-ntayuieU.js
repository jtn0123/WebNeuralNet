!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const t=50,e=50,i=30,s=8,n=10,a=30,o=20,r=8,l=.7,h=.7,d=.7,c=.7,u=.4,m=.7,g=.2,p=.998,y=.05,v=5,w=.95,f=3,x=100,b=10,E=2.4,I=4,M=.21,k=4,B=10;function A(t){return t[0]&&"number"==typeof t[0].length?t.map(t=>new Float32Array(t.length)):new Float32Array(t.length)}function T(e){const i=document.getElementById("log"),s=document.createElement("div");for(s.className="log-entry",s.textContent=`[${(new Date).toLocaleTimeString()}] ${e}`,i.appendChild(s),i.scrollTop=i.scrollHeight;i.children.length>t;)i.removeChild(i.firstChild)}class L{static show(t,e="info",i=3e3){const s=document.createElement("div");s.className=`toast toast-${e}`,s.textContent=t,s.style.cssText=`\n            position: fixed;\n            bottom: 20px;\n            right: 20px;\n            background: ${"success"===e?"#4caf50":"error"===e?"#f44336":"#667eea"};\n            color: white;\n            padding: 12px 20px;\n            border-radius: 6px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n            z-index: 10000;\n            font-size: 14px;\n            animation: slideIn 0.3s ease;\n        `,document.body.appendChild(s),setTimeout(()=>{s.style.animation="slideOut 0.3s ease",setTimeout(()=>s.remove(),300)},i)}static success(t){this.show(t,"success")}static error(t){this.show(t,"error")}static info(t){this.show(t,"info")}}if(!document.querySelector("style[data-toast-animations]")){const t=document.createElement("style");t.setAttribute("data-toast-animations","true"),t.textContent="\n        @keyframes slideIn {\n            from { transform: translateX(400px); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n        @keyframes slideOut {\n            from { transform: translateX(0); opacity: 1; }\n            to { transform: translateX(400px); opacity: 0; }\n        }\n    ",document.head.appendChild(t)}class S{constructor(){this.gravity=9.8,this.massCart=1,this.massPole=.1,this.totalMass=this.massCart+this.massPole,this.length=.5,this.poleMassLength=this.massPole*this.length,this.forceMag=10,this.tau=.02,this.thetaThreshold=12*Math.PI/180,this.xThreshold=2.4,this.reset()}reset(){return this.x=.1*(Math.random()-.5),this.xDot=.1*(Math.random()-.5),this.theta=.1*(Math.random()-.5),this.thetaDot=.1*(Math.random()-.5),this.steps=0,this.getState()}getState(){return[this.x,this.xDot,this.theta,this.thetaDot]}step(t){const e=1===t?this.forceMag:-this.forceMag,i=Math.cos(this.theta),s=Math.sin(this.theta),n=(e+this.poleMassLength*this.thetaDot*this.thetaDot*s)/this.totalMass,a=(this.gravity*s-i*n)/(this.length*(4/3-this.massPole*i*i/this.totalMass)),o=n-this.poleMassLength*a*i/this.totalMass;this.x+=this.tau*this.xDot,this.xDot+=this.tau*o,this.theta+=this.tau*this.thetaDot,this.thetaDot+=this.tau*a,this.steps++;const r=this.x<-this.xThreshold||this.x>this.xThreshold||this.theta<-this.thetaThreshold||this.theta>this.thetaThreshold||this.steps>=500,l=r?0:1;return{state:this.getState(),reward:l,done:r}}}class C{constructor(t,e=.001,i=.9,s=.999,n=1e-8){this.learningRate=e,this.beta1=i,this.beta2=s,this.epsilon=n,this.t=0,this.m=A(t),this.v=A(t)}update(t,e){if(this.t++,t[0]&&"number"==typeof t[0].length)for(let i=0;i<t.length;i++)for(let s=0;s<t[i].length;s++){this.m[i][s]=this.beta1*this.m[i][s]+(1-this.beta1)*e[i][s],this.v[i][s]=this.beta2*this.v[i][s]+(1-this.beta2)*e[i][s]*e[i][s];const n=this.m[i][s]/(1-Math.pow(this.beta1,this.t)),a=this.v[i][s]/(1-Math.pow(this.beta2,this.t));t[i][s]-=this.learningRate*n/(Math.sqrt(a)+this.epsilon)}else for(let i=0;i<t.length;i++){this.m[i]=this.beta1*this.m[i]+(1-this.beta1)*e[i],this.v[i]=this.beta2*this.v[i]+(1-this.beta2)*e[i]*e[i];const s=this.m[i]/(1-Math.pow(this.beta1,this.t)),n=this.v[i]/(1-Math.pow(this.beta2,this.t));t[i]-=this.learningRate*s/(Math.sqrt(n)+this.epsilon)}}}class z{constructor(t,e,i,s="relu"){this.inputSize=t,this.hiddenSizes=Array.isArray(e)?e:[e],this.outputSize=i,this.activation=s,this.layers=[];let n=t;for(const a of this.hiddenSizes)this.layers.push({w:this.heInitialize(n,a),b:new Float32Array(a),type:"hidden"}),n=a;this.actorHead={w:this.heInitialize(n,i),b:new Float32Array(i)},this.criticHead={w:this.heInitialize(n,1),b:new Float32Array(1)},this.optimizers={layers:[],actor:{w:new C(this.actorHead.w),b:new C(this.actorHead.b)},critic:{w:new C(this.criticHead.w),b:new C(this.criticHead.b)}};for(const a of this.layers)this.optimizers.layers.push({w:new C(a.w),b:new C(a.b)});this.lastInput=null,this.lastHidden=[],this.lastOutput=null,this.lastValue=0}heInitialize(t,e){const i=Math.sqrt(6/t),s=[];for(let n=0;n<t;n++){s[n]=new Float32Array(e);for(let t=0;t<e;t++)s[n][t]=2*(Math.random()-.5)*i}return s}activate(t,e=!1){switch(this.activation){case"relu":default:return e?t>0?1:0:Math.max(0,t);case"tanh":if(e){const e=Math.tanh(t);return 1-e*e}return Math.tanh(t);case"elu":const i=1;return e?t>0?1:i*Math.exp(t):t>0?t:i*(Math.exp(t)-1);case"swish":const s=1/(1+Math.exp(-t));return e?s+t*s*(1-s):t*s}}softmax(t){const e=Math.max(...t),i=new Float32Array(t.length);let s=0;for(let a=0;a<t.length;a++)i[a]=Math.exp(t[a]-e),s+=i[a];const n=new Float32Array(t.length);for(let a=0;a<t.length;a++)n[a]=i[a]/s;return n}forward(t){this.lastInput=new Float32Array(t),this.lastHidden=[],this.lastPreActivation=[];let e=t;for(let n=0;n<this.layers.length;n++){const t=this.layers[n],i=new Float32Array(t.b.length),s=new Float32Array(t.b.length);for(let n=0;n<t.b.length;n++){let a=t.b[n];for(let i=0;i<e.length;i++)a+=e[i]*t.w[i][n];s[n]=a,i[n]=this.activate(a)}this.lastPreActivation.push(new Float32Array(s)),this.lastHidden.push(new Float32Array(i)),e=i}const i=new Float32Array(this.outputSize);for(let n=0;n<this.outputSize;n++){let t=this.actorHead.b[n];for(let i=0;i<e.length;i++)t+=e[i]*this.actorHead.w[i][n];i[n]=t}this.lastOutput=this.softmax(i);let s=this.criticHead.b[0];for(let n=0;n<e.length;n++)s+=e[n]*this.criticHead.w[n][0];return this.lastValue=s,{policy:this.lastOutput,value:this.lastValue}}selectAction(t,e=0){const{policy:i}=this.forward(t);if(e>0&&Math.random()<e)return Math.random()<.5?0:1;const s=Math.random();let n=0;for(let a=0;a<i.length;a++)if(n+=i[a],s<n)return a;return i.length-1}getEntropy(){if(!this.lastOutput)return 0;let t=0;for(let e=0;e<this.lastOutput.length;e++){const i=this.lastOutput[e];i>0&&(t-=i*Math.log(i))}return t}getAvgWeight(t){let e=0,i=0;for(let s=0;s<t.length;s++)for(let n=0;n<t[s].length;n++)e+=Math.abs(t[s][n]),i++;return i>0?e/i:0}update(t,e,i=.01,s=.1,n=1,a=.95){const o=[],r=[],l=[];let h=0,d=0;for(let E=0;E<t.length;E++){const{value:e}=this.forward(t[E].state);r.push(e)}let c=0;for(let E=t.length-1;E>=0;E--){const i=t[E].reward,s=r[E];c=i+e*(E<t.length-1?r[E+1]:0)-s+e*a*c,l.unshift(c),o.unshift(c+s)}const u=l.reduce((t,e)=>t+e,0)/l.length,m=Math.sqrt(l.reduce((t,e)=>t+(e-u)**2,0)/l.length),g=l.map(t=>(t-u)/Math.max(m,1)),p=this.layers.map(t=>({w:t.w.map(t=>new Float32Array(t.length)),b:new Float32Array(t.b.length)})),y={w:this.actorHead.w.map(t=>new Float32Array(t.length)),b:new Float32Array(this.actorHead.b.length)},v={w:this.criticHead.w.map(t=>new Float32Array(t.length)),b:new Float32Array(this.criticHead.b.length)};for(let E=0;E<t.length;E++){const{state:e,action:n}=t[E],a=g[E],r=o[E],{policy:l,value:c}=this.forward(e),u=l[n],m=Math.log(u+1e-10);let w=0;for(const t of l)t>0&&(w-=t*Math.log(t));h+=-m*a-i*w;d+=s*(c-r)**2;const f=new Float32Array(l);f[n]-=1;for(let t=0;t<this.outputSize;t++)f[t]*=a,f[t]+=i*(Math.log(l[t]+1e-10)+1);const x=new Float32Array(1);x[0]=2*s*(c-r),this.backprop(e,f,x,p,y,v)}const w=t.length,f=[...p,y,v];for(const E of f){for(let t=0;t<E.w.length;t++)for(let e=0;e<E.w[t].length;e++)E.w[t][e]/=w;for(let t=0;t<E.b.length;t++)E.b[t]/=w}const x=this.getGradientNorm(f),b=Math.min(1,n/(x+1e-10));b<1&&this.scaleGradients(f,b);for(let E=0;E<this.layers.length;E++)this.optimizers.layers[E].w.update(this.layers[E].w,p[E].w),this.optimizers.layers[E].b.update(this.layers[E].b,p[E].b);return this.optimizers.actor.w.update(this.actorHead.w,y.w),this.optimizers.actor.b.update(this.actorHead.b,y.b),this.optimizers.critic.w.update(this.criticHead.w,v.w),this.optimizers.critic.b.update(this.criticHead.b,v.b),{avgAdvantage:l.reduce((t,e)=>t+e,0)/l.length,avgReturn:o.reduce((t,e)=>t+e,0)/o.length,gradNorm:x,actorLoss:h/w,criticLoss:d/w}}getGradientNorm(t){let e=0;for(const i of t){for(let t=0;t<i.w.length;t++)for(let s=0;s<i.w[t].length;s++)e+=i.w[t][s]*i.w[t][s];for(let t=0;t<i.b.length;t++)e+=i.b[t]*i.b[t]}return Math.sqrt(e)}scaleGradients(t,e){for(const i of t){for(let t=0;t<i.w.length;t++)for(let s=0;s<i.w[t].length;s++)i.w[t][s]*=e;for(let t=0;t<i.b.length;t++)i.b[t]*=e}}backprop(t,e,i,s,n,a){const o=this.lastHidden[this.lastHidden.length-1];for(let l=0;l<o.length;l++)for(let t=0;t<this.outputSize;t++)n.w[l][t]+=o[l]*e[t];for(let l=0;l<this.outputSize;l++)n.b[l]+=e[l];for(let l=0;l<o.length;l++)a.w[l][0]+=o[l]*i[0];a.b[0]+=i[0];let r=new Float32Array(o.length);for(let l=0;l<o.length;l++){for(let t=0;t<this.outputSize;t++)r[l]+=e[t]*this.actorHead.w[l][t];r[l]+=i[0]*this.criticHead.w[l][0]}for(let l=this.layers.length-1;l>=0;l--){const t=this.layers[l],e=this.lastHidden[l],i=this.lastPreActivation[l],n=l>0?this.lastHidden[l-1]:this.lastInput;for(let s=0;s<r.length;s++)r[s]*=this.activate(i[s],!0);for(let a=0;a<n.length;a++)for(let t=0;t<e.length;t++)s[l].w[a][t]+=n[a]*r[t];for(let a=0;a<e.length;a++)s[l].b[a]+=r[a];if(l>0){const i=new Float32Array(n.length);for(let s=0;s<n.length;s++)for(let n=0;n<e.length;n++)i[s]+=r[n]*t.w[s][n];r=i}}}get w1(){var t;return(null==(t=this.layers[0])?void 0:t.w)||[]}get w2(){return this.layers.length>1?this.layers[1].w:this.actorHead.w}get hiddenSize(){return this.hiddenSizes[0]}setLearningRate(t){for(const e of this.optimizers.layers)e.w.learningRate=t,e.b.learningRate=t;this.optimizers.actor.w.learningRate=t,this.optimizers.actor.b.learningRate=t,this.optimizers.critic.w.learningRate=t,this.optimizers.critic.b.learningRate=t}getInputImportance(t){const{policy:e,value:i}=this.forward(t),s=new Float32Array(t.length);if(this.layers[0]){const e=this.layers[0].w;for(let i=0;i<t.length;i++){let n=0;for(let t=0;t<e[i].length;t++)n+=Math.abs(e[i][t]);s[i]=Math.abs(t[i])*n}}return s}}class P{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.offscreenCanvas.width=t.width,this.offscreenCanvas.height=t.height}render(t){const g=this.offscreenCtx,p=this.offscreenCanvas.width,y=this.offscreenCanvas.height;g.fillStyle="rgba(227, 242, 253, 0.5)",g.fillRect(0,0,p,y),g.fillStyle="#8d6e63",g.fillRect(0,y*l,p,y*(1-l)),g.strokeStyle="#555",g.lineWidth=2,g.beginPath(),g.moveTo(0,y*h),g.lineTo(p,y*h),g.stroke();const v=p/6,w=p/2-t.xThreshold*v,f=p/2+t.xThreshold*v;g.strokeStyle="#f44336",g.lineWidth=3,g.setLineDash([5,5]),g.beginPath(),g.moveTo(w,.5*y),g.lineTo(w,y*d),g.stroke(),g.beginPath(),g.moveTo(f,.5*y),g.lineTo(f,y*d),g.stroke(),g.setLineDash([]);const x=p/2+t.x*v,b=y*d,E=e,I=i;g.fillStyle="#1976d2",g.fillRect(x-E/2,b-I,E,I),g.fillStyle="#333",g.beginPath(),g.arc(x-E/3,b,s,0,2*Math.PI),g.fill(),g.beginPath(),g.arc(x+E/3,b,s,0,2*Math.PI),g.fill();const M=2*t.length*v,k=x+M*Math.sin(t.theta),B=b-I-M*Math.cos(t.theta),A=Math.abs(t.theta)/t.thetaThreshold;let T="#4caf50";if(A>c?T="#f44336":A>u&&(T="#ff9800"),g.strokeStyle=T,g.lineWidth=6,g.lineCap="round",g.beginPath(),g.moveTo(x,b-I),g.lineTo(k,B),g.stroke(),g.fillStyle=T,g.beginPath(),g.arc(k,B,n,0,2*Math.PI),g.fill(),g.strokeStyle=T,g.lineWidth=2,g.globalAlpha=.5,g.beginPath(),g.arc(x,b-I,a,-Math.PI/2,-Math.PI/2+t.theta,t.theta>0),g.stroke(),g.globalAlpha=1,Math.abs(t.xDot)>.1){g.strokeStyle="#2196f3",g.lineWidth=4,g.beginPath(),g.moveTo(x,b-I/2);const e=o;g.lineTo(x+t.xDot*e,b-I/2),g.stroke();const i=t.xDot>0?0:Math.PI;g.beginPath(),g.moveTo(x+t.xDot*e,b-I/2),g.lineTo(x+t.xDot*e-Math.cos(i-Math.PI/6)*r,b-I/2-Math.sin(i-Math.PI/6)*r),g.lineTo(x+t.xDot*e-Math.cos(i+Math.PI/6)*r,b-I/2-Math.sin(i+Math.PI/6)*r),g.closePath(),g.fillStyle="#2196f3",g.fill()}g.fillStyle="#333",g.font="bold 14px monospace",g.fillText(`Î¸: ${(180*t.theta/Math.PI).toFixed(1)}Â°`,10,20),g.fillText(`x: ${t.x.toFixed(2)}`,10,40),(Math.abs(t.x)>t.xThreshold*m||Math.abs(t.theta)>t.thetaThreshold*m)&&(g.fillStyle="#f44336",g.font="bold 16px sans-serif",g.fillText("âš ï¸ CRITICAL",p-120,30)),this.ctx.drawImage(this.offscreenCanvas,0,0)}}class F{constructor(t){this.svg=document.getElementById(t),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.svg.getBoundingClientRect();this.width=t.width,this.height=t.height}visualize(t){this.svg.innerHTML="";const e=[{size:t.inputSize,label:"Input",type:"input"}];for(let a=0;a<t.hiddenSizes.length;a++)e.push({size:t.hiddenSizes[a],label:`Hidden ${a+1}`,type:"hidden",layerIdx:a});e.push({size:t.outputSize,label:"Actor",type:"actor"}),e.push({size:1,label:"Critic",type:"critic"});const i=this.width/(e.length+1),s=e.map((t,s)=>{const n=i*(s+1),a=Math.max(...e.map(t=>t.size)),o=Math.min(25,this.height/(a+1)),r=(this.height-(t.size-1)*o)/2;return Array.from({length:t.size},(t,e)=>({x:n,y:r+e*o}))}),n=document.createElementNS("http://www.w3.org/2000/svg","g");for(let a=0;a<e.length-1;a++){const i=e[a],o=e[a+1];let r=null;if("input"===i.type&&"hidden"===o.type?r=t.layers[0].w:"hidden"===i.type&&"hidden"===o.type?r=t.layers[o.layerIdx].w:"hidden"===i.type&&"actor"===o.type?r=t.actorHead.w:"hidden"===i.type&&"critic"===o.type&&(r=t.criticHead.w),r)for(let t=0;t<i.size;t++)for(let e=0;e<o.size;e++){const i=r[t][e],l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",s[a][t].x),l.setAttribute("y1",s[a][t].y),l.setAttribute("x2",s[a+1][e].x),l.setAttribute("y2",s[a+1][e].y);const h=Math.min(1,2*Math.abs(i));let d=i>0?"#4caf50":"#f44336";"critic"===o.type&&(d=i>0?"#2196f3":"#ff9800"),l.setAttribute("stroke",d),l.setAttribute("stroke-opacity",.3*h),l.setAttribute("stroke-width","1"),n.appendChild(l)}}this.svg.appendChild(n),e.forEach((e,n)=>{s[n].forEach((i,s)=>{const n=document.createElementNS("http://www.w3.org/2000/svg","circle");n.setAttribute("cx",i.x),n.setAttribute("cy",i.y),n.setAttribute("r",7);let a=0;"input"===e.type&&t.lastInput?a=t.lastInput[s]:"hidden"===e.type&&t.lastHidden[e.layerIdx]?a=t.lastHidden[e.layerIdx][s]:"actor"===e.type&&t.lastOutput?a=t.lastOutput[s]:"critic"===e.type&&(a=t.lastValue/100);const o=Math.min(1,Math.abs(a));let r="#667eea";"critic"===e.type?r="#2196f3":"actor"===e.type&&(r="#4caf50"),n.setAttribute("fill",r),n.setAttribute("fill-opacity",.3+.7*o),n.setAttribute("stroke","#333"),n.setAttribute("stroke-width","2"),this.svg.appendChild(n)});const a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",i*(n+1)),a.setAttribute("y",this.height-10),a.setAttribute("text-anchor","middle"),a.setAttribute("font-size","11"),a.setAttribute("font-weight","bold"),"actor"===e.type?a.setAttribute("fill","#4caf50"):"critic"===e.type?a.setAttribute("fill","#2196f3"):a.setAttribute("fill","#666"),a.textContent=e.label,this.svg.appendChild(a)})}}class H{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.data=[],this.maxDataPoints=100,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}addDataPoint(t,e){this.data.push({episode:t,reward:e}),this.data.length>this.maxDataPoints&&this.data.shift(),this.render()}clear(){this.data=[],this.render()}render(){const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=40;if(t.fillStyle="white",t.fillRect(0,0,e,i),0===this.data.length)return t.fillStyle="#999",t.font="14px sans-serif",t.textAlign="center",void t.fillText("Training data will appear here...",e/2,i/2);const n=this.data.map(t=>t.reward),a=Math.min(...n),o=Math.max(...n),r=o-a||1;t.strokeStyle="#e0e0e0",t.lineWidth=1;for(let l=0;l<=5;l++){const n=s+(i-80)*l/5;t.beginPath(),t.moveTo(s,n),t.lineTo(e-s,n),t.stroke();const a=o-r*l/5;t.fillStyle="#666",t.font="11px sans-serif",t.textAlign="right",t.fillText(a.toFixed(0),35,n+4)}if(t.strokeStyle="#667eea",t.lineWidth=2,t.beginPath(),this.data.forEach((n,o)=>{const l=s+(e-80)*o/(this.data.length-1||1),h=s+(i-80)*(1-(n.reward-a)/r);0===o?t.moveTo(l,h):t.lineTo(l,h)}),t.stroke(),t.fillStyle="#667eea",this.data.forEach((n,o)=>{const l=s+(e-80)*o/(this.data.length-1||1),h=s+(i-80)*(1-(n.reward-a)/r);t.beginPath(),t.arc(l,h,3,0,2*Math.PI),t.fill()}),this.data.length>=10){t.strokeStyle="#ff9800",t.lineWidth=2,t.setLineDash([5,5]),t.beginPath();for(let n=9;n<this.data.length;n++){const o=this.data.slice(n-9,n+1).reduce((t,e)=>t+e.reward,0)/10,l=s+(e-80)*n/(this.data.length-1),h=s+(i-80)*(1-(o-a)/r);9===n?t.moveTo(l,h):t.lineTo(l,h)}t.stroke(),t.setLineDash([])}t.fillStyle="#333",t.font="12px sans-serif",t.textAlign="center",t.fillText("Episode",e/2,i-5),t.save(),t.translate(15,i/2),t.rotate(-Math.PI/2),t.fillText("Survival Time",0,0),t.restore(),t.textAlign="left",t.fillStyle="#667eea",t.fillRect(e-150,10,15,3),t.fillStyle="#666",t.fillText("Episode Reward",e-130,15),t.fillStyle="#ff9800",t.fillRect(e-150,25,15,3),t.fillStyle="#666",t.fillText("10-Ep Average",e-130,30)}}class N{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.actorLosses=[],this.criticLosses=[],this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}addDataPoint(t,e){this.actorLosses.push(t),this.criticLosses.push(e),this.actorLosses.length>200&&(this.actorLosses.shift(),this.criticLosses.shift()),this.draw()}draw(){const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=40;if(t.fillStyle="white",t.fillRect(0,0,e,i),0===this.actorLosses.length)return;const n=Math.max(...this.actorLosses,.1),a=Math.max(...this.criticLosses,.1),o=Math.max(n,a);t.strokeStyle="#999",t.lineWidth=1,t.beginPath(),t.moveTo(s,i-s),t.lineTo(e-s,i-s),t.stroke(),t.beginPath(),t.moveTo(s,s),t.lineTo(s,i-s),t.stroke(),t.strokeStyle="#667eea",t.lineWidth=2,t.beginPath();for(let r=0;r<this.actorLosses.length;r++){const n=s+r/(this.actorLosses.length-1||1)*(e-80),a=i-s-this.actorLosses[r]/o*(i-80);0===r?t.moveTo(n,a):t.lineTo(n,a)}t.stroke(),t.strokeStyle="#ff9800",t.lineWidth=2,t.beginPath();for(let r=0;r<this.criticLosses.length;r++){const n=s+r/(this.criticLosses.length-1||1)*(e-80),a=i-s-this.criticLosses[r]/o*(i-80);0===r?t.moveTo(n,a):t.lineTo(n,a)}t.stroke(),t.fillStyle="#333",t.font="12px sans-serif",t.fillText("0",20,i-s+5),t.fillText(o.toFixed(2),5,45),t.fillStyle="#667eea",t.fillRect(e-180,10,12,12),t.fillStyle="#333",t.fillText("Actor Loss",e-160,20),t.fillStyle="#ff9800",t.fillRect(e-180,30,12,12),t.fillStyle="#333",t.fillText("Critic Loss",e-160,40)}clear(){this.actorLosses=[],this.criticLosses=[],this.draw()}}class D{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.heatmapData=null,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}computeHeatmap(t,e){this.heatmapData=[];const i=-e.xThreshold,s=e.xThreshold,n=-e.thetaThreshold,a=e.thetaThreshold;for(let o=0;o<30;o++){this.heatmapData[o]=[];for(let e=0;e<30;e++){const r=[i+o/30*(s-i),0,n+e/30*(a-n),0],l=[r[0]/E,r[1]/I,r[2]/M,r[3]/k],{value:h}=t.forward(l);this.heatmapData[o][e]=Math.max(0,Math.min(1,(h+50)/100))}}this.draw()}draw(){if(!this.heatmapData){const t=this.ctx;return t.fillStyle="#ccc",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.fillStyle="#999",t.font="14px sans-serif",t.textAlign="center",void t.fillText("Train network to see state space values",this.canvas.width/2,this.canvas.height/2)}const t=this.ctx,e=this.canvas.width,i=this.canvas.height,s=this.heatmapData.length,n=(e-30)/s,a=(i-30)/s;for(let o=0;o<s;o++)for(let e=0;e<s;e++){const i=this.heatmapData[o][e];let s;if(i<.5){s=`rgb(0, ${Math.floor(2*i*255)}, 255)`}else{s=`rgb(${255}, ${255}, ${Math.floor(2*(1-i)*255)})`}t.fillStyle=s,t.fillRect(30+o*n,e*a,n,a)}t.fillStyle="#333",t.font="11px sans-serif",t.textAlign="center",t.fillText("Position",30+(e-30)/2,i-8),t.save(),t.textAlign="center",t.translate(12,i/2),t.rotate(-Math.PI/2),t.fillText("Angle",0,0),t.restore()}clear(){this.heatmapData=null,this.draw()}}class R{constructor(){this.metrics={gradNorm:0,avgAdvantage:0,avgReturn:0,avgQValue:0,entropy:0,leftAction:0,rightAction:0}}update(t){Object.assign(this.metrics,t)}render(){document.getElementById("metric-grad-norm")&&(document.getElementById("metric-grad-norm").textContent=this.metrics.gradNorm.toFixed(3)),document.getElementById("metric-advantage")&&(document.getElementById("metric-advantage").textContent=this.metrics.avgAdvantage.toFixed(3)),document.getElementById("metric-return")&&(document.getElementById("metric-return").textContent=this.metrics.avgReturn.toFixed(1)),document.getElementById("metric-qvalue")&&(document.getElementById("metric-qvalue").textContent=this.metrics.avgQValue.toFixed(2)),document.getElementById("metric-entropy")&&(document.getElementById("metric-entropy").textContent=this.metrics.entropy.toFixed(3)),document.getElementById("metric-left-action")&&(document.getElementById("metric-left-action").textContent=(100*this.metrics.leftAction).toFixed(0)+"%"),document.getElementById("metric-right-action")&&(document.getElementById("metric-right-action").textContent=(100*this.metrics.rightAction).toFixed(0)+"%")}}const $=new class{constructor(){this.env=new S,this.network=null,this.renderer=new P("cartpole-canvas"),this.visualizer=new F("network-svg"),this.chart=new H("training-chart"),this.lossChart=new N("training-loss-chart"),this.metricsDashboard=new R,this.heatmap=new D("state-space-heatmap"),this.isTraining=!1,this.isTesting=!1,this.isManual=!1,this.isPaused=!1,this.episode=0,this.survivalHistory=[],this.explorationHistory=[],this.currentTrajectory=[],this.manualAction=null,this.trainingSpeed=v,this.exploration=g,this.explorationDecay=p,this.minExploration=y,this.gaeLambda=w,this.frameCounter=0,this.lastGradNorm=0,this.lastAvgAdvantage=0,this.lastAvgReturn=0,this.lastActorLoss=0,this.lastCriticLoss=0,this.initNetwork(),this.setupControls(),this.setupKeyboard(),this.setupGlobalKeyboardShortcuts(),this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay(),this.updateNetworkStats(),this.animate(),T("CartPole RL Sandbox initialized"),T("Using Actor-Critic with GAE (Î»=0.95) and Adam optimizer"),T("Network sees 4 inputs: position, velocity, angle, angular velocity"),T("Pole angle & angular velocity are MOST IMPORTANT for balancing!"),T("Watch Input Importance bars to see what the network focuses on"),T("Better exploration: Îµ starts at 0.20, decays slowly to 0.05"),T("Gradient norm and advantage metrics show training health")}normalizeState(t){return[t[0]/E,t[1]/I,t[2]/M,t[3]/k]}initNetwork(){const t=parseInt(document.getElementById("hidden-size").value),e=parseInt(document.getElementById("network-depth").value),i=document.getElementById("activation").value,s=Array(e).fill(t);this.network=new z(4,s,2,i),this.visualizer.visualize(this.network),T(`Network created: 4 â†’ ${s.join(" â†’ ")} â†’ 2 (Actor) + 1 (Critic)`),T(`Activation: ${i.toUpperCase()}, Optimizer: Adam`)}setupControls(){document.getElementById("train-btn").addEventListener("click",()=>this.toggleTraining()),document.getElementById("pause-btn").addEventListener("click",()=>this.togglePause()),document.getElementById("test-btn").addEventListener("click",()=>this.testPolicy()),document.getElementById("reset-btn").addEventListener("click",()=>this.resetPolicy()),document.getElementById("manual-btn").addEventListener("click",()=>this.toggleManual()),document.getElementById("save-network-btn").addEventListener("click",()=>this.saveNetwork()),document.getElementById("load-network-btn").addEventListener("click",()=>this.loadNetwork()),document.getElementById("export-data-btn").addEventListener("click",()=>this.exportTrainingData()),document.getElementById("preset-quick").addEventListener("click",()=>this.applyPreset("quick")),document.getElementById("preset-deep").addEventListener("click",()=>this.applyPreset("deep")),document.getElementById("preset-exploration").addEventListener("click",()=>this.applyPreset("exploration")),document.getElementById("preset-production").addEventListener("click",()=>this.applyPreset("production")),document.getElementById("hidden-size").addEventListener("change",()=>{this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("network-depth").addEventListener("change",()=>{this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("activation").addEventListener("change",()=>{this.isTraining||this.isManual||this.initNetwork()}),document.getElementById("learning-rate").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<1e-4||e>.01)return L.error("Learning rate must be between 0.0001 and 0.01"),void(t.target.value="0.003");this.network.setLearningRate(e),T(`Learning rate updated to ${e}`)}),document.getElementById("discount").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<.9||e>1)return L.error("Discount factor must be between 0.9 and 1.0"),void(t.target.value="0.99")}),document.getElementById("hidden-size").addEventListener("change",t=>{const e=parseInt(t.target.value);if(e<16||e>256||e%8!=0)return L.error("Hidden layer size must be between 16 and 256 (multiples of 8)"),void(t.target.value="32")}),document.getElementById("entropy-coef").addEventListener("change",t=>{const e=parseFloat(t.target.value);if(e<0||e>.1)return L.error("Entropy coefficient must be between 0 and 0.1"),void(t.target.value="0.02")}),document.getElementById("gae-lambda").addEventListener("input",t=>{this.gaeLambda=parseFloat(t.target.value),document.getElementById("gae-lambda-value").textContent=this.gaeLambda.toFixed(2)});document.getElementById("training-speed").addEventListener("input",t=>{this.trainingSpeed=parseInt(t.target.value),document.getElementById("speed-value").textContent=`${this.trainingSpeed}x`})}setupKeyboard(){document.addEventListener("keydown",t=>{this.isManual&&("ArrowLeft"===t.key||"a"===t.key||"A"===t.key?(this.manualAction=0,t.preventDefault()):"ArrowRight"!==t.key&&"d"!==t.key&&"D"!==t.key||(this.manualAction=1,t.preventDefault()))});const t=document.getElementById("touch-left"),e=document.getElementById("touch-right");t&&(t.addEventListener("touchstart",()=>{this.isManual&&(this.manualAction=0)}),t.addEventListener("touchend",()=>{this.isManual&&(this.manualAction=null)}),t.addEventListener("mousedown",()=>{this.isManual&&(this.manualAction=0)}),t.addEventListener("mouseup",()=>{this.isManual&&(this.manualAction=null)})),e&&(e.addEventListener("touchstart",()=>{this.isManual&&(this.manualAction=1)}),e.addEventListener("touchend",()=>{this.isManual&&(this.manualAction=null)}),e.addEventListener("mousedown",()=>{this.isManual&&(this.manualAction=1)}),e.addEventListener("mouseup",()=>{this.isManual&&(this.manualAction=null)}))}setMode(t){const e=document.getElementById("mode-indicator");e.textContent=t,e.className="mode-indicator "+({IDLE:"",TRAINING:"mode-training",TESTING:"mode-testing",MANUAL:"mode-manual"}[t]||"")}toggleManual(){if(this.isTraining||this.isTesting)return;this.isManual=!this.isManual;const t=document.getElementById("manual-btn"),e=document.getElementById("keyboard-hint"),i=document.getElementById("touch-controls");this.isManual?(t.textContent="Stop Manual",t.className="secondary",e.style.display="block",i.style.display="flex",this.setMode("MANUAL"),this.env.reset(),T("Manual control enabled - use arrow keys, A/D, or touch buttons"),this.manualLoop()):(t.textContent="Manual Control",t.className="secondary",e.style.display="none",i.style.display="none",this.setMode("IDLE"),T("Manual control disabled"))}async manualLoop(){for(;this.isManual;){if(null!==this.manualAction){const t=this.env.step(this.manualAction),e=this.env.getState();this.network.forward(this.normalizeState(e)),t.done&&(T(`Episode ended: survived ${this.env.steps} steps`),await new Promise(t=>setTimeout(t,1e3)),this.env.reset()),this.manualAction=null}this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay(),this.visualizer.visualize(this.network),await new Promise(t=>setTimeout(t,20))}}toggleTraining(){this.isManual&&this.toggleManual(),this.isTraining=!this.isTraining;const t=document.getElementById("train-btn"),e=document.getElementById("pause-btn");this.isTraining?(t.textContent="Stop Training",t.className="danger",e.style.display="block",e.textContent="Pause",this.isPaused=!1,this.setMode("TRAINING"),T("Training started"),this.trainingLoop()):(t.textContent="Start Training",t.className="primary",e.style.display="none",this.isPaused=!1,this.setMode("IDLE"),T("Training stopped"))}togglePause(){this.isPaused=!this.isPaused;const t=document.getElementById("pause-btn");this.isPaused?(t.textContent="Resume",T("Training paused - inspect metrics without losing progress")):(t.textContent="Pause",T("Training resumed"))}async trainingLoop(){for(;this.isTraining;){if(this.isPaused){await new Promise(t=>setTimeout(t,100));continue}await this.runEpisode(!0);const t=Math.max(1,50-5*this.trainingSpeed);await new Promise(e=>setTimeout(e,t))}}async runEpisode(t=!1){const e=this.env.reset();this.currentTrajectory=[];let i=!1;const s=t?Math.max(0,3-.3*this.trainingSpeed):20;for(;!i&&(this.isTraining||this.isTesting);){const n=this.normalizeState(e),a=t?this.network.selectAction(n,this.exploration):this.network.selectAction(n,0),o=this.env.step(a),r=o.done?0:1;this.currentTrajectory.push({state:[...n],action:a,reward:r}),Object.assign(e,o.state),i=o.done,this.updateMetrics(),this.updateActionBars(),this.updateStateDisplay(),this.frameCounter++%f===0&&this.visualizer.visualize(this.network),await new Promise(t=>setTimeout(t,s))}if(t&&this.currentTrajectory.length>0){const t=parseFloat(document.getElementById("discount").value),e=parseFloat(document.getElementById("entropy-coef").value),i=this.network.update(this.currentTrajectory,t,e,.5,1,this.gaeLambda);if(this.lastGradNorm=i.gradNorm,this.lastAvgAdvantage=i.avgAdvantage,this.lastAvgReturn=i.avgReturn,this.lastActorLoss=i.actorLoss,this.lastCriticLoss=i.criticLoss,this.lossChart.addDataPoint(i.actorLoss,i.criticLoss),this.metricsDashboard.update({gradNorm:i.gradNorm,avgAdvantage:i.avgAdvantage,avgReturn:i.avgReturn}),this.metricsDashboard.render(),this.episode%25==0)try{this.heatmap.computeHeatmap(this.network,this.env)}catch(n){}this.exploration=Math.max(this.minExploration,this.exploration*this.explorationDecay)}if(this.episode++,this.survivalHistory.push(this.env.steps),this.explorationHistory.push(this.exploration),this.survivalHistory.length>x&&(this.survivalHistory.shift(),this.explorationHistory.shift()),this.chart.addDataPoint(this.episode,this.env.steps),this.episode%b===0){const t=this.survivalHistory.slice(-10).reduce((t,e)=>t+e,0)/Math.min(B,this.survivalHistory.length),e=this.lastGradNorm?` |âˆ‡|=${this.lastGradNorm.toFixed(2)}`:"";T(`Ep ${this.episode}: Avg=${t.toFixed(1)} steps, Îµ=${this.exploration.toFixed(3)}${e}`)}this.updateNetworkStats()}async testPolicy(){this.isTraining&&this.toggleTraining(),this.isManual&&this.toggleManual(),this.isTesting=!0,this.setMode("TESTING");const t=document.getElementById("test-btn");t.disabled=!0,T("Testing current policy..."),await this.runEpisode(!1),T(`Test complete: survived ${this.env.steps} steps`),this.isTesting=!1,this.setMode("IDLE"),t.disabled=!1,this.updateStateDisplay()}resetPolicy(){this.isTraining=!1,this.isTesting=!1,this.isManual&&this.toggleManual(),document.getElementById("train-btn").textContent="Start Training",document.getElementById("train-btn").className="primary",this.setMode("IDLE"),this.episode=0,this.survivalHistory=[],this.explorationHistory=[],this.exploration=g,this.chart.clear(),this.lossChart.clear(),this.heatmap.clear(),this.initNetwork(),this.env.reset(),this.updateMetrics(),this.updateStateDisplay(),this.updateNetworkStats(),T("Policy reset - exploration reset to 0.2 with GAE enabled")}updateActionBars(){if(this.network.lastOutput){const t=this.network.lastOutput,e=(100*t[0]).toFixed(1);document.getElementById("action-left").style.transform=`scaleY(${t[0]})`,document.getElementById("action-left-val").textContent=e+"%";const i=(100*t[1]).toFixed(1);document.getElementById("action-right").style.transform=`scaleY(${t[1]})`,document.getElementById("action-right-val").textContent=i+"%"}}updateStateDisplay(){const t=this.env.getState(),[e,i,s,n]=t,a=E,o=I,r=M,l=k,h=Math.min(1,Math.abs(e)/a);document.getElementById("perception-x-val").textContent=e.toFixed(2),document.getElementById("perception-x-bar").style.width=100*h+"%",document.getElementById("perception-x").classList.toggle("active",h>.6);const d=Math.min(1,Math.abs(i)/o);document.getElementById("perception-xdot-val").textContent=i.toFixed(2),document.getElementById("perception-xdot-bar").style.width=100*d+"%",document.getElementById("perception-xdot").classList.toggle("active",d>.4);const m=180*s/Math.PI,g=Math.min(1,Math.abs(s)/r);document.getElementById("perception-theta-val").textContent=m.toFixed(1)+"Â°",document.getElementById("perception-theta-bar").style.width=100*g+"%",document.getElementById("perception-theta").classList.add("active");const p=Math.min(1,Math.abs(n)/l);document.getElementById("perception-thetadot-val").textContent=n.toFixed(2),document.getElementById("perception-thetadot-bar").style.width=100*p+"%",document.getElementById("perception-thetadot").classList.add("active");const y=50+s/r*50;document.getElementById("theta-bar").style.width=Math.max(0,Math.min(100,y))+"%",document.getElementById("theta-value").textContent=m.toFixed(1)+"Â°";const v=50+n/l*50;document.getElementById("thetadot-bar").style.width=Math.max(0,Math.min(100,v))+"%",document.getElementById("thetadot-value").textContent=n.toFixed(2),document.getElementById("value-x").textContent=e.toFixed(2);const w=50+e/a*50;document.getElementById("indicator-x").style.width=Math.max(0,Math.min(100,w))+"%",document.getElementById("indicator-x").className="state-indicator"+(h>.6?" danger":""),document.getElementById("value-xdot").textContent=i.toFixed(2);const f=50+i/o*50;document.getElementById("indicator-xdot").style.width=Math.max(0,Math.min(100,f))+"%",document.getElementById("indicator-xdot").className="state-indicator"+(d>.4?" warning":""),document.getElementById("value-theta").textContent=m.toFixed(1);const x=50+s/r*50;document.getElementById("indicator-theta").style.width=Math.max(0,Math.min(100,x))+"%",document.getElementById("indicator-theta").className="state-indicator"+(g>c?" danger":g>u?" warning":""),document.getElementById("value-thetadot").textContent=n.toFixed(2);const b=50+n/l*50;document.getElementById("indicator-thetadot").style.width=Math.max(0,Math.min(100,b))+"%",document.getElementById("indicator-thetadot").className="state-indicator"+(p>.5?" warning":"");const B=this.network.getInputImportance(this.normalizeState(t)),A=Math.max(...B,.001),T=B[0]/A*100,L=B[1]/A*100,S=B[2]/A*100,C=B[3]/A*100;document.getElementById("importance-x-bar").style.width=T+"%",document.getElementById("importance-x-val").textContent=T.toFixed(0)+"%",document.getElementById("importance-xdot-bar").style.width=L+"%",document.getElementById("importance-xdot-val").textContent=L.toFixed(0)+"%",document.getElementById("importance-theta-bar").style.width=S+"%",document.getElementById("importance-theta-val").textContent=S.toFixed(0)+"%",document.getElementById("importance-thetadot-bar").style.width=C+"%",document.getElementById("importance-thetadot-val").textContent=C.toFixed(0)+"%"}updateNetworkStats(){let t=0,e=0;for(const a of this.network.layers)for(let i=0;i<a.w.length;i++)for(let s=0;s<a.w[i].length;s++)t+=Math.abs(a.w[i][s]),e++;const i=e>0?t/e:0,s=this.network.getAvgWeight(this.network.actorHead.w),n=this.network.getEntropy();document.getElementById("avg-w1").textContent=i.toFixed(3),document.getElementById("avg-w2").textContent=s.toFixed(3),document.getElementById("entropy").textContent=n.toFixed(3),document.getElementById("exploration-rate").textContent=this.exploration.toFixed(3),document.getElementById("grad-norm").textContent=this.lastGradNorm?this.lastGradNorm.toFixed(2):"0.00",document.getElementById("avg-advantage").textContent=this.lastAvgAdvantage?this.lastAvgAdvantage.toFixed(2):"0.00"}updateMetrics(){if(document.getElementById("episode-count").textContent=this.episode,document.getElementById("steps-count").textContent=this.env.steps,document.getElementById("reward-count").textContent=this.env.steps,void 0!==this.network.lastValue&&(document.getElementById("value-estimate").textContent=this.network.lastValue.toFixed(1)),this.survivalHistory.length>0){const t=this.survivalHistory[this.survivalHistory.length-1],e=Math.max(...this.survivalHistory),i=this.survivalHistory.slice(-10).reduce((t,e)=>t+e,0)/Math.min(10,this.survivalHistory.length);document.getElementById("last-survival").textContent=t,document.getElementById("best-survival").textContent=e,document.getElementById("avg-survival").textContent=i.toFixed(1)}else document.getElementById("last-survival").textContent="0",document.getElementById("best-survival").textContent="0",document.getElementById("avg-survival").textContent="0"}saveNetwork(){const t={timestamp:(new Date).toISOString(),episode:this.episode,survivalHistory:this.survivalHistory,network:{layers:this.network.layers.map(t=>({w:t.w,b:t.b})),actorHead:{w:this.network.actorHead.w,b:this.network.actorHead.b},criticHead:{w:this.network.criticHead.w,b:this.network.criticHead.b},hiddenSizes:this.network.hiddenSizes,activation:this.network.activation},hyperparameters:{learningRate:parseFloat(document.getElementById("learning-rate").value),discount:parseFloat(document.getElementById("discount").value),entropy:parseFloat(document.getElementById("entropy-coef").value),hiddenSize:parseInt(document.getElementById("hidden-size").value),networkDepth:parseInt(document.getElementById("network-depth").value)}},e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=`cartpole-network-${t.timestamp.substring(0,10)}.json`,n.click(),URL.revokeObjectURL(s),L.success(`Network saved! Trained for ${this.episode} episodes`),T(`Saved network with ${this.episode} episodes of training`)}loadNetwork(){const t=document.createElement("input");t.type="file",t.accept="application/json",t.onchange=t=>{const e=t.target.files[0];if(!e)return;const i=new FileReader;i.onload=t=>{try{const e=JSON.parse(t.target.result);if(e.hyperparameters&&(document.getElementById("learning-rate").value=e.hyperparameters.learningRate,document.getElementById("discount").value=e.hyperparameters.discount,document.getElementById("entropy-coef").value=e.hyperparameters.entropy,document.getElementById("hidden-size").value=e.hyperparameters.hiddenSize,document.getElementById("network-depth").value=e.hyperparameters.networkDepth),this.initNetwork(),e.network&&e.network.activation&&(this.network.activation=e.network.activation,document.getElementById("activation").value=e.network.activation),e.network&&e.network.layers){for(let t=0;t<e.network.layers.length;t++)this.network.layers[t].w=e.network.layers[t].w,this.network.layers[t].b=e.network.layers[t].b;this.network.actorHead.w=e.network.actorHead.w,this.network.actorHead.b=e.network.actorHead.b,this.network.criticHead.w=e.network.criticHead.w,this.network.criticHead.b=e.network.criticHead.b}this.visualizer.visualize(this.network),L.success(`Network loaded! ${e.episode} episodes of training restored`),T(`Loaded network trained for ${e.episode} episodes`)}catch(e){L.error("Failed to load network: "+e.message),T("Error loading network: "+e.message)}},i.readAsText(e)},t.click()}exportTrainingData(){let t="Episode,Survival_Steps,Actor_Loss,Critic_Loss,Exploration_Rate\n";for(let n=0;n<this.survivalHistory.length;n++)t+=`${n+1},${this.survivalHistory[n]},${this.lossChart.actorLosses[n]||0},${this.lossChart.criticLosses[n]||0},${this.explorationHistory[n]||0}\n`;const e=new Blob([t],{type:"text/csv"}),i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download=`cartpole-training-${(new Date).toISOString().substring(0,10)}.csv`,s.click(),URL.revokeObjectURL(i),L.success(`Training data exported (${this.episode} episodes)`),T(`Exported training data: ${this.episode} episodes`)}applyPreset(t){const e={quick:{lr:.005,discount:.99,entropy:.02,hidden:32,depth:1,speed:8},deep:{lr:.003,discount:.99,entropy:.015,hidden:64,depth:2,speed:1},exploration:{lr:.002,discount:.95,entropy:.05,hidden:32,depth:1,speed:3},production:{lr:.001,discount:.99,entropy:.01,hidden:128,depth:2,speed:1}}[t];if(!e)return void L.error("Unknown preset: "+t);document.getElementById("learning-rate").value=e.lr,document.getElementById("discount").value=e.discount,document.getElementById("entropy-coef").value=e.entropy,document.getElementById("hidden-size").value=e.hidden,document.getElementById("network-depth").value=e.depth,this.trainingSpeed=e.speed,document.getElementById("training-speed").value=e.speed,this.initNetwork(),this.heatmap.clear(),this.lossChart.clear();L.success(`Preset loaded: ${{quick:"âš¡ Quick Train",deep:"ðŸ§  Deep Learn",exploration:"ðŸ” Exploration",production:"ðŸ­ Production"}[t]}`),T(`Applied ${t} preset`)}setupGlobalKeyboardShortcuts(){document.addEventListener("keydown",t=>{if("INPUT"!==document.activeElement.tagName)switch(t.key){case" ":t.preventDefault(),this.toggleTraining();break;case"t":case"T":this.isTraining||this.isManual||this.testPolicy();break;case"r":case"R":this.resetPolicy();break;case"s":case"S":this.isTraining||this.isTesting||this.isManual||this.saveNetwork();break;case"l":case"L":this.isTraining||this.isTesting||this.isManual||this.loadNetwork();break;case"m":case"M":this.isTraining||this.isTesting||this.toggleManual();break;case"p":case"P":this.isTraining&&this.togglePause()}},{passive:!1})}animate(){this.renderer.render(this.env),this.updateStateDisplay(),requestAnimationFrame(()=>this.animate())}};window.sandbox=$,T("CartPole RL Sandbox initialized successfully");
